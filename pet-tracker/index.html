<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Tracker</title>
    <meta name="description" content="Offline-first pet health tracker with Notion backend">
    <meta name="theme-color" content="#2d2926">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pet Tracker">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.561.0/dist/umd/lucide.min.js"></script>

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Fonts: Playfair Display (serif), Inter (sans), JetBrains Mono (mono) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'oatmeal': '#d4c8b8',
                        'earth-metal': '#6b6357',
                        'charcoal': '#2d2926',
                        'white-linen': '#f8f6f3',
                        'dull-purple': '#8b7b8e',
                        'muted-pink': '#c9a9a6'
                    },
                    fontFamily: {
                        'serif': ['"Playfair Display"', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                        'mono': ['"JetBrains Mono"', 'monospace']
                    },
                    borderRadius: {
                        'none': '0',
                        'sm': '2px',
                        'DEFAULT': '2px'
                    }
                }
            }
        }
    </script>

    <!-- Custom Styles -->
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body
    class="bg-white-linen text-charcoal font-sans min-h-screen flex flex-col md:flex-row overflow-hidden selection:bg-dull-purple selection:text-white-linen">

    <!-- Skip Link -->
    <a href="#mainContent"
        class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-[110] focus:bg-charcoal focus:text-white-linen focus:px-4 focus:py-2 focus:font-mono focus:text-xs focus:uppercase">
        Skip to main content
    </a>

    <!-- Toast Container -->
    <div id="toastContainer" role="status" aria-live="polite" aria-atomic="true"
        class="fixed top-4 right-4 z-[100] flex flex-col gap-2 w-full max-w-xs pointer-events-none"></div>

    <!-- Sidebar (Desktop) -->
    <aside class="hidden md:flex md:w-64 h-screen flex-col border-r border-oatmeal bg-white-linen flex-shrink-0">
        <!-- Logo -->
        <div class="h-16 px-4 border-b border-oatmeal flex items-center gap-3">
            <div class="w-9 h-9 bg-charcoal flex items-center justify-center">
                <i data-lucide="heart-pulse" class="w-5 h-5 text-white-linen"></i>
            </div>
            <div>
                <h1 class="font-serif text-lg text-charcoal leading-tight">Pet Tracker</h1>
                <span class="font-mono text-[9px] uppercase tracking-widest text-earth-metal">with Notion</span>
            </div>
        </div>

        <!-- Pet Filter -->
        <div class="p-3 border-b border-oatmeal">
            <select id="petFilterDesktop" class="select-field text-sm" onchange="App.filterByPet(this.value)">
                <option value="">All Pets</option>
            </select>
        </div>

        <!-- Navigation -->
        <nav role="navigation" aria-label="Main navigation" class="flex-1 p-3 space-y-1 overflow-y-auto">
            <button data-nav="dashboard" aria-current="page"
                class="w-full flex items-center gap-3 px-3 py-2 text-left text-dull-purple hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="layout-dashboard" class="w-5 h-5" aria-hidden="true"></i>
                <span class="font-mono text-xs uppercase">Dashboard</span>
            </button>
            <button data-nav="calendar"
                class="w-full flex items-center gap-3 px-3 py-2 text-left text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="calendar" class="w-5 h-5" aria-hidden="true"></i>
                <span class="font-mono text-xs uppercase">Calendar</span>
            </button>
            <button data-nav="upcoming"
                class="w-full flex items-center gap-3 px-3 py-2 text-left text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="clock" class="w-5 h-5" aria-hidden="true"></i>
                <span class="font-mono text-xs uppercase">Upcoming</span>
            </button>
            <button data-nav="analytics"
                class="w-full flex items-center gap-3 px-3 py-2 text-left text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="bar-chart-3" class="w-5 h-5" aria-hidden="true"></i>
                <span class="font-mono text-xs uppercase">Analytics</span>
            </button>
            <button data-nav="pets"
                class="w-full flex items-center gap-3 px-3 py-2 text-left text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="paw-print" class="w-5 h-5" aria-hidden="true"></i>
                <span class="font-mono text-xs uppercase">Pets</span>
            </button>
            <button data-nav="contacts"
                class="w-full flex items-center gap-3 px-3 py-2 text-left text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="users" class="w-5 h-5" aria-hidden="true"></i>
                <span class="font-mono text-xs uppercase">Contacts</span>
            </button>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-3 border-t border-oatmeal space-y-1">
            <button onclick="App.openAddModal()"
                class="w-full flex items-center gap-3 px-3 py-2 text-dull-purple hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span class="font-mono text-xs uppercase">Add Event</span>
            </button>
            <button onclick="AI.openModal()"
                class="w-full flex items-center gap-3 px-3 py-2 text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="sparkles" class="w-5 h-5"></i>
                <span class="font-mono text-xs uppercase">AI Quick Add</span>
            </button>
            <button id="installPwaBtn" onclick="App.promptInstall()"
                class="hidden w-full flex items-center gap-3 px-3 py-2 text-dull-purple hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="download" class="w-5 h-5"></i>
                <span class="font-mono text-xs uppercase">Install App</span>
            </button>
            <button onclick="App.openSettings()"
                class="w-full flex items-center gap-3 px-3 py-2 text-earth-metal hover:bg-oatmeal/30 transition-fast">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="font-mono text-xs uppercase">Settings</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-h-0 h-screen">
        <!-- Header -->
        <header
            class="h-14 md:h-16 border-b border-oatmeal flex items-center justify-between px-4 bg-white-linen flex-shrink-0">
            <div class="flex items-center gap-3">
                <!-- Mobile menu toggle -->
                <button class="md:hidden p-2 -ml-2 text-earth-metal" onclick="App.toggleMobileMenu()">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <h2 id="headerTitle" class="font-serif text-xl text-charcoal">Dashboard</h2>
                <span id="syncStatus"
                    class="hidden text-[10px] font-mono uppercase px-2 py-1 bg-oatmeal text-earth-metal flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full bg-earth-metal"></span>
                    <span>Offline</span>
                </span>
            </div>
            <div class="flex items-center gap-2">
                <!-- Sync Status Indicator -->
                <div class="relative">
                    <button id="manualSyncBtn" onclick="PetTracker.Sync?.manualSync()" title="Sync now"
                        class="p-2 text-earth-metal hover:text-dull-purple transition-fast">
                        <span id="syncStatusIndicator">
                            <i data-lucide="cloud" class="w-5 h-5"></i>
                        </span>
                    </button>
                    <span id="syncPendingBadge"
                        class="hidden absolute -top-1 -right-1 bg-muted-pink text-white-linen text-[9px] font-mono min-w-[16px] h-4 flex items-center justify-center px-1">
                        0
                    </span>
                </div>
                <span id="lastSyncTime" class="hidden md:inline text-[10px] font-mono text-earth-metal">
                    Never synced
                </span>
                <!-- Mobile Add Button -->
                <button onclick="App.openAddModal()" class="md:hidden p-2 text-dull-purple">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- View Container -->
        <div class="flex-1 overflow-y-auto">
            <div data-view="dashboard"></div>
            <div data-view="calendar" class="hidden"></div>
            <div data-view="upcoming" class="hidden"></div>
            <div data-view="analytics" class="hidden"></div>
            <div data-view="pets" class="hidden"></div>
            <div data-view="contacts" class="hidden"></div>
        </div>

        <!-- Bottom Nav (Mobile) -->
        <nav
            class="md:hidden h-16 border-t border-oatmeal flex items-center justify-around bg-white-linen flex-shrink-0">
            <button data-nav="dashboard" class="flex flex-col items-center gap-1 p-2 text-dull-purple">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-mono text-[9px] uppercase">Home</span>
            </button>
            <button data-nav="calendar" class="flex flex-col items-center gap-1 p-2 text-earth-metal">
                <i data-lucide="calendar" class="w-5 h-5"></i>
                <span class="font-mono text-[9px] uppercase">Calendar</span>
            </button>
            <button data-nav="upcoming" class="flex flex-col items-center gap-1 p-2 text-earth-metal">
                <i data-lucide="clock" class="w-5 h-5"></i>
                <span class="font-mono text-[9px] uppercase">Upcoming</span>
            </button>
            <button data-nav="pets" class="flex flex-col items-center gap-1 p-2 text-earth-metal">
                <i data-lucide="paw-print" class="w-5 h-5"></i>
                <span class="font-mono text-[9px] uppercase">Pets</span>
            </button>
            <button onclick="App.openSettings()" class="flex flex-col items-center gap-1 p-2 text-earth-metal">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="font-mono text-[9px] uppercase">Settings</span>
            </button>
        </nav>
    </main>

    <!-- ========== MODALS ========== -->

    <!-- Add Event Modal -->
    <div id="addEventModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="addEventModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div class="relative bg-white-linen border border-oatmeal w-full max-w-lg max-h-[90vh] overflow-y-auto z-10">
            <div class="sticky top-0 bg-white-linen border-b border-oatmeal p-4 flex items-center justify-between">
                <span class="section-header">Add Event</span>
                <button onclick="App.confirmCloseAddModal()" class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="addEventForm" class="p-4 space-y-4" onsubmit="event.preventDefault(); App.saveEvent();">
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Pet *</label>
                    <select id="addEventPet" class="select-field" required></select>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Event Type *</label>
                    <select id="addEventType" class="select-field" required></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Date *</label>
                        <input type="date" id="addEventDate" class="input-field" required>
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Time</label>
                        <input type="time" id="addEventTime" class="input-field">
                    </div>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Value</label>
                    <input type="number" id="addEventValue" class="input-field" placeholder="e.g., weight, dose">
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Notes</label>
                    <textarea id="addEventNotes" class="input-field h-24 resize-none"
                        placeholder="Additional notes..."></textarea>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Attachments</label>
                    <div id="attachmentPreviewContainer" class="hidden flex flex-wrap gap-2 mb-3"></div>
                    <div class="border border-dashed border-oatmeal p-4 text-center">
                        <input type="file" id="addEventFiles" class="hidden" multiple accept="image/*,video/*"
                            onchange="App.handleFileInputChange(this)">
                        <button type="button" onclick="document.getElementById('addEventFiles').click()"
                            class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                            <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i>Choose Files
                        </button>
                        <p class="text-xs text-earth-metal mt-2">Or use camera on mobile</p>
                    </div>
                </div>
                <div class="flex gap-3 justify-end pt-4 border-t border-oatmeal">
                    <button type="button" onclick="App.confirmCloseAddModal()"
                        class="btn-secondary px-4 py-2 font-mono text-xs uppercase">Cancel</button>
                    <button type="submit" class="btn-primary px-4 py-2 font-mono text-xs uppercase">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div
            class="relative bg-white-linen border border-oatmeal w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col z-10">
            <div class="border-b border-oatmeal p-4 flex items-center justify-between flex-shrink-0">
                <span class="section-header">Settings</span>
                <button onclick="PetTracker.UI.closeModal('settingsModal')"
                    class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Settings Tabs -->
            <div class="border-b border-oatmeal flex overflow-x-auto flex-shrink-0">
                <button data-tab-group="settings" data-tab="connection" class="tab-nav active">Connection</button>
                <button data-tab-group="settings" data-tab="database" class="tab-nav">Database</button>
                <button data-tab-group="settings" data-tab="ai" class="tab-nav">AI Config</button>
                <button data-tab-group="settings" data-tab="todoist" class="tab-nav">Todoist</button>
                <button data-tab-group="settings" data-tab="gcal" class="tab-nav">Calendar</button>
                <button data-tab-group="settings" data-tab="danger" class="tab-nav">Danger Zone</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <!-- Connection Tab -->
                <div data-tab-panel="settings" data-panel="connection" class="space-y-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Cloudflare Worker URL
                            *</label>
                        <input type="url" id="settingsWorkerUrl" class="input-field"
                            placeholder="https://your-worker.workers.dev">
                        <p class="text-xs text-earth-metal mt-1">Your CORS proxy worker URL</p>
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Proxy Token
                            (optional)</label>
                        <input type="password" id="settingsProxyToken" class="input-field"
                            placeholder="Optional auth token">
                    </div>

                    <!-- Template Link -->
                    <div class="border border-dull-purple/30 p-3 bg-dull-purple/5">
                        <p class="text-sm text-charcoal">
                            <i data-lucide="copy" class="w-4 h-4 inline mr-1"></i>
                            Need the template? Duplicate this <a href="https://mimansajaiswal-embedded-dbs.notion.site/pet-tracker-template" target="_blank" rel="noopener noreferrer" class="underline text-dull-purple font-medium">Notion template</a> to your workspace.
                        </p>
                    </div>

                    <!-- OAuth Section -->
                    <div class="border border-oatmeal p-4 space-y-3">
                        <span class="font-mono text-xs uppercase text-earth-metal">Notion OAuth (Recommended)</span>
                        <button onclick="App.startNotionOAuth()"
                            class="btn-primary w-full px-4 py-2 font-mono text-xs uppercase flex items-center justify-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4"></i>Connect with Notion
                        </button>
                        <p class="text-xs text-earth-metal">Securely connect via Notion's OAuth. Redirects to Notion
                            for authorization.</p>
                    </div>

                    <!-- Divider -->
                    <div class="flex items-center gap-4">
                        <div class="flex-1 border-t border-oatmeal"></div>
                        <span class="font-mono text-xs uppercase text-earth-metal">OR</span>
                        <div class="flex-1 border-t border-oatmeal"></div>
                    </div>

                    <!-- Manual Token Section -->
                    <div class="border border-oatmeal p-4 space-y-3">
                        <span class="font-mono text-xs uppercase text-earth-metal">Manual Token (Internal
                            Integrations)</span>
                        <div>
                            <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Notion Integration
                                Token</label>
                            <input type="password" id="settingsNotionToken" class="input-field"
                                placeholder="secret_...">
                            <p class="text-xs text-earth-metal mt-1">From your Notion integration settings</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button onclick="App.testConnection()"
                            class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                            <i data-lucide="plug" class="w-4 h-4 inline mr-2"></i>Test Connection
                        </button>
                        <button onclick="App.showWorkerCode()"
                            class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                            <i data-lucide="code" class="w-4 h-4 inline mr-2"></i>View Worker Code
                        </button>
                    </div>
                </div>

                <!-- Database Tab -->
                <div data-tab-panel="settings" data-panel="database" class="hidden space-y-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Database ID *</label>
                        <div class="flex gap-2">
                            <input type="text" id="settingsDatabaseId" class="input-field flex-1"
                                placeholder="Notion database ID">
                            <button onclick="App.scanDataSources()"
                                class="btn-secondary px-3 py-2 font-mono text-xs uppercase">
                                <i data-lucide="scan" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-xs text-earth-metal mt-1">Enter database ID and click scan to detect data sources
                        </p>
                    </div>

                    <div id="dataSourceMapping" class="space-y-3 hidden">
                        <span class="font-mono text-xs uppercase text-earth-metal">Data Source Mapping</span>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Pets</label>
                                <select id="dsMapPets" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label
                                    class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Events</label>
                                <select id="dsMapEvents" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Event
                                    Types</label>
                                <select id="dsMapEventTypes" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Care
                                    Items</label>
                                <select id="dsMapCareItems" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Care
                                    Plans</label>
                                <select id="dsMapCarePlans" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label
                                    class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Contacts</label>
                                <select id="dsMapContacts" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label
                                    class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Scales</label>
                                <select id="dsMapScales" class="select-field text-sm"></select>
                            </div>
                            <div>
                                <label class="font-mono text-[10px] uppercase text-earth-metal block mb-1">Scale
                                    Levels</label>
                                <select id="dsMapScaleLevels" class="select-field text-sm"></select>
                            </div>
                        </div>
                    </div>

                    <div id="schemaStatus" class="hidden">
                        <span class="font-mono text-xs uppercase text-earth-metal">Schema Status</span>
                        <div id="schemaStatusList" class="mt-2 space-y-1"></div>
                    </div>
                </div>

                <!-- AI Tab -->
                <div data-tab-panel="settings" data-panel="ai" class="hidden space-y-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">AI Provider</label>
                        <select id="settingsAiProvider" class="select-field" onchange="App.toggleAiEndpoint?.()">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google Gemini</option>
                            <option value="custom">Custom Endpoint</option>
                        </select>
                    </div>
                    <div id="aiEndpointField" class="hidden">
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Custom Endpoint
                            URL</label>
                        <input type="url" id="settingsAiEndpoint" class="input-field"
                            placeholder="https://your-api.com/v1/chat/completions">
                        <p class="text-xs text-earth-metal mt-1">OpenAI-compatible API endpoint</p>
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Model</label>
                        <input type="text" id="settingsAiModel" class="input-field" placeholder="gpt-4o-mini">
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">API Key</label>
                        <input type="password" id="settingsAiApiKey" class="input-field" placeholder="Your API key">
                    </div>
                </div>

                <!-- Todoist Tab -->
                <div data-tab-panel="settings" data-panel="todoist" class="hidden space-y-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="settingsTodoistEnabled" class="w-4 h-4">
                        <label for="settingsTodoistEnabled" class="font-mono text-xs uppercase text-charcoal">Enable
                            Todoist Integration</label>
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Todoist API Token</label>
                        <input type="password" id="settingsTodoistToken" class="input-field"
                            placeholder="Your Todoist token">
                    </div>
                </div>

                <!-- Google Calendar Tab -->
                <div data-tab-panel="settings" data-panel="gcal" class="hidden space-y-4">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="settingsGcalEnabled" class="w-4 h-4">
                        <label for="settingsGcalEnabled" class="font-mono text-xs uppercase text-charcoal">Enable
                            Google Calendar Sync</label>
                    </div>

                    <!-- OAuth Section -->
                    <div class="border border-oatmeal p-4 space-y-3">
                        <span class="font-mono text-xs uppercase text-earth-metal">Google Account</span>
                        <div id="gcalConnectionStatus" class="text-sm text-earth-metal">
                            Not connected
                        </div>
                        <button onclick="App.startGoogleOAuth()"
                            class="btn-primary w-full px-4 py-2 font-mono text-xs uppercase flex items-center justify-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4"></i>Connect with Google
                        </button>
                        <p class="text-xs text-earth-metal">Securely connect via Google OAuth to sync events to your
                            calendar.</p>
                    </div>

                    <!-- Calendar Selection -->
                    <div id="gcalCalendarSelect" class="hidden">
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Target Calendar</label>
                        <select id="settingsGcalCalendarId" class="select-field">
                            <option value="">Select a calendar...</option>
                        </select>
                        <p class="text-xs text-earth-metal mt-1">Events will be pushed to this calendar</p>
                    </div>

                    <!-- Sync Mode -->
                    <div>
                        <span class="font-mono text-xs uppercase text-earth-metal block mb-2">Sync Mode</span>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="radio" name="gcalSyncMode" value="push" checked class="w-4 h-4">
                            <div>
                                <span class="text-sm text-charcoal font-medium">One-way push</span>
                                <p class="text-xs text-earth-metal">Push pet events to Google Calendar</p>
                            </div>
                        </label>
                    </div>

                    <!-- Disconnect Button -->
                    <div id="gcalDisconnectSection" class="hidden">
                        <button onclick="App.disconnectGoogleCalendar()"
                            class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                            <i data-lucide="unlink" class="w-4 h-4 inline mr-2"></i>Disconnect Google Calendar
                        </button>
                    </div>
                </div>

                <!-- Danger Zone Tab -->
                <div data-tab-panel="settings" data-panel="danger" class="hidden space-y-4">
                    <div class="border border-muted-pink p-4 bg-muted-pink/10">
                        <h4 class="font-mono text-xs uppercase text-charcoal mb-2">Reset Application</h4>
                        <p class="text-sm text-earth-metal mb-4">This will delete all local data including settings,
                            cached pets, events, and media. Data already synced to Notion will not be affected.</p>
                        <button onclick="App.confirmReset()" class="btn-danger px-4 py-2 font-mono text-xs uppercase">
                            <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>Reset App
                        </button>
                    </div>
                </div>
            </div>

            <div class="border-t border-oatmeal p-4 flex justify-end gap-3 flex-shrink-0">
                <button onclick="PetTracker.UI.closeModal('settingsModal')"
                    class="btn-secondary px-4 py-2 font-mono text-xs uppercase">Cancel</button>
                <button onclick="App.saveSettings()" class="btn-primary px-4 py-2 font-mono text-xs uppercase">Save
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal (Multi-step Wizard) -->
    <div id="onboardingModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="onboardingModalTitle">
        <div class="absolute inset-0 modal-overlay"></div>
        <div
            class="relative bg-white-linen border border-oatmeal w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col z-10">
            <div class="p-4 border-b border-oatmeal flex-shrink-0">
                <div class="flex items-center justify-between">
                    <span class="section-header">Setup Wizard</span>
                    <div id="onboardingSteps" class="flex gap-1">
                        <span class="w-8 h-1 bg-dull-purple" data-step="1"></span>
                        <span class="w-8 h-1 bg-oatmeal" data-step="2"></span>
                        <span class="w-8 h-1 bg-oatmeal" data-step="3"></span>
                        <span class="w-8 h-1 bg-oatmeal" data-step="4"></span>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <!-- Step 1: Welcome -->
                <div id="onboardingStep1" class="onboarding-step">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-charcoal flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="heart-pulse" class="w-8 h-8 text-white-linen"></i>
                        </div>
                        <h2 class="font-serif text-2xl text-charcoal mb-2">Welcome to Pet Tracker</h2>
                        <p class="text-earth-metal">Track your pet's health, medications, and appointments with Notion
                            as your backend.</p>
                    </div>
                    <div class="space-y-4">
                        <div class="flex items-start gap-3">
                            <span class="badge badge-dark">1</span>
                            <div>
                                <p class="text-sm text-charcoal font-medium">Set up Cloudflare Worker</p>
                                <p class="text-xs text-earth-metal">Deploy the CORS proxy for API calls</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="badge badge-dark">2</span>
                            <div>
                                <p class="text-sm text-charcoal font-medium">Connect to Notion</p>
                                <p class="text-xs text-earth-metal">Create an integration and get your token</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <span class="badge badge-dark">3</span>
                            <div>
                                <p class="text-sm text-charcoal font-medium">Add your first pet</p>
                                <p class="text-xs text-earth-metal">Get started tracking right away</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Worker Setup -->
                <div id="onboardingStep2" class="onboarding-step hidden">
                    <h3 class="font-serif text-xl text-charcoal mb-4">Cloudflare Worker Setup</h3>
                    <p class="text-earth-metal text-sm mb-4">Deploy a CORS proxy to enable API calls from this app.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Worker URL *</label>
                            <input type="url" id="onboardingWorkerUrl" class="input-field"
                                placeholder="https://your-worker.workers.dev">
                        </div>
                        <div>
                            <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Proxy Token
                                (optional)</label>
                            <input type="text" id="onboardingProxyToken" class="input-field"
                                placeholder="Your worker secret token">
                        </div>
                        <input type="hidden" id="onboardingWorkerVerified" value="false">
                        <div id="onboardingWorkerStatus" class="hidden"></div>

                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" onclick="App.showWorkerCode()"
                                class="btn-secondary px-3 py-2 font-mono text-xs uppercase">
                                <i data-lucide="code" class="w-4 h-4 inline mr-2"></i>Code
                            </button>
                            <button id="onboardingVerifyWorkerBtn" type="button" onclick="Onboarding.verifyWorker()"
                                class="btn-primary px-3 py-2 font-mono text-xs uppercase">
                                <i data-lucide="plug" class="w-4 h-4 inline mr-2"></i>Verify
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Notion Connection -->
                <div id="onboardingStep3" class="onboarding-step hidden">
                    <h3 class="font-serif text-xl text-charcoal mb-4">Connect to Notion</h3>
                    <p class="text-earth-metal text-sm mb-4">Connect your workspace and map the required databases.</p>

                    <div class="space-y-4">
                        <!-- Template Link -->
                        <div class="border border-oatmeal p-3 bg-oatmeal/10">
                            <p class="text-sm text-charcoal">
                                <i data-lucide="copy" class="w-4 h-4 inline mr-1"></i>
                                First, duplicate this <a href="https://mimansajaiswal-embedded-dbs.notion.site/pet-tracker-template" target="_blank" rel="noopener noreferrer" class="underline text-dull-purple font-medium">Notion template</a> to your workspace.
                            </p>
                        </div>

                        <button onclick="Onboarding.startOAuth()"
                            class="btn-primary w-full px-4 py-2 font-mono text-xs uppercase flex items-center justify-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4"></i>Connect with Notion
                        </button>

                        <div class="flex items-center gap-4">
                            <div class="flex-1 border-t border-oatmeal"></div>
                            <span class="font-mono text-xs uppercase text-earth-metal">OR</span>
                            <div class="flex-1 border-t border-oatmeal"></div>
                        </div>

                        <div>
                            <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Manual Token</label>
                            <input type="password" id="onboardingNotionToken" class="input-field"
                                placeholder="secret_..."
                                onchange="document.getElementById('onboardingDatabasesVerified').value = 'false'">
                        </div>

                        <button type="button" onclick="Onboarding.findDatabases()"
                            class="btn-secondary px-4 py-2 font-mono text-xs uppercase w-full">
                            <i data-lucide="scan" class="w-4 h-4 inline mr-2"></i>Find Data Sources
                        </button>

                        <div id="onboardingDbList" class="hidden"></div>
                        <input type="hidden" id="onboardingDatabasesVerified" value="false">

                        <button id="onboardingDbVerifyBtn" type="button" onclick="Onboarding.checkDbMapping()"
                            class="hidden btn-secondary px-4 py-2 font-mono text-xs uppercase w-full mt-2">
                            <i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>Confirm Mapping
                        </button>
                    </div>
                </div>

                <!-- Step 4: First Pet & Sample Data -->
                <div id="onboardingStep4" class="onboarding-step hidden">
                    <h3 class="font-serif text-xl text-charcoal mb-4">Add Your First Pet</h3>
                    <p class="text-earth-metal text-sm mb-4">Let's add your pet to get started. You can add more later.
                    </p>

                    <div class="space-y-4">
                        <div>
                            <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Pet Name *</label>
                            <input type="text" id="onboardingPetName" class="input-field"
                                placeholder="e.g., Luna, Max, Bella">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Species</label>
                                <select id="onboardingPetSpecies" class="select-field">
                                    <option value="Dog">Dog</option>
                                    <option value="Cat">Cat</option>
                                    <option value="Bird">Bird</option>
                                    <option value="Fish">Fish</option>
                                    <option value="Rabbit">Rabbit</option>
                                    <option value="Reptile">Reptile</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Color</label>
                                <input type="color" id="onboardingPetColor" class="input-field h-10" value="#8b7b8e">
                            </div>
                        </div>

                        <div class="border border-oatmeal p-4 bg-oatmeal/10">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="onboardingCreateSample" checked class="w-4 h-4">
                                <div>
                                    <span class="text-sm text-charcoal font-medium">Create sample data</span>
                                    <p class="text-xs text-earth-metal">Add example event types, scales, and care items
                                        to explore the app</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="border-t border-oatmeal p-4 flex justify-between flex-shrink-0">
                <button id="onboardingBack" onclick="Onboarding.prevStep()"
                    class="btn-secondary px-4 py-2 font-mono text-xs uppercase hidden">
                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i>Back
                </button>
                <div class="flex gap-3 ml-auto">
                    <button id="onboardingNext" onclick="Onboarding.nextStep()"
                        class="btn-primary px-4 py-2 font-mono text-xs uppercase">
                        Next<i data-lucide="arrow-right" class="w-4 h-4 inline ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Pet Modal -->
    <div id="addPetModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="addPetModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div class="relative bg-white-linen border border-oatmeal w-full max-w-lg max-h-[90vh] overflow-y-auto z-10">
            <div class="sticky top-0 bg-white-linen border-b border-oatmeal p-4 flex items-center justify-between">
                <span class="section-header">Add Pet</span>
                <button onclick="PetTracker.UI.closeModal('addPetModal')"
                    class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="addPetForm" class="p-4 space-y-4">
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Name *</label>
                    <input type="text" id="addPetName" class="input-field" required placeholder="Pet name">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Species</label>
                        <select id="addPetSpecies" class="select-field">
                            <option value="">Select...</option>
                            <option value="Dog">Dog</option>
                            <option value="Cat">Cat</option>
                            <option value="Bird">Bird</option>
                            <option value="Fish">Fish</option>
                            <option value="Rabbit">Rabbit</option>
                            <option value="Reptile">Reptile</option>
                            <option value="Hamster">Hamster</option>
                            <option value="Guinea Pig">Guinea Pig</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Sex</label>
                        <select id="addPetSex" class="select-field">
                            <option value="">Select...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Breed</label>
                    <input type="text" id="addPetBreed" class="input-field" placeholder="Breed or type">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Birth Date</label>
                        <input type="date" id="addPetBirthDate" class="input-field">
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Color (Calendar)</label>
                        <input type="color" id="addPetColor" class="input-field h-10" value="#8b7b8e">
                    </div>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Notes</label>
                    <textarea id="addPetNotes" class="input-field h-20 resize-none"
                        placeholder="Additional notes..."></textarea>
                </div>
                <div class="flex gap-3 justify-end pt-4 border-t border-oatmeal">
                    <button type="button" onclick="PetTracker.UI.closeModal('addPetModal')"
                        class="btn-secondary px-4 py-2 font-mono text-xs uppercase">Cancel</button>
                    <button type="submit" class="btn-primary px-4 py-2 font-mono text-xs uppercase">Save Pet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Worker Code Modal -->
    <div id="workerCodeModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="workerCodeModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div
            class="relative bg-white-linen border border-oatmeal w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col z-10">
            <div class="border-b border-oatmeal p-4 flex items-center justify-between flex-shrink-0">
                <span class="section-header">Cloudflare Worker Code</span>
                <button onclick="PetTracker.UI.closeModal('workerCodeModal')"
                    class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div class="mb-4">
                    <p class="text-sm text-earth-metal mb-2">Deploy this code as a Cloudflare Worker to proxy API
                        requests:</p>
                    <ol class="text-xs text-earth-metal list-decimal list-inside space-y-1">
                        <li>Go to Cloudflare Dashboard  Workers & Pages</li>
                        <li>Create a new Worker</li>
                        <li>Paste the code below and deploy</li>
                        <li>Optionally set <code class="bg-oatmeal px-1">ALL_CORS_PROXY_MATCH_TOKEN</code> secret</li>
                        <li>Copy your Worker URL to settings</li>
                    </ol>
                </div>
                <div class="relative">
                    <pre id="workerCodeBlock"
                        class="bg-charcoal text-white-linen p-4 text-xs font-mono overflow-x-auto whitespace-pre"></pre>
                    <button onclick="App.copyWorkerCode()"
                        class="absolute top-2 right-2 btn-accent px-3 py-1 font-mono text-xs uppercase">
                        <i data-lucide="copy" class="w-3 h-3 inline mr-1"></i>Copy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Entry Modal -->
    <div id="aiEntryModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="aiEntryModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div
            class="relative bg-white-linen border border-oatmeal w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col z-10">
            <div class="border-b border-oatmeal p-4 flex items-center justify-between flex-shrink-0">
                <div class="flex items-center gap-3">
                    <span class="section-header">AI Quick Add</span>
                    <button onclick="AI.showQueueModal()" class="relative p-1 text-earth-metal hover:text-dull-purple"
                        title="View Queue">
                        <i data-lucide="list-todo" class="w-5 h-5"></i>
                        <span id="aiQueueBadge"
                            class="hidden absolute -top-1 -right-1 w-5 h-5 bg-dull-purple text-white-linen text-[10px] font-mono flex items-center justify-center">0</span>
                    </button>
                </div>
                <button onclick="PetTracker.UI.closeModal('aiEntryModal')"
                    class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Input Area -->
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-2">Type or Dictate</label>
                    <textarea id="aiInputText" class="input-field h-32 resize-none"
                        placeholder="e.g., Luna threw up this morning, gave Max his heartworm meds yesterday at 8am..."
                        oninput="AI.onInputChange(this.value)"></textarea>
                    <p class="text-xs text-earth-metal mt-1">AI will parse automatically after 5 seconds of inactivity.
                        Offline? Queue for later.</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-2">
                    <button onclick="AI.parse()" class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                        <i data-lucide="sparkles" class="w-4 h-4 inline mr-2"></i>Parse Now
                    </button>
                    <button onclick="AI.queueForLater()" class="btn-secondary px-4 py-2 font-mono text-xs uppercase"
                        title="Save for later when offline or busy">
                        <i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>Queue for Later
                    </button>
                    <button onclick="AI.processQueue()" class="btn-secondary px-4 py-2 font-mono text-xs uppercase"
                        title="Process all pending queued items">
                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>Process Queue
                    </button>
                </div>

                <!-- Entries List -->
                <div>
                    <span class="font-mono text-xs uppercase text-earth-metal">Extracted Entries</span>
                    <div id="aiEntriesList" class="mt-2 space-y-2">
                        <p class="text-earth-metal text-sm py-4">
                            Type or dictate entries above. AI will parse them after 5 seconds of inactivity.
                        </p>
                    </div>
                </div>
            </div>
            <div class="border-t border-oatmeal p-4 flex justify-end gap-3 flex-shrink-0">
                <button onclick="AI.reset(); PetTracker.UI.closeModal('aiEntryModal')"
                    class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                    Cancel
                </button>
                <button onclick="AI.saveAll()" class="btn-primary px-4 py-2 font-mono text-xs uppercase">
                    <i data-lucide="check" class="w-4 h-4 inline mr-2"></i>Save All
                </button>
            </div>
        </div>
    </div>

    <!-- AI Queue Modal -->
    <div id="aiQueueModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="aiQueueModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div
            class="relative bg-white-linen border border-oatmeal w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col z-10">
            <div class="border-b border-oatmeal p-4 flex items-center justify-between flex-shrink-0">
                <span id="aiQueueModalTitle" class="section-header">AI Queue</span>
                <button onclick="PetTracker.UI.closeModal('aiQueueModal')"
                    class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <p class="text-xs text-earth-metal mb-4">Items queued for later AI processing. Process when online and
                    ready.</p>
                <div id="aiQueueList" class="space-y-2">
                    <p class="text-earth-metal text-sm py-4">No items in queue.</p>
                </div>
            </div>
            <div class="border-t border-oatmeal p-4 flex justify-between gap-3 flex-shrink-0">
                <button onclick="AI.retryFailed()" class="btn-secondary px-4 py-2 font-mono text-xs uppercase">
                    <i data-lucide="rotate-ccw" class="w-4 h-4 inline mr-2"></i>Retry Failed
                </button>
                <div class="flex gap-2">
                    <button onclick="PetTracker.UI.closeModal('aiQueueModal')"
                        class="btn-secondary px-4 py-2 font-mono text-xs uppercase">Close</button>
                    <button onclick="PetTracker.UI.closeModal('aiQueueModal'); AI.processQueue()"
                        class="btn-primary px-4 py-2 font-mono text-xs uppercase">
                        <i data-lucide="play" class="w-4 h-4 inline mr-2"></i>Process All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div id="contactModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4" role="dialog"
        aria-modal="true" aria-labelledby="contactModalTitle">
        <div class="absolute inset-0 modal-overlay" data-modal-overlay></div>
        <div class="relative bg-white-linen border border-oatmeal w-full max-w-lg max-h-[90vh] overflow-y-auto z-10">
            <div class="sticky top-0 bg-white-linen border-b border-oatmeal p-4 flex items-center justify-between">
                <span id="contactModalTitle" class="section-header">Add Contact</span>
                <button onclick="PetTracker.UI.closeModal('contactModal')"
                    class="p-1 text-earth-metal hover:text-charcoal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="contactForm" class="p-4 space-y-4" onsubmit="event.preventDefault(); Contacts.save();">
                <input type="hidden" id="contactEditId">
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Name *</label>
                    <input type="text" id="contactName" class="input-field" placeholder="Contact name" required>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Role *</label>
                    <select id="contactRole" class="select-field" required>
                        <option value="Vet">Vet</option>
                        <option value="Groomer">Groomer</option>
                        <option value="Sitter">Sitter</option>
                        <option value="Breeder">Breeder</option>
                        <option value="Emergency">Emergency</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Phone</label>
                        <input type="tel" id="contactPhone" class="input-field" placeholder="Phone number">
                    </div>
                    <div>
                        <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Email</label>
                        <input type="email" id="contactEmail" class="input-field" placeholder="Email address">
                    </div>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Address</label>
                    <textarea id="contactAddress" class="input-field h-16 resize-none" placeholder="Address"></textarea>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Notes</label>
                    <textarea id="contactNotes" class="input-field h-20 resize-none"
                        placeholder="Additional notes..."></textarea>
                </div>
                <div>
                    <label class="font-mono text-xs uppercase text-earth-metal block mb-1">Related Pets</label>
                    <div id="contactPetCheckboxes" class="space-y-2 max-h-32 overflow-y-auto border border-oatmeal p-2">
                    </div>
                </div>
                <div class="flex gap-3 justify-end pt-4 border-t border-oatmeal">
                    <button type="button" onclick="PetTracker.UI.closeModal('contactModal')"
                        class="btn-secondary px-4 py-2 font-mono text-xs uppercase">Cancel</button>
                    <button type="submit" class="btn-primary px-4 py-2 font-mono text-xs uppercase">Save
                        Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="./js/storage.js"></script>
    <script src="./js/ui.js"></script>
    <script src="./js/api.js"></script>
    <script src="./js/sync.js"></script>
    <script src="./js/pets.js"></script>
    <script src="./js/events.js"></script>
    <script src="./js/calendar.js"></script>
    <script src="./js/care.js"></script>
    <script src="./js/media.js"></script>
    <script src="./js/ai.js"></script>
    <script src="./js/todoist.js"></script>
    <script src="./js/calendar-export.js"></script>
    <script src="./js/analytics.js"></script>
    <script src="./js/contacts.js"></script>
    <script src="./js/onboarding.js"></script>
    <script src="./js/app.js"></script>

    <script>
        // Worker code template
        const WORKER_CODE = `// Pet Tracker CORS Proxy Worker with OAuth Support
// Deploy to Cloudflare Workers
// Set secrets: ALL_CORS_PROXY_MATCH_TOKEN (optional), NOTION_CLIENT_SECRET

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // Handle preflight for all requests
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, PUT, PATCH, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, Authorization, Notion-Version',
          'Access-Control-Max-Age': '86400'
        }
      });
    }

    // OAuth callback handler
    if (url.pathname === '/oauth/callback') {
      const code = url.searchParams.get('code');
      const clientId = url.searchParams.get('state') || env.NOTION_CLIENT_ID;
      const clientSecret = env.NOTION_CLIENT_SECRET;

      if (!code) {
        return new Response(\`<!DOCTYPE html><html><body><script>
          window.opener.postMessage({ type: 'NOTION_OAUTH_ERROR', error: 'No code provided' }, '*');
          window.close();
        <\\/script></body></html>\`, { headers: { 'Content-Type': 'text/html' } });
      }

      if (!clientSecret) {
        return new Response(\`<!DOCTYPE html><html><body><script>
          window.opener.postMessage({ type: 'NOTION_OAUTH_ERROR', error: 'Server missing NOTION_CLIENT_SECRET' }, '*');
          window.close();
        <\\/script></body></html>\`, { headers: { 'Content-Type': 'text/html' } });
      }

      try {
        const tokenRes = await fetch('https://api.notion.com/v1/oauth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret)
          },
          body: JSON.stringify({
            grant_type: 'authorization_code',
            code,
            redirect_uri: url.origin + '/oauth/callback'
          })
        });

        const tokenData = await tokenRes.json();

        if (tokenData.access_token) {
          return new Response(\`<!DOCTYPE html><html><body><script>
            window.opener.postMessage({ type: 'NOTION_OAUTH_SUCCESS', token: '\${tokenData.access_token}' }, '*');
            window.close();
          <\\/script></body></html>\`, { headers: { 'Content-Type': 'text/html' } });
        } else {
          return new Response(\`<!DOCTYPE html><html><body><script>
            window.opener.postMessage({ type: 'NOTION_OAUTH_ERROR', error: '\${tokenData.error || 'Token exchange failed'}' }, '*');
            window.close();
          <\\/script></body></html>\`, { headers: { 'Content-Type': 'text/html' } });
        }
      } catch (e) {
        return new Response(\`<!DOCTYPE html><html><body><script>
          window.opener.postMessage({ type: 'NOTION_OAUTH_ERROR', error: 'Token exchange error' }, '*');
          window.close();
        <\\/script></body></html>\`, { headers: { 'Content-Type': 'text/html' } });
      }
    }

    // Regular proxy request
    const targetUrl = url.searchParams.get('url');
    const token = url.searchParams.get('token');

    // Validate token if configured
    if (env.ALL_CORS_PROXY_MATCH_TOKEN && token !== env.ALL_CORS_PROXY_MATCH_TOKEN) {
      return new Response('Unauthorized', { status: 401 });
    }

    if (!targetUrl) {
      return new Response('Missing url parameter', { status: 400 });
    }

    // Forward request
    const headers = new Headers(request.headers);
    headers.delete('host');

    const response = await fetch(targetUrl, {
      method: request.method,
      headers,
      body: request.method !== 'GET' && request.method !== 'HEAD' ? await request.text() : null
    });

    // Add CORS headers
    const corsHeaders = new Headers(response.headers);
    corsHeaders.set('Access-Control-Allow-Origin', '*');

    return new Response(response.body, {
      status: response.status,
      headers: corsHeaders
    });
  }
};`;

        // Add worker code display function
        App.showWorkerCode = () => {
            document.getElementById('workerCodeBlock').textContent = WORKER_CODE;
            PetTracker.UI.openModal('workerCodeModal');
            if (window.lucide) lucide.createIcons();
        };

        App.copyWorkerCode = () => {
            navigator.clipboard.writeText(WORKER_CODE).then(() => {
                PetTracker.UI.toast('Worker code copied!', 'success');
            }).catch(() => {
                PetTracker.UI.toast('Failed to copy', 'error');
            });
        };

        App.saveSettings = () => {
            const settings = {
                workerUrl: document.getElementById('settingsWorkerUrl')?.value || '',
                proxyToken: document.getElementById('settingsProxyToken')?.value || '',
                oauthClientId: document.getElementById('settingsOAuthClientId')?.value || '',
                notionToken: document.getElementById('settingsNotionToken')?.value || '',
                databaseId: document.getElementById('settingsDatabaseId')?.value || '',
                aiProvider: document.getElementById('settingsAiProvider')?.value || 'openai',
                aiModel: document.getElementById('settingsAiModel')?.value || 'gpt-4o-mini',
                aiApiKey: document.getElementById('settingsAiApiKey')?.value || '',
                aiEndpoint: document.getElementById('settingsAiEndpoint')?.value || '',
                todoistEnabled: document.getElementById('settingsTodoistEnabled')?.checked || false,
                todoistToken: document.getElementById('settingsTodoistToken')?.value || '',
                gcalEnabled: document.getElementById('settingsGcalEnabled')?.checked || false,
                gcalCalendarId: document.getElementById('settingsGcalCalendarId')?.value || ''
            };

            // Get data source mappings if visible
            const mappingDiv = document.getElementById('dataSourceMapping');
            if (mappingDiv && !mappingDiv.classList.contains('hidden')) {
                settings.dataSources = {
                    pets: document.getElementById('dsMapPets')?.value || '',
                    events: document.getElementById('dsMapEvents')?.value || '',
                    eventTypes: document.getElementById('dsMapEventTypes')?.value || '',
                    careItems: document.getElementById('dsMapCareItems')?.value || '',
                    carePlans: document.getElementById('dsMapCarePlans')?.value || '',
                    contacts: document.getElementById('dsMapContacts')?.value || '',
                    scales: document.getElementById('dsMapScales')?.value || '',
                    scaleLevels: document.getElementById('dsMapScaleLevels')?.value || ''
                };
            }
            PetTracker.Settings.set(settings);
            PetTracker.UI.toast('Settings saved', 'success');
            PetTracker.UI.closeModal('settingsModal');
        };

        // Google Calendar OAuth - redirect-based flow
        App.startGoogleOAuth = () => {
            const workerUrl = document.getElementById('settingsWorkerUrl')?.value?.trim();
            if (!workerUrl) {
                PetTracker.UI.toast('Please enter Worker URL first in Connection tab', 'error');
                return;
            }
            PetTracker.Settings.set({ workerUrl });
            const returnUrl = encodeURIComponent(new URL('index.html', window.location.href).toString());
            window.location.href = `https://notion-oauth-handler.mimansa-jaiswal.workers.dev/google/auth?from=${returnUrl}`;
        };

        // Disconnect Google Calendar
        App.disconnectGoogleCalendar = () => {
            PetTracker.UI.confirm('Disconnect Google Calendar?', () => {
                const settings = PetTracker.Settings.get();
                delete settings.gcalAccessToken;
                delete settings.gcalRefreshToken;
                delete settings.gcalUserEmail;
                settings.gcalEnabled = false;
                settings.gcalCalendarId = '';
                PetTracker.Settings.set(settings);
                App.updateGcalUI();
                PetTracker.UI.toast('Google Calendar disconnected', 'success');
            });
        };

        // Update Google Calendar UI based on connection status
        App.updateGcalUI = () => {
            const settings = PetTracker.Settings.get();
            const statusEl = document.getElementById('gcalConnectionStatus');
            const calendarSelectDiv = document.getElementById('gcalCalendarSelect');
            const disconnectDiv = document.getElementById('gcalDisconnectSection');

            if (settings.gcalAccessToken) {
                if (statusEl) statusEl.innerHTML = `<span class="text-dull-purple">Connected</span>${settings.gcalUserEmail ? ` as ${settings.gcalUserEmail}` : ''}`;
                if (calendarSelectDiv) calendarSelectDiv.classList.remove('hidden');
                if (disconnectDiv) disconnectDiv.classList.remove('hidden');
                App.loadGoogleCalendars();
            } else {
                if (statusEl) statusEl.textContent = 'Not connected';
                if (calendarSelectDiv) calendarSelectDiv.classList.add('hidden');
                if (disconnectDiv) disconnectDiv.classList.add('hidden');
            }
        };

        // Load user's Google Calendars
        App.loadGoogleCalendars = async () => {
            const settings = PetTracker.Settings.get();
            if (!settings.gcalAccessToken || !settings.workerUrl) return;

            try {
                const response = await fetch(`${settings.workerUrl}?url=${encodeURIComponent('https://www.googleapis.com/calendar/v3/users/me/calendarList')}${settings.proxyToken ? '&token=' + settings.proxyToken : ''}`, {
                    headers: { 'Authorization': `Bearer ${settings.gcalAccessToken}` }
                });

                if (!response.ok) throw new Error('Failed to fetch calendars');
                const data = await response.json();

                const select = document.getElementById('settingsGcalCalendarId');
                if (select && data.items) {
                    select.innerHTML = '<option value="">Select a calendar...</option>' +
                        data.items.map(cal => `<option value="${cal.id}" ${cal.id === settings.gcalCalendarId ? 'selected' : ''}>${PetTracker.UI.escapeHtml(cal.summary)}</option>`).join('');
                }
            } catch (e) {
                console.warn('[App] Failed to load Google calendars:', e);
            }
        };



        App.testConnection = async () => {
            // Save current values first
            App.saveSettings();

            try {
                PetTracker.UI.showLoading('Testing connection...');
                const user = await PetTracker.API.verifyConnection();
                PetTracker.UI.hideLoading();
                PetTracker.UI.toast(`Connected as ${user.name || user.id}`, 'success');
            } catch (e) {
                PetTracker.UI.hideLoading();
                PetTracker.UI.toast(`Connection failed: ${e.message}`, 'error');
            }
        };

        App.scanDataSources = async () => {
            const dbId = document.getElementById('settingsDatabaseId')?.value?.trim();
            if (!dbId) {
                PetTracker.UI.toast('Enter a database ID first', 'error');
                return;
            }

            try {
                PetTracker.UI.showLoading('Scanning data sources...');

                // Query database to get properties
                const db = await PetTracker.API.request('GET', `/databases/${dbId}`);

                // For multi-source containers, we query to find distinct sources
                // For now, we show the database properties and let user map
                const properties = db.properties || {};
                const propNames = Object.keys(properties);

                // Show mapping UI
                const mappingDiv = document.getElementById('dataSourceMapping');
                const schemaDiv = document.getElementById('schemaStatus');
                const schemaList = document.getElementById('schemaStatusList');

                if (mappingDiv) {
                    mappingDiv.classList.remove('hidden');

                    // Populate selects with detected source hints
                    const selects = ['dsMapPets', 'dsMapEvents', 'dsMapEventTypes', 'dsMapCareItems',
                        'dsMapCarePlans', 'dsMapContacts', 'dsMapScales', 'dsMapScaleLevels'];
                    const optionsHtml = '<option value="">-- Select --</option>' +
                        propNames.map(p => `<option value="${p}">${p}</option>`).join('');

                    selects.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = optionsHtml;
                    });
                }

                // Show schema status
                if (schemaDiv && schemaList) {
                    schemaDiv.classList.remove('hidden');
                    schemaList.innerHTML = propNames.slice(0, 10).map(name => {
                        const prop = properties[name];
                        return `<div class="flex items-center justify-between text-xs py-1 border-b border-oatmeal">
                            <span class="font-mono text-charcoal">${name}</span>
                            <span class="text-earth-metal">${prop.type}</span>
                        </div>`;
                    }).join('') + (propNames.length > 10 ? `<p class="text-xs text-earth-metal mt-1">+ ${propNames.length - 10} more...</p>` : '');
                }

                PetTracker.UI.hideLoading();
                PetTracker.UI.toast(`Found ${propNames.length} properties`, 'success');
                if (window.lucide) lucide.createIcons();

            } catch (e) {
                PetTracker.UI.hideLoading();
                PetTracker.UI.toast(`Scan failed: ${e.message}`, 'error');
            }
        };

        // Load saved settings into form
        document.addEventListener('DOMContentLoaded', () => {
            const s = PetTracker.Settings.get();
            if (document.getElementById('settingsWorkerUrl')) {
                document.getElementById('settingsWorkerUrl').value = s.workerUrl || '';
                document.getElementById('settingsProxyToken').value = s.proxyToken || '';
                document.getElementById('settingsOAuthClientId').value = s.oauthClientId || '';
                document.getElementById('settingsNotionToken').value = s.notionToken || '';
                document.getElementById('settingsDatabaseId').value = s.databaseId || '';
                document.getElementById('settingsAiProvider').value = s.aiProvider || 'openai';
                document.getElementById('settingsAiModel').value = s.aiModel || 'gpt-4o-mini';
                document.getElementById('settingsAiApiKey').value = s.aiApiKey || '';
                document.getElementById('settingsAiEndpoint').value = s.aiEndpoint || '';
                document.getElementById('settingsTodoistEnabled').checked = s.todoistEnabled || false;
                document.getElementById('settingsTodoistToken').value = s.todoistToken || '';
                document.getElementById('settingsGcalEnabled').checked = s.gcalEnabled || false;
                document.getElementById('settingsGcalCalendarId').value = s.gcalCalendarId || '';
                // Update Google Calendar UI
                setTimeout(() => App.updateGcalUI(), 100);
                // Update AI endpoint visibility
                setTimeout(() => App.toggleAiEndpoint?.(), 100);
            }
        });

        // Toggle AI endpoint field visibility based on provider
        App.toggleAiEndpoint = () => {
            const provider = document.getElementById('settingsAiProvider')?.value;
            const field = document.getElementById('aiEndpointField');
            if (field) {
                field.classList.toggle('hidden', provider !== 'custom');
            }
        };
    </script>
</body>

</html>