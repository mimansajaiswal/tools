<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostInk Flashcards</title>
    <meta name="theme-color" content="#917FB3">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="icons/icon-96.png" sizes="96x96">

    <!-- Preconnect hints for CDN domains -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>

    <!-- Core Dependencies (Pinned Versions) -->
    <!-- Tailwind CSS (v3 latest) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.562.0/dist/umd/lucide.min.js"></script>
    <!-- Marked (Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@17.0.1/lib/marked.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/sql.js@1.13.0/dist/sql-wasm.js"></script>
    <!-- KaTeX for equations -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"></script>

    <!-- GLightbox (CSS before JS) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.1/dist/css/glightbox.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/glightbox@3.3.1/dist/js/glightbox.min.js"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Sora:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <script>
        (() => {
            const raw = localStorage.getItem('ghostink_settings_v1');
            let mode = 'system';
            let font = 'serif';
            try {
                const s = raw ? JSON.parse(raw) : {};
                mode = s.themeMode || 'system';
                font = s.fontMode || 'serif';
            } catch (_) { }
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = mode === 'system' ? (prefersDark ? 'dark' : 'light') : mode;
            const root = document.documentElement;
            root.setAttribute('data-theme', theme);
            root.setAttribute('data-font', font);
            root.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
        })();
    </script>

    <script>
        tailwind.config = {
            darkMode: ['class', '[data-theme="dark"]'],
            theme: {
                extend: {
                    colors: {
                        oatmeal: {
                            DEFAULT: 'rgb(var(--oatmeal-rgb) / <alpha-value>)',
                            dark: 'rgb(var(--oatmeal-dark-rgb) / <alpha-value>)',
                            hover: 'rgb(var(--oatmeal-hover-rgb) / <alpha-value>)'
                        },
                        'earth-metal': 'rgb(var(--earth-metal-rgb) / <alpha-value>)',
                        charcoal: 'rgb(var(--charcoal-rgb) / <alpha-value>)',
                        'white-linen': 'rgb(var(--linen-rgb) / <alpha-value>)',
                        'dull-purple': {
                            DEFAULT: 'rgb(var(--dull-purple-rgb) / <alpha-value>)',
                            hover: 'rgb(var(--dull-purple-hover-rgb) / <alpha-value>)'
                        },
                        'muted-pink': {
                            DEFAULT: 'rgb(var(--muted-pink-rgb) / <alpha-value>)',
                            hover: 'rgb(var(--muted-pink-hover-rgb) / <alpha-value>)'
                        }
                    },
                    fontFamily: {
                        display: ['var(--font-display, "Fraunces")', 'serif'],
                        sans: ['var(--font-sans, "Sora")', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <!-- Application styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="text-earth-metal font-sans min-h-[100dvh] preinit" data-theme="light" data-font="serif">
    <div class="min-h-[100dvh] flex flex-col">
        <header
            class="flex flex-wrap items-center justify-between gap-2 px-3 sm:px-5 md:px-10 pt-4 sm:pt-6 pb-3 sm:pb-4">
            <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                <div
                    class="w-9 h-9 sm:w-12 sm:h-12 rounded-lg sm:rounded-2xl dash flex items-center justify-center shadow-soft shrink-0">
                    <i data-lucide="sparkles" class="w-5 h-5 sm:w-6 sm:h-6 text-dull-purple"></i>
                </div>
                <div class="min-w-0">
                    <h1 class="font-display text-lg sm:text-2xl text-charcoal tracking-tight truncate">GhostInk</h1>
                    <p class="text-xs sm:text-sm text-earth-metal/70 hidden sm:block">AI-enabled flashcards stored in
                        Notion</p>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-1.5 md:gap-2 shrink-0">
                <div id="connectionBadge"
                    class="px-2 py-1 rounded-full pill text-[10px] sm:text-xs bg-oatmeal border border-oatmeal-dark text-earth-metal hidden md:block">
                    Offline ready</div>
                <!-- Desktop-only options -->
                <div class="hidden sm:flex items-center gap-0.5 sm:gap-1 pill-toggle rounded-full px-1 sm:px-2 py-1">
                    <button class="p-1 rounded-full theme-btn" data-theme="light" data-tip="Light theme"
                        aria-label="Light theme"><i data-lucide="sun" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="dark" data-tip="Dark theme"
                        aria-label="Dark theme"><i data-lucide="moon" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="system" data-tip="System theme"
                        aria-label="System theme"><i data-lucide="laptop" class="w-4 h-4"></i></button>
                </div>
                <div class="hidden md:flex items-center gap-1 pill-toggle rounded-full px-2 py-1">
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="serif" data-tip="Serif font"
                        aria-label="Serif font">
                        <span class="font-swatch-serif inline-block">Aa</span>
                    </button>
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="mono" data-tip="Mono font"
                        aria-label="Monospace font">
                        <span class="font-swatch-mono inline-block">Aa</span>
                    </button>
                </div>
                <div class="hidden sm:flex items-center gap-0.5 sm:gap-1 pill-toggle rounded-full px-1 sm:px-2 py-1">
                    <button id="exportAnkiBtn" class="p-1 rounded-full" title="Export Anki" aria-label="Export to Anki">
                        <i data-lucide="download" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                    </button>
                    <label class="p-1 rounded-full cursor-pointer" title="Import Anki" aria-label="Import from Anki">
                        <i data-lucide="upload-cloud" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                        <input aria-label="Import .apkg" id="ankiImportInput" type="file" accept=".apkg,.json"
                            class="hidden">
                    </label>
                </div>
                <!-- Mobile more button -->
                <button id="mobileMoreBtn"
                    class="sm:hidden p-1.5 rounded-full bg-white-linen border border-oatmeal-dark" title="More options"
                    aria-label="More options">
                    <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                </button>
                <button id="syncNowBtn"
                    class="p-1.5 sm:p-2 rounded-full bg-dull-purple text-white hover:bg-dull-purple-hover transition-all"
                    data-tip="Sync now" title="Sync" aria-label="Sync with Notion">
                    <i data-lucide="refresh-ccw" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                </button>
                <button id="openSettings"
                    class="p-1.5 sm:p-2 rounded-full bg-white-linen border border-oatmeal-dark hover:border-dull-purple transition-all"
                    data-tip="Settings" title="Settings" aria-label="Open settings">
                    <i data-lucide="settings" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                </button>
            </div>
            <!-- Mobile expanded menu -->
            <div id="mobileMoreMenu"
                class="hidden w-full pt-2 pb-1 border-t border-[color:var(--card-border)] mt-2 flex-wrap gap-2 sm:hidden">
                <div class="flex items-center gap-1 pill-toggle rounded-full px-2 py-1">
                    <button class="p-1 rounded-full theme-btn" data-theme="light" aria-label="Light theme"><i
                            data-lucide="sun" class="w-4 h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="dark" aria-label="Dark theme"><i
                            data-lucide="moon" class="w-4 h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="system" aria-label="System theme"><i
                            data-lucide="laptop" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 pill-toggle rounded-full px-2 py-1">
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="serif"
                        aria-label="Serif font"><span class="font-swatch-serif">Aa</span></button>
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="mono"
                        aria-label="Monospace font"><span class="font-swatch-mono">Aa</span></button>
                </div>
                <div class="flex items-center gap-1 pill-toggle rounded-full px-2 py-1">
                    <button id="exportAnkiBtnMobile" class="p-1 rounded-full" title="Export Anki"
                        aria-label="Export to Anki"><i data-lucide="download" class="w-4 h-4"></i></button>
                    <label class="p-1 rounded-full cursor-pointer" title="Import Anki" aria-label="Import from Anki">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        <input aria-label="Import .apkg" id="ankiImportInputMobile" type="file" accept=".apkg,.json"
                            class="hidden">
                    </label>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav id="tabBar"
            class="px-3 sm:px-5 md:px-10 py-2 sm:py-3 flex gap-1.5 sm:gap-2 border-b border-[color:var(--card-border)]">
            <button data-tab="study" class="tab-btn active text-xs sm:text-sm">üìñ Study</button>
            <button data-tab="library" class="tab-btn text-xs sm:text-sm">üìö Library</button>
        </nav>

        <main class="px-3 sm:px-5 md:px-10 pb-6 sm:pb-10 space-y-4 md:space-y-6">
            <div id="lockedOverlay"
                class="rounded-2xl p-6 bg-[color:var(--surface-strong)] border border-[color:var(--card-border)] flex flex-col gap-5 max-w-3xl mx-auto mt-6 text-center hidden">

                <!-- What is GhostInk Feature Card -->
                <div
                    class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-4 text-left">
                    <div class="flex items-center gap-2 text-dull-purple font-semibold mb-3">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span class="text-sm">Features</span>
                    </div>
                    <div class="max-h-44 overflow-y-auto scroll-minimal pr-1">
                        <div
                            class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-xs text-earth-metal/70 dark:text-white/60">
                            <div class="flex items-center gap-2">
                                <i data-lucide="eye" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Reveal mode</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="bot" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>AI answer judging</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="brain" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>SM-2 & FSRS v6</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="mic" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Voice input</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Front-back & Cloze</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="image" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Media & LaTeX</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="download" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Anki import/export</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="keyboard" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Keyboard shortcuts</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="wifi-off" class="w-3.5 h-3.5 text-dull-purple shrink-0"></i>
                                <span>Offline PWA</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <p class="font-display text-xl text-charcoal leading-tight">AI-enabled flashcards stored in Notion
                    </p>
                    <p class="text-sm text-earth-metal/70 leading-relaxed">
                        Your cards live in Notion where you can see and edit them. Reveal answers like Anki, or
                        type/speak your answer and let AI check it against the ground truth.
                    </p>
                    <p class="text-[11px] text-earth-metal/60 dark:text-white/60">
                        Built by <a class="underline text-dull-purple dark:text-dull-purple"
                            href="https://mimansajaiswal.github.io" target="_blank" rel="noopener noreferrer">Mimansa
                            Jaiswal</a> ¬∑ In the <a class="underline text-dull-purple dark:text-dull-purple"
                            href="https://mimansajaiswal.github.io/tools/" target="_blank"
                            rel="noopener noreferrer">Tools Made with LLMs</a> ¬∑ Code: <a
                            class="underline text-dull-purple dark:text-dull-purple"
                            href="https://github.com/mimansajaiswal/tools/tree/main/ghostink-flashcards" target="_blank"
                            rel="noopener noreferrer">ghostink-flashcards</a>
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-3 text-sm text-left">
                    <div
                        class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-3 space-y-1">
                        <div class="flex items-center gap-2 text-dull-purple font-semibold"><i data-lucide="copy"
                                class="w-4 h-4"></i>1. Template</div>
                        <p class="text-earth-metal/70">Duplicate this <a
                                href="https://mimansajaiswal-embedded-dbs.notion.site/ghostink-template" target="_blank"
                                rel="noopener noreferrer" class="underline text-dull-purple">Notion template</a>. Custom
                            DBs must match property names/options exactly (case-sensitive).</p>
                    </div>
                    <div
                        class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-3 space-y-1">
                        <div class="flex items-center gap-2 text-dull-purple font-semibold"><i data-lucide="link"
                                class="w-4 h-4"></i>2. Connect</div>
                        <p class="text-earth-metal/70">Add worker URL, Notion token, and select your new databases.</p>
                    </div>
                    <div
                        class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-3 space-y-1">
                        <div class="flex items-center gap-2 text-dull-purple font-semibold"><i data-lucide="wand-2"
                                class="w-4 h-4"></i>3. Study</div>
                        <p class="text-earth-metal/70">Sync and start reviewing flashcards.</p>
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="lockedOpenSettings"
                        class="px-5 py-3 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all flex items-center gap-2 whitespace-nowrap shadow-soft">
                        <i data-lucide="settings" class="w-4 h-4"></i><span>Open settings</span>
                    </button>
                </div>
            </div>

            <section id="mainContent" class="space-y-6">
                <!-- LIBRARY TAB -->
                <div id="libraryTab" class="tab-content space-y-4 md:space-y-6 hidden">
                    <!-- Decks Section -->
                    <article class="card rounded-2xl p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                        <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0">
                                <h2 class="font-display text-base md:text-lg text-charcoal">Decks</h2>
                                <p class="text-xs md:text-sm text-earth-metal/70 hidden sm:block">Click to select a deck
                                    and view its cards.</p>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <button id="refreshDecksBtn"
                                    class="p-2 rounded-lg border border-oatmeal-dark/60 text-earth-metal hover:bg-oatmeal dark:hover:bg-white/5 flex items-center gap-2"
                                    data-tooltip="Sync with Notion">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                </button>
                                <button id="newDeckBtn"
                                    class="p-2 md:px-3 md:py-2 rounded-lg bg-charcoal dark:bg-white/10 dark:border-white/10 dark:border text-white text-sm hover:bg-earth-metal dark:hover:bg-white/20 flex items-center gap-2"
                                    data-tooltip="New deck">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span class="hidden md:inline">New deck</span>
                                </button>
                            </div>
                        </div>
                        <!-- Deck search -->
                        <div class="mt-3">
                            <input id="libraryDeckSearch" type="text" placeholder="Search decks..." maxlength="100"
                                class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dull-purple/40">
                        </div>
                        <div id="deckGrid"
                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-3 mt-3 max-h-[400px] sm:max-h-[400px] md:max-h-[240px] lg:max-h-[240px] overflow-y-auto scroll-minimal p-1">
                        </div>
                    </article>

                    <!-- Selected Deck Bar + Cards Section -->
                    <article id="cardsSection"
                        class="card rounded-2xl p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                        <div id="selectedDeckBar" class="flex items-center justify-between gap-2">
                            <h2 class="font-display text-base md:text-lg text-charcoal truncate" id="selectedDeckName">
                                Select a deck above</h2>
                            <div class="flex items-center gap-1 md:gap-2 shrink-0">
                                <button id="resetAlgorithmBtn"
                                    class="p-2 md:px-3 md:py-2 rounded-lg border border-red-300 text-red-600 text-sm hover:bg-red-50 dark:border-red-900 dark:text-red-400 dark:hover:bg-red-900/20 flex items-center gap-2 hidden"
                                    data-tooltip="Reset algorithm parameters">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    <span class="hidden lg:inline">Reset Algorithm</span>
                                </button>
                                <button id="newCardBtn"
                                    class="p-2 md:px-3 md:py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all flex items-center gap-2 hidden"
                                    data-tooltip="New card">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                    <span class="hidden md:inline">New card</span>
                                </button>
                            </div>
                        </div>
                        <!-- Cards content (hidden until deck selected) -->
                        <div id="cardsContent" class="hidden mt-3 md:mt-4">
                            <!-- Card search -->
                            <div class="mb-3">
                                <input id="cardSearchInput" type="text" placeholder="Search cards by name..."
                                    maxlength="200"
                                    class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dull-purple/40">
                            </div>
                            <div id="cardsContainer"
                                class="max-h-[350px] md:max-h-[400px] overflow-y-auto scroll-minimal">
                                <table class="w-full text-xs md:text-sm">
                                    <thead class="text-earth-metal/60 sticky top-0 bg-[color:var(--card-bg)] z-10">
                                        <tr class="border-b border-oatmeal-dark/70">
                                            <th class="py-2 text-left">Name</th>
                                            <th class="py-2 text-left hidden sm:table-cell">Type</th>
                                            <th class="py-2 text-left">Due</th>
                                            <th class="py-2 text-left hidden md:table-cell">Tags</th>
                                            <th class="py-2 text-left w-8 md:w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="cardTable" class="divide-y divide-oatmeal-dark/40"></tbody>
                                </table>
                            </div>
                            <div id="noCardsMessage"
                                class="text-center py-6 md:py-8 text-earth-metal/60 text-xs md:text-sm hidden">
                                No cards in this deck yet. Click "New card" to add one.
                            </div>
                        </div>
                    </article>
                </div>

                <!-- STUDY TAB -->
                <div id="studyTab" class="tab-content">
                    <!-- Centered Study Content -->
                    <div class="max-w-2xl mx-auto space-y-4 md:space-y-6">
                        <!-- Session Active Bar (shown when session is active) -->
                        <div id="sessionActiveBar"
                            class="hidden card rounded-2xl p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                            <div class="flex items-center justify-between gap-3">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="book-open" class="w-5 h-5 text-dull-purple"></i>
                                    <span id="sessionProgressText"
                                        class="text-sm md:text-base text-charcoal font-medium">Session: 0/0</span>
                                </div>
                                <div id="previewBadge"
                                    class="hidden text-[11px] px-2 py-1 rounded-lg bg-amber-100 text-amber-800 border border-amber-200 dark:bg-amber-900/30 dark:text-amber-100 dark:border-amber-600/60">
                                    Preview mode: no scheduling changes
                                </div>
                                <button id="abandonSessionBtn"
                                    class="flex items-center gap-1.5 px-2 md:px-3 py-1.5 rounded-lg text-xs md:text-sm text-earth-metal/70 hover:text-muted-pink hover:bg-muted-pink/10 border border-oatmeal-dark/60 transition whitespace-nowrap">
                                    <i data-lucide="square" class="w-3 h-3"></i>
                                    <span class="hidden md:inline">Stop Session</span>
                                    <span class="md:hidden">Stop</span>
                                    <kbd id="stopSessionHotkey"
                                        class="hidden md:inline text-[10px] ml-1 px-1.5 py-0.5 rounded bg-dull-purple/10 text-dull-purple font-medium"></kbd>
                                </button>
                            </div>
                        </div>

                        <!-- Study Filters Card -->
                        <article id="studySettingsCard"
                            class="card rounded-2xl p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                            <div class="flex items-center justify-between gap-2 mb-3 md:mb-4">
                                <div class="flex items-center gap-2 min-w-0">
                                    <i data-lucide="settings-2" class="w-4 h-4 text-dull-purple shrink-0"></i>
                                    <h2 class="font-display text-base md:text-lg text-charcoal truncate">Study Mode
                                        Settings</h2>
                                </div>
                                <button id="resetFilters"
                                    class="text-xs text-dull-purple hover:underline hidden">Reset</button>
                            </div>

                            <!-- Always visible: Decks + Mode -->
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-earth-metal/70 block mb-2">Study from decks</label>
                                    <div class="relative">
                                        <input id="deckSearchInput" type="text" placeholder="Search decks..."
                                            maxlength="100"
                                            class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dull-purple/40">
                                        <div id="deckDropdown"
                                            class="hidden absolute left-0 right-0 z-50 w-full mt-1 max-h-48 overflow-y-auto rounded-lg border border-oatmeal-dark/60 bg-[color:var(--card-bg)] shadow-lg">
                                        </div>
                                    </div>
                                    <div id="selectedDecksDisplay" class="flex flex-wrap gap-1.5 mt-2"></div>
                                </div>
                                <div>
                                    <label class="text-xs text-earth-metal/70 block mb-2">Revision mode</label>
                                    <select id="revisionMode"
                                        class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm">
                                        <option value="manual">Reveal</option>
                                        <option value="ai">AI</option>
                                    </select>
                                </div>
                                <!-- Session controls -->
                                <div id="sessionControls" class="pt-3">
                                    <button id="startSessionBtn"
                                        class="w-full px-4 py-2.5 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all transition flex items-center justify-center gap-2">
                                        <i data-lucide="play" class="w-4 h-4"></i>
                                        <span>Start Study Session</span>
                                        <kbd id="startSessionHotkey"
                                            class="hidden md:inline-block text-[10px] px-1.5 py-0.5 rounded bg-white/20 font-medium ml-1 font-sans"></kbd>
                                    </button>
                                </div>
                            </div>

                            <!-- More options divider -->
                            <button id="toggleFilters"
                                class="w-full flex items-center justify-center gap-2 mt-4 py-2 text-xs text-earth-metal/60 hover:text-earth-metal transition-colors">
                                <span class="flex-1 h-px bg-[color:var(--card-border)]"></span>
                                <span class="flex items-center gap-1">
                                    <span id="moreOptionsText">More options</span>
                                    <i data-lucide="chevron-down" id="filtersChevron"
                                        class="w-3 h-3 transition-transform"></i>
                                </span>
                                <span class="flex-1 h-px bg-[color:var(--card-border)]"></span>
                            </button>

                            <div id="filtersContent" class="hidden pt-3 md:pt-4">
                                <div class="grid grid-cols-2 gap-2 md:gap-3 text-xs md:text-sm">
                                    <!-- Card selection mode -->
                                    <div class="col-span-2">
                                        <label class="text-xs text-earth-metal/70 block mb-2">Practice cards</label>
                                        <select id="cardSelectionMode"
                                            class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm">
                                            <option value="due">Due cards only</option>
                                            <option value="all">All cards</option>
                                        </select>
                                    </div>
                                    <div id="noScheduleRow" class="col-span-2 hidden">
                                        <label class="flex items-center gap-2 text-xs md:text-sm">
                                            <input id="noScheduleChanges" type="checkbox" class="accent-dull-purple"
                                                checked>
                                            <span>No scheduling changes (preview mode)</span>
                                        </label>
                                        <p class="text-[11px] text-earth-metal/50 dark:text-white/60 mt-1">When on,
                                            ratings won‚Äôt update
                                            due dates or algorithms.</p>
                                    </div>
                                    <label class="flex items-center gap-2">
                                        <input id="filterAgain" type="checkbox" class="accent-dull-purple">
                                        <span>Again recently</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input id="filterHard" type="checkbox" class="accent-dull-purple">
                                        <span>Hard/Again</span>
                                    </label>
                                    <label class="flex items-center gap-2 col-span-2">
                                        <input id="filterAddedToday" type="checkbox" class="accent-dull-purple">
                                        <span>Added today</span>
                                    </label>
                                    <div class="col-span-2">
                                        <label class="text-xs text-earth-metal/70">Tags</label>
                                        <div class="relative">
                                            <input id="filterTagSearch" type="text" placeholder="Search tags"
                                                maxlength="100"
                                                class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm">
                                            <div id="filterTagDropdown"
                                                class="hidden absolute left-0 right-0 z-40 mt-1 max-h-44 overflow-y-auto rounded-lg border border-oatmeal-dark/60 bg-[color:var(--card-bg)] shadow-lg">
                                            </div>
                                        </div>
                                        <div id="filterTagSelected" class="flex flex-wrap gap-1.5 mt-2"></div>
                                    </div>
                                    <label class="flex items-center gap-2">
                                        <input id="filterSuspended" type="checkbox" class="accent-dull-purple">
                                        <span>Hide suspended</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input id="filterLeech" type="checkbox" class="accent-dull-purple">
                                        <span>Hide leeches</span>
                                    </label>
                                    <button id="resetFiltersMobile"
                                        class="col-span-2 sm:hidden text-xs text-dull-purple hover:underline text-center py-2">Reset
                                        all filters</button>
                                </div>
                            </div>
                        </article>
                        <!-- Study Card -->
                        <article id="studyCardSection"
                            class="card rounded-2xl p-4 md:p-5 shadow-soft text-[color:var(--text-main)] hidden">
                            <div class="flex items-center justify-between gap-2">
                                <h2 class="font-display text-base md:text-lg text-charcoal">Study</h2>
                                <div class="flex items-center gap-1">
                                    <button id="addNoteBlock"
                                        class="p-1.5 rounded-lg hover:bg-oatmeal text-dull-purple hidden"
                                        title="Add note to page">
                                        <i data-lucide="file-plus" class="w-4 h-4"></i>
                                    </button>
                                    <button id="copyCardContent"
                                        class="p-1.5 rounded-lg hover:bg-oatmeal text-dull-purple hidden"
                                        title="Copy card content">
                                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="studyCardContent"
                                class="relative mt-3 p-3 md:p-4 rounded-lg bg-[color:var(--surface-strong)] border border-[color:var(--card-border)] space-y-3">
                                <div class="flex items-center justify-between text-xs text-[color:var(--text-sub)]">
                                    <span id="studyDeckLabel" class="truncate">Choose a deck</span>
                                </div>
                                <div id="cardFront"
                                    class="md-content min-h-[100px] md:min-h-[120px] leading-relaxed text-[color:var(--text-main)] max-h-[40vh] md:max-h-[45vh] overflow-y-auto pr-1 scroll-minimal text-sm md:text-base">
                                </div>
                                <div class="space-y-2">
                                    <button id="revealBtn"
                                        class="relative px-3 py-2.5 w-full rounded-lg bg-charcoal dark:bg-white/10 dark:border-white/10 dark:border text-white text-sm hover:bg-earth-metal dark:hover:bg-white/20">
                                        Reveal
                                        <kbd
                                            class="hidden md:inline-block absolute right-3 top-1/2 -translate-y-1/2 text-[10px] px-1.5 py-0.5 rounded bg-white/20 font-medium">‚ê£</kbd>
                                    </button>
                                    <div id="aiControls" class="hidden space-y-2">
                                        <textarea id="aiAnswer" rows="3" placeholder="Type your answer..."
                                            class="w-full rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] px-3 py-2 text-sm"></textarea>
                                        <div class="flex gap-2">
                                            <button id="aiRecord"
                                                class="relative p-2 pr-2 md:pr-8 rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] text-[color:var(--text-main)] text-sm flex flex-1 items-center justify-center"
                                                title="Record">
                                                <i data-lucide="mic" class="w-4 h-4"></i>
                                                <kbd id="micHotkey"
                                                    class="hidden md:inline-block absolute right-2 top-1/2 -translate-y-1/2 text-[10px] px-1 py-0.5 rounded bg-white/20 text-earth-metal/60"></kbd>
                                            </button>
                                            <button id="aiSubmit"
                                                class="px-3 py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all flex-1">
                                                Send <kbd id="aiSendHotkey"
                                                    class="hidden md:inline-block text-[10px] px-1.5 py-0.5 rounded bg-white/20 font-medium ml-1 font-sans"></kbd>
                                            </button>
                                        </div>
                                        <div id="aiFeedback"
                                            class="md-content hidden text-sm text-earth-metal/80 dark:text-white/70 bg-[var(--surface)] dark:bg-white/5 border border-oatmeal-dark/40 dark:border-white/10 rounded-lg p-2">
                                        </div>
                                    </div>
                                </div>
                                <div id="cardBack"
                                    class="md-content leading-relaxed text-[color:var(--text-sub)] hidden max-h-[40vh] md:max-h-[45vh] overflow-y-auto pr-1 scroll-minimal text-sm md:text-base">
                                </div>
                                <!-- Study controls (hidden when session complete) -->
                                <div id="studyControls">
                                    <div class="grid grid-cols-4 gap-1 md:gap-2">
                                        <button data-rate="Again" aria-label="Rate as Again (1)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg bg-red-100 border border-red-300 text-red-700 text-[10px] md:text-xs hover:bg-red-200 dark:bg-red-900/30 dark:border-red-700 dark:text-red-200 dark:hover:bg-red-900/50 flex items-center justify-center gap-1">
                                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                            <span>Again</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-red-600 text-white font-medium shadow-sm">1</kbd>
                                        </button>
                                        <button data-rate="Hard" aria-label="Rate as Hard (2)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg bg-orange-100 border border-orange-300 text-orange-700 text-[10px] md:text-xs hover:bg-orange-200 dark:bg-orange-900/30 dark:border-orange-700 dark:text-orange-200 dark:hover:bg-orange-900/50 flex items-center justify-center gap-1">
                                            <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                                            <span>Hard</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-orange-500 text-white font-medium shadow-sm">2</kbd>
                                        </button>
                                        <button data-rate="Good" aria-label="Rate as Good (3)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg bg-green-100 border border-green-300 text-green-700 text-[10px] md:text-xs hover:bg-green-200 dark:bg-green-900/30 dark:border-green-700 dark:text-green-200 dark:hover:bg-green-900/50 flex items-center justify-center gap-1">
                                            <i data-lucide="thumbs-up" class="w-3 h-3"></i>
                                            <span>Good</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-green-600 text-white font-medium shadow-sm">3</kbd>
                                        </button>
                                        <button data-rate="Easy" aria-label="Rate as Easy (4)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg bg-blue-100 border border-blue-300 text-blue-700 text-[10px] md:text-xs hover:bg-blue-200 dark:bg-blue-900/30 dark:border-blue-700 dark:text-blue-200 dark:hover:bg-blue-900/50 flex items-center justify-center gap-1">
                                            <i data-lucide="zap" class="w-3 h-3"></i>
                                            <span>Easy</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-blue-600 text-white font-medium shadow-sm">4</kbd>
                                        </button>
                                    </div>
                                    <div class="text-[10px] md:text-[11px] text-earth-metal/70 flex justify-end mt-2">
                                        <button id="skipCard"
                                            class="px-2 py-1 rounded-lg border border-oatmeal-dark/50 text-dull-purple hover:bg-dull-purple/10 shrink-0 flex items-center gap-1">
                                            <i data-lucide="square-slash" class="w-3 h-3"></i>
                                            <span>Skip</span>
                                            <kbd id="skipHotkey"
                                                class="hidden md:inline text-[9px] ml-0.5 px-1 py-0.5 rounded bg-dull-purple/10 text-dull-purple font-medium">S</kbd>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Mobile FAB cluster - Joystick and action buttons (only visible on mobile) -->
                        <div id="mobileFabCluster" class="mobile-fab-cluster hidden">
                            <!-- Joystick wrapper with side actions -->
                            <div class="joystick-wrapper">
                                <!-- Arcade-style joystick for rating -->
                                <div id="joystickContainer" class="joystick-container hidden">
                                    <div id="joystick" class="joystick">
                                        <!-- Direction labels with filled icons -->
                                        <!-- Clockwise from bottom: Again (down) ‚Üí Hard (left) ‚Üí Good (up) ‚Üí Easy (right) -->
                                        <div class="joystick-label joystick-label-up">
                                            <i data-lucide="thumbs-up"></i>
                                        </div>
                                        <div class="joystick-label joystick-label-down">
                                            <i data-lucide="refresh-cw"></i>
                                        </div>
                                        <div class="joystick-label joystick-label-left">
                                            <i data-lucide="alert-triangle"></i>
                                        </div>
                                        <div class="joystick-label joystick-label-right">
                                            <i data-lucide="zap"></i>
                                        </div>
                                        <!-- The knob -->
                                        <div class="joystick-knob"></div>
                                    </div>
                                </div>

                                <!-- Side action buttons (next to joystick) -->
                                <div class="joystick-side-actions">
                                    <button id="fabAddNote" class="fab-btn fab-btn-secondary hidden" title="Add note">
                                        <i data-lucide="file-plus"></i>
                                    </button>
                                    <button id="fabCopy" class="fab-btn fab-btn-secondary hidden" title="Copy">
                                        <i data-lucide="clipboard"></i>
                                    </button>
                                    <button id="fabMic" class="fab-btn fab-btn-secondary hidden"
                                        title="Record (AI mode)">
                                        <i data-lucide="mic"></i>
                                    </button>
                                    <button id="fabSend" class="fab-btn fab-btn-secondary hidden"
                                        title="Send (AI mode)">
                                        <i data-lucide="send"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Pre-reveal actions -->
                            <div id="fabPreRevealActions" class="joystick-side-actions">
                                <button id="fabSkip" class="fab-btn fab-btn-secondary" title="Skip">
                                    <i data-lucide="square-slash"></i>
                                </button>
                                <button id="fabReveal" class="fab-btn fab-btn-primary" title="Reveal">
                                    <i data-lucide="eye"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Notes Preview (below study card, no textarea) -->
                        <div id="notesSection"
                            class="rounded-lg border border-[color:var(--card-border)] p-3 md:p-4 bg-[color:var(--card-bg)] hidden">
                            <div class="flex items-center justify-between mb-2 md:mb-3">
                                <span class="font-semibold text-charcoal text-sm md:text-base">Notes</span>
                                <button id="editNotesBtn" class="p-1.5 rounded-lg hover:bg-oatmeal text-dull-purple"
                                    title="Edit notes">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="notesPreview"
                                class="md-content prose prose-sm max-h-60 md:max-h-80 overflow-y-auto text-xs md:text-sm text-[color:var(--text-main)] scroll-minimal">
                                <p class="text-earth-metal/60 text-xs md:text-sm">No notes for this card</p>
                            </div>
                        </div>

                        <!-- Mobile bottom spacer to prevent joystick overlap -->
                        <div class="h-36 md:hidden" aria-hidden="true"></div>
                    </div>
                </div>
            </section>
        </main>
        <footer id="footerAttribution"
            class="hidden px-3 sm:px-5 md:px-10 pb-4 text-[11px] text-earth-metal/60 dark:text-white/60 text-center">
            Built by <a class="underline text-dull-purple dark:text-dull-purple" href="https://mimansajaiswal.github.io"
                target="_blank" rel="noopener noreferrer">Mimansa Jaiswal</a> ¬∑ In the <a
                class="underline text-dull-purple dark:text-dull-purple" href="https://mimansajaiswal.github.io/tools/"
                target="_blank" rel="noopener noreferrer">Tools Made with LLMs</a> ¬∑ Code: <a
                class="underline text-dull-purple dark:text-dull-purple"
                href="https://github.com/mimansajaiswal/tools/tree/main/ghostink-flashcards" target="_blank"
                rel="noopener noreferrer">ghostink-flashcards</a>
        </footer>
    </div>

    <div id="toast" role="status" aria-live="polite"
        class="fixed z-[110] bottom-6 right-6 px-4 py-3 rounded-lg bg-charcoal dark:bg-zinc-800 text-white text-sm shadow-soft hidden opacity-0 transition-opacity duration-300">
    </div>
    <div id="tooltip"
        class="fixed z-[120] px-2.5 py-1.5 rounded-lg text-xs bg-charcoal dark:bg-zinc-800 text-white shadow-soft pointer-events-none hidden">
    </div>

    <!-- Global loading overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 z-[130] bg-black/40 backdrop-blur-sm hidden items-center justify-center">
        <div class="flex flex-col items-center gap-3 text-white text-center px-6">
            <div class="h-12 w-12 border-4 border-white/30 border-t-white rounded-full animate-spin"></div>
            <p id="loadingMessage" class="text-sm font-medium">Loading...</p>
            <p class="text-xs text-white/80" id="loadingSubtext">Preparing your decks and cards.</p>
            <div id="loadingProgressWrap" class="w-full max-w-xs hidden">
                <div class="w-full h-2 bg-white/20 rounded-full overflow-hidden">
                    <div id="loadingProgressBar" class="h-2 bg-dull-purple w-0 transition-all duration-300"></div>
                </div>
                <p id="loadingProgressText" class="text-[11px] text-white/80 mt-1">0%</p>
            </div>
            <button id="loadingCancelBtn"
                class="hidden mt-2 px-4 py-2 text-xs bg-white/10 hover:bg-white/20 rounded-lg transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="card rounded-2xl p-5 w-full max-w-sm shadow-soft">
            <p id="confirmModalTitle" class="text-charcoal dark:text-white font-display text-lg mb-2">Confirm delete</p>
            <p class="text-sm text-earth-metal/70 dark:text-white/70">This removes it locally and syncs deletion to
                Notion.</p>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancelDelete"
                    class="px-3 py-2 rounded-lg bg-white-linen border border-oatmeal-dark/70 text-earth-metal dark:text-white text-sm dark:bg-zinc-800 dark:border-white/10 dark:hover:bg-zinc-700">Cancel</button>
                <button id="confirmDelete"
                    class="px-3 py-2 rounded-lg bg-muted-pink text-white text-sm hover:bg-muted-pink-hover transition-all">Delete</button>
            </div>
        </div>
    </div>

    <!-- Reset Algorithm Confirmation Modal -->
    <div id="resetAlgorithmModal" role="dialog" aria-modal="true" aria-labelledby="resetAlgorithmTitle"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="card rounded-2xl p-5 w-full max-w-md shadow-soft">
            <div class="flex items-center gap-3 mb-3">
                <div class="p-2 rounded-full bg-red-100 dark:bg-red-900/40">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                </div>
                <h3 id="resetAlgorithmTitle" class="text-charcoal font-display text-lg">Reset Algorithm Parameters</h3>
            </div>
            <div class="space-y-3 text-sm text-earth-metal/80 dark:text-white/75">
                <p>This will reset <strong>all spaced repetition data</strong> for every card in <span
                        id="resetDeckName" class="font-semibold text-charcoal">this deck</span>:</p>
                <ul class="list-disc list-inside space-y-1 text-earth-metal/70 ml-2">
                    <li>Due dates will be cleared</li>
                    <li>Ease factors, intervals, and stability will reset</li>
                    <li>Review history will be preserved</li>
                    <li>Cards will appear as new again</li>
                </ul>
                <div
                    class="p-3 rounded-lg bg-amber-50 border border-amber-200 dark:bg-amber-900/30 dark:border-amber-600/60 flex items-start gap-2">
                    <i data-lucide="cloud-upload" class="w-4 h-4 text-amber-600 mt-0.5 shrink-0"></i>
                    <p class="text-amber-800 dark:text-amber-100 text-xs">These changes will be synced to Notion. This
                        action cannot be
                        undone.</p>
                </div>
                <div id="resetProgressContainer" class="hidden mt-4 space-y-1">
                    <div class="flex justify-between text-xs text-earth-metal/70 dark:text-white/70">
                        <span id="resetProgressText">Resetting...</span>
                        <span id="resetProgressPercent">0%</span>
                    </div>
                    <div class="h-1.5 bg-oatmeal-dark/30 dark:bg-white/10 rounded-full overflow-hidden">
                        <div id="resetProgressBar" class="h-full bg-red-500 transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button id="cancelResetAlgorithm"
                    class="px-4 py-2 rounded-lg bg-white-linen border border-oatmeal-dark/70 text-earth-metal text-sm hover:bg-oatmeal">Cancel</button>
                <button id="confirmResetAlgorithm"
                    class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm hover:bg-red-700 flex items-center gap-2">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    Reset All Cards
                </button>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
        <div id="settingsCard" class="card rounded-2xl p-5 w-full max-w-3xl shadow-soft max-h-[90vh] overflow-y-auto">
            <div class="sticky top-[-20px] pt-[20px] -mt-[20px] z-20 bg-[color:var(--surface)] pb-2 space-y-3">
                <div class="flex items-center justify-between">
                    <h3 id="settingsTitle" class="font-display text-lg text-charcoal">Settings</h3>
                    <div class="flex items-center gap-2">
                        <button id="saveSettings"
                            class="px-3 py-1.5 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:bg-dull-purple">Save</button>
                        <button id="closeSettings" aria-label="Close settings"
                            class="text-earth-metal/60 hover:text-charcoal"><i data-lucide="x"
                                class="w-5 h-5"></i></button>
                    </div>
                </div>
                <!-- Combined Sticky Header: Status + Vault -->
                <div class="space-y-3">
                    <!-- Status bar -->
                    <div
                        class="rounded-lg border border-oatmeal-dark/60 dark:border-white/10 p-3 bg-[color:var(--surface-strong)]">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="shield-check"
                                    class="w-4 h-4 text-dull-purple dark:text-dull-purple"></i>
                                <p class="font-semibold text-charcoal dark:text-white text-sm">Status</p>
                            </div>
                            <div id="q2syncIndicator"
                                class="hidden items-center gap-1.5 px-2 py-0.5 rounded bg-dull-purple/10 border border-dull-purple/20">
                                <span class="relative flex h-1.5 w-1.5">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[color:var(--dull-purple)] opacity-75"></span>
                                    <span
                                        class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[color:var(--dull-purple)]"></span>
                                </span>
                                <span class="font-mono text-[10px] font-medium text-dull-purple"><span
                                        id="q2syncCount">0</span> items in q2sync</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 text-xs text-earth-metal/80 dark:text-white/70">
                            <span id="statusWorker">Worker: missing</span>
                            <span id="statusAuth">Auth: missing</span>
                            <span id="statusSources">Sources: missing</span>
                        </div>
                    </div>
                    <!-- Offline vault (shown only when setup) -->
                    <div id="vaultStatusSection" class="hidden">
                        <div
                            class="rounded-lg border border-oatmeal-dark/60 dark:border-white/10 p-3 bg-white-linen dark:bg-white/5">
                            <div class="flex items-center gap-2">
                                <i data-lucide="database" class="w-4 h-4 text-dull-purple dark:text-dull-purple"></i>
                                <p class="font-semibold text-charcoal dark:text-white text-sm">Offline vault</p>
                            </div>
                            <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                                <div class="rounded-lg bg-oatmeal dark:bg-white/10 p-3">
                                    <p
                                        class="text-earth-metal/60 dark:text-white/60 text-[10px] uppercase tracking-wider font-semibold">
                                        Decks cached</p>
                                    <p id="deckCount" class="text-xl font-semibold text-charcoal dark:text-white">0</p>
                                </div>
                                <div class="rounded-lg bg-oatmeal dark:bg-white/10 p-3">
                                    <p
                                        class="text-earth-metal/60 dark:text-white/60 text-[10px] uppercase tracking-wider font-semibold">
                                        Cards cached</p>
                                    <p id="cardCount" class="text-xl font-semibold text-charcoal dark:text-white">0</p>
                                </div>
                                <div
                                    class="rounded-lg bg-white-linen dark:bg-white/10 p-3 border border-oatmeal-dark/40">
                                    <p
                                        class="text-earth-metal/60 dark:text-white/60 text-[10px] uppercase tracking-wider font-semibold">
                                        Pending sync</p>
                                    <p id="queueCount" class="text-xl font-semibold text-charcoal dark:text-white">0</p>
                                </div>
                                <div
                                    class="rounded-lg bg-white-linen dark:bg-white/10 p-3 border border-oatmeal-dark/40">
                                    <p
                                        class="text-earth-metal/60 dark:text-white/60 text-[10px] uppercase tracking-wider font-semibold">
                                        Last sync</p>
                                    <p id="lastSync"
                                        class="text-sm font-semibold text-charcoal dark:text-white truncate mt-1">‚Äî</p>
                                </div>
                            </div>
                            <p class="mt-3 text-[10px] text-earth-metal/60 dark:text-white/60">IndexedDB holds all
                                decks/cards/FSRS/notes for offline-first use.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 text-sm mt-4">
                <div class="space-y-4">
                    <!-- Worker Proxy Accordion -->
                    <details id="workerSettingsDetails" class="group" open>
                        <summary
                            class="flex items-center gap-2 font-display text-base text-charcoal dark:text-white cursor-pointer select-none py-1 mb-2 hover:text-dull-purple transition-colors list-none outline-none">
                            <i data-lucide="chevron-right"
                                class="w-4 h-4 transition-transform group-open:rotate-90"></i>
                            <span>Worker Proxy</span>
                        </summary>
                        <div class="space-y-4 pl-2 border-l-2 border-oatmeal-dark/10 dark:border-white/5 ml-1.5">
                            <div
                                class="rounded-lg border border-oatmeal-dark/60 dark:border-white/10 p-3 bg-white-linen dark:bg-white/5">
                                <div class="flex items-center justify-between">
                                    <p class="font-semibold text-charcoal dark:text-white text-sm">Configuration</p>
                                    <button id="openWorkerHelp"
                                        class="px-3 py-1.5 rounded-full bg-oatmeal text-earth-metal text-xs border border-oatmeal-dark/70 flex items-center gap-2">
                                        <i data-lucide="code" class="w-4 h-4"></i> Worker code
                                    </button>
                                </div>
                                <p class="text-xs text-earth-metal/70 dark:text-white/70 mt-1">Add Cloudflare Worker URL
                                    even if you plan to sign in with Notion.</p>
                            </div>
                            <div>
                                <label class="text-xs text-earth-metal/70">Cloudflare Worker URL</label>
                                <input id="settingWorkerUrl" type="text" placeholder="https://your-proxy.workers.dev"
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                            </div>
                            <div>
                                <label class="text-xs text-earth-metal/70">Proxy token (optional)</label>
                                <input id="settingProxyToken" type="password" placeholder="ALL_CORS_PROXY_MATCH_TOKEN"
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                            </div>
                            <button id="verifyWorker"
                                class="px-3 py-2 rounded-lg bg-oatmeal text-earth-metal text-sm border border-oatmeal-dark/70 w-full">Verify
                                worker</button>
                        </div>
                    </details>

                    <!-- Notion Integration Accordion -->
                    <details id="notionSettingsDetails" class="group" open>
                        <summary
                            class="flex items-center gap-2 font-display text-base text-charcoal dark:text-white cursor-pointer select-none py-1 mb-2 hover:text-dull-purple transition-colors list-none outline-none">
                            <i data-lucide="chevron-right"
                                class="w-4 h-4 transition-transform group-open:rotate-90"></i>
                            <span>Notion Integration</span>
                        </summary>
                        <div class="space-y-4 pl-2 border-l-2 border-oatmeal-dark/10 dark:border-white/5 ml-1.5">
                            <div class="text-sm text-earth-metal/70 dark:text-white/70 mb-2">
                                Please duplicate this <a
                                    href="https://mimansajaiswal-embedded-dbs.notion.site/ghostink-template"
                                    target="_blank" rel="noopener noreferrer"
                                    class="text-dull-purple hover:underline font-medium inline-flex items-center gap-0.5 align-baseline">Template</a><br>
                                <div class="text-xs text-earth-metal/40 dark:text-white/40 mb-2">
                                    If using custom, ensure all property names and options match exactly
                                    (case-sensitive); extra properties are allowed.
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-earth-metal/70">Notion integration secret (instead of
                                    OAuth)</label>
                                <input id="settingAuthToken" type="password" placeholder="secret_..."
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 disabled:opacity-60 disabled:cursor-not-allowed">
                            </div>
                            <button id="verifyAuth"
                                class="px-3 py-2 rounded-lg bg-oatmeal text-earth-metal text-sm border border-oatmeal-dark/70 w-full disabled:opacity-60 disabled:cursor-not-allowed">Verify
                                Notion token</button>
                            <button id="oauthBtn"
                                class="w-full px-3 py-2 rounded-lg border border-dull-purple text-dull-purple text-sm hover:bg-oatmeal flex items-center gap-2 justify-center disabled:opacity-60 disabled:cursor-not-allowed">
                                <i data-lucide="log-in" class="w-4 h-4"></i>Sign in with Notion
                            </button>
                            <div>
                                <label class="text-xs text-earth-metal/60">Decks source</label>
                                <select id="deckSourceSelect" disabled
                                    class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm disabled:opacity-60 disabled:cursor-not-allowed"></select>
                            </div>
                            <div>
                                <label class="text-xs text-earth-metal/60">Cards source</label>
                                <select id="cardSourceSelect" disabled
                                    class="w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm disabled:opacity-60 disabled:cursor-not-allowed"></select>
                            </div>
                            <div class="flex gap-2">
                                <button id="scanSources" disabled
                                    class="w-1/3 px-3 py-2 rounded-lg bg-charcoal dark:bg-white/10 dark:border-white/10 dark:border text-white text-sm hover:bg-earth-metal dark:hover:bg-white/20 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:bg-charcoal">Scan</button>
                                <button id="saveSourcesChoice" disabled
                                    class="w-2/3 px-3 py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Save selection
                                </button>
                            </div>
                            <div class="w-full h-2 bg-oatmeal dark:bg-white/10 rounded-full overflow-hidden">
                                <div id="syncProgress" class="h-2 bg-dull-purple w-0 transition-all duration-500"></div>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="space-y-4">
                    <div
                        class="sm:hidden rounded-lg border border-oatmeal-dark/60 dark:border-white/10 p-3 bg-white-linen dark:bg-white/5">
                        <div class="flex items-center justify-between gap-2 mb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="smartphone" class="w-4 h-4 text-dull-purple dark:text-dull-purple"></i>
                                <p class="font-semibold text-charcoal dark:text-white">Mobile layout</p>
                            </div>
                        </div>
                        <p class="text-[11px] text-earth-metal/60 dark:text-white/60">Choose where the study
                            joystick/action cluster should appear on mobile screens.</p>
                        <div class="mt-3 space-y-2">
                            <label class="flex items-center gap-2 text-xs text-earth-metal/70 dark:text-white/70">
                                <input id="fabEnabledToggle" type="checkbox" class="accent-dull-purple" checked>
                                <span>Enable mobile FAB controls</span>
                            </label>
                            <div id="fabPosControls" class="space-y-2">
                                <label class="text-xs text-earth-metal/70 dark:text-white/70">FAB position
                                    (grid)</label>
                                <div class="flex items-center gap-2">
                                    <select id="fabPosCellSelect"
                                        class="flex-1 rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                    </select>
                                    <span
                                        class="text-[10px] text-earth-metal/60 dark:text-white/60 whitespace-nowrap">3√ó5
                                        + border</span>
                                </div>
                                <pre id="fabGridAscii"
                                    class="font-mono text-[8px] leading-[1.05] text-earth-metal/60 dark:text-white/60 bg-oatmeal/60 dark:bg-white/10 border border-oatmeal-dark/40 dark:border-white/10 rounded-lg p-2 overflow-hidden whitespace-pre"></pre>
                                <p class="text-[10px] text-earth-metal/60 dark:text-white/60">Pick a number from the
                                    grid
                                    (1 = top-left, 15 = bottom-right). Applies on screens ‚â§ 640px wide.</p>
                            </div>
                        </div>
                    </div>
                    <div
                        class="rounded-lg border border-oatmeal-dark/60 dark:border-white/10 p-3 bg-white-linen dark:bg-white/5">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="bot" class="w-4 h-4 text-dull-purple dark:text-dull-purple"></i>
                            <p class="font-semibold text-charcoal dark:text-white">AI judge settings</p>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-earth-metal/70">Provider</label>
                                <select id="aiProvider"
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm">
                                    <option value="">Disabled</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Claude</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                            </div>
                            <div id="aiProviderFields" class="space-y-2 hidden">
                                <div>
                                    <label class="text-xs text-earth-metal/70">Model</label>
                                    <input id="aiModel" type="text"
                                        placeholder="gpt-4o-mini / claude-3-haiku / gemini-1.5-flash"
                                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm">
                                </div>
                                <input id="aiKey" type="password" placeholder="API key (kept locally)"
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm">
                                <button id="verifyAi" data-tip="Requires internet"
                                    class="px-3 py-2 rounded-lg bg-oatmeal text-earth-metal text-sm border border-oatmeal-dark/70 w-full">Verify
                                    AI settings</button>
                                <p class="text-[11px] text-earth-metal/60">Keys stay on-device (localStorage). AI
                                    judging
                                    only runs if verified.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Speech-to-Text Settings (only shown when AI mode is enabled) -->
                    <div id="sttSettings" class="rounded-lg border border-oatmeal-dark/60 p-3 bg-white-linen hidden">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="mic" class="w-4 h-4 text-dull-purple"></i>
                            <p class="font-semibold text-charcoal">Speech-to-text</p>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-earth-metal/70">Provider</label>
                                <select id="sttProvider"
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm">
                                    <option value="">Disabled</option>
                                    <option value="browser">Browser</option>
                                    <option value="openai">OpenAI Whisper</option>
                                    <option value="gemini">Gemini</option>
                                    <option value="groq">Groq Whisper</option>
                                </select>
                            </div>
                            <div id="sttProviderFields" class="space-y-2 hidden">
                                <div>
                                    <label class="text-xs text-earth-metal/70">Model</label>
                                    <input id="sttModel" type="text" placeholder="whisper-1 / gemini-2.0-flash"
                                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-2 py-2 text-sm">
                                </div>
                                <input id="sttKey" type="password" placeholder="API key (required for cloud providers)"
                                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm">
                                <div>
                                    <label class="text-xs text-earth-metal/70">Starter prompt (optional context)</label>
                                    <input id="sttPrompt" type="text" placeholder="e.g., Technical terms, names..."
                                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm mt-1">
                                </div>
                                <button id="verifyStt" data-tip="Requires internet"
                                    class="px-3 py-2 rounded-lg bg-oatmeal text-earth-metal text-sm border border-oatmeal-dark/70 w-full">Verify
                                    STT settings</button>
                            </div>
                            <p class="text-[11px] text-earth-metal/60">Browser uses free built-in speech recognition.
                                Cloud providers offer better accuracy.</p>
                            <p class="text-[10px] text-earth-metal/50 dark:text-white/50 mt-1">
                                <i data-lucide="info" class="w-3 h-3 inline-block align-text-bottom mr-0.5"></i>
                                Browser STT requires Chrome/Edge. Safari/Firefox have limited support.
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Danger Zone spanning both columns -->
                <div class="md:col-span-2 mt-4 border-t border-oatmeal-dark/40 dark:border-white/10 pt-4">
                    <button id="toggleDangerZone"
                        class="w-full flex items-center justify-between text-sm text-muted-pink dark:text-muted-pink/80 hover:text-muted-pink/80 transition">
                        <span class="flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            <span>Danger Zone</span>
                        </span>
                        <i data-lucide="chevron-down" id="dangerZoneChevron" class="w-4 h-4 transition-transform"></i>
                    </button>
                    <div id="dangerZoneContent"
                        class="hidden mt-3 p-3 rounded-lg bg-muted-pink/10 border border-muted-pink/30 dark:bg-muted-pink/15 dark:border-muted-pink/40">
                        <p class="text-xs text-earth-metal/70 dark:text-white/70 mb-3">This will permanently delete
                            all GhostInk data
                            including decks, cards, settings, and session data. Data synced to Notion will not be
                            affected.</p>
                        <button id="resetApp"
                            class="px-3 py-2 rounded-lg bg-muted-pink text-white text-sm hover:bg-muted-pink-hover transition-all w-full">Reset
                            GhostInk</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Worker helper -->
    <div id="workerHelpModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="card rounded-2xl p-5 w-full max-w-3xl shadow-soft h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-display text-lg text-charcoal">Cloudflare Worker proxy</h3>
                <button id="closeWorkerHelp" class="text-earth-metal/60 hover:text-charcoal"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 text-sm text-earth-metal">
                <p>Deploy this Worker to bypass CORS and forward Notion requests.</p>
                <ol class="list-decimal pl-6 space-y-2">
                    <li>Open <a class="text-dull-purple underline" href="https://workers.cloudflare.com/"
                            target="_blank">Cloudflare Workers</a> and create a new Worker.</li>
                    <li>Replace its contents with the code below, save, and deploy.</li>
                    <li>(Optional) Add variable <code>ALL_CORS_PROXY_MATCH_TOKEN</code> to require a token.</li>
                    <li>Paste the Worker URL into Settings.</li>
                </ol>
                <div class="relative">
                    <button id="copyWorkerCode"
                        class="absolute top-2 right-2 bg-white/80 hover:bg-white px-2 py-1 rounded text-xs shadow text-charcoal font-bold dark:bg-white/10 dark:hover:bg-white/20 dark:text-white">Copy</button>
                    <pre id="workerCodeBlock"
                        class="bg-charcoal text-white-linen p-4 rounded text-xs font-mono overflow-x-auto">
export default {
  async fetch(request, env) {
      return await handleRequest(request, env);
  },
};

function getCorsHeaders(request) {
  return {
      "Access-Control-Allow-Origin": request.headers.get("Origin") || "*",
      "Access-Control-Allow-Methods": "GET, HEAD, POST, PUT, PATCH, DELETE, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization, Notion-Version",
  };
}

function handleOptions(request) {
  return new Response(null, {
      headers: getCorsHeaders(request),
  });
}

function withCors(request, response) {
  const corsHeaders = getCorsHeaders(request);
  const newResponse = new Response(response.body, response);
  for (const [key, value] of Object.entries(corsHeaders)) {
      newResponse.headers.set(key, value);
  }
  newResponse.headers.append("Vary", "Origin");
  return newResponse;
}

async function handleRequest(request, env) {
  if (request.method === "OPTIONS") {
      return handleOptions(request);
  }

  const url = new URL(request.url);
  const requiredToken = (env.ALL_CORS_PROXY_MATCH_TOKEN || "").trim();

  if (requiredToken !== "") {
      const providedToken = url.searchParams.get("token");
      if (providedToken !== requiredToken) {
          return withCors(request, new Response("Unauthorized", { status: 403 }));
      }
      url.searchParams.delete("token");
  }

  const targetUrlParam = url.searchParams.get("url");
  if (!targetUrlParam) {
      return withCors(request, new Response("Missing url parameter", { status: 400 }));
  }

  let targetUrl;
  try {
      targetUrl = new URL(targetUrlParam).toString();
  } catch (err) {
      return withCors(request, new Response("Invalid target URL", { status: 400 }));
  }

  const modifiedRequest = new Request(targetUrl, request);
  modifiedRequest.headers.set("Origin", new URL(targetUrl).origin);

  const response = await fetch(modifiedRequest);
  return withCors(request, response);
}
                    </pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Deck modal -->
    <div id="deckModal" role="dialog" aria-modal="true" aria-labelledby="deckModalTitle"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="card rounded-2xl p-5 w-full max-w-md shadow-soft max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-display text-lg text-charcoal" id="deckModalTitle">New deck</h3>
                <button id="closeDeckModal" aria-label="Close deck modal"
                    class="text-earth-metal/60 hover:text-charcoal"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-3 text-sm">
                <input id="deckNameInput" type="text" placeholder="Deck name" maxlength="200"
                    class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                <div>
                    <label class="text-xs text-earth-metal/70">Algorithm</label>
                    <select id="deckAlgoInput"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                        <option>SM-2</option>
                        <option>FSRS</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-earth-metal/70">Daily review limit</label>
                        <input id="deckReviewLimit" type="number"
                            class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"
                            value="50">
                    </div>
                    <div>
                        <label class="text-xs text-earth-metal/70">New card limit</label>
                        <input id="deckNewLimit" type="number"
                            class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"
                            value="20">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-earth-metal/70">Order mode</label>
                    <select id="deckOrderMode"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                        <option value="none">None (shuffle)</option>
                        <option value="created">Created Time</option>
                        <option value="property">Order Property</option>
                    </select>
                    <p class="text-[11px] text-earth-metal/60">Created time sorts by insertion time; Order property
                        sorts by each card‚Äôs ‚ÄúOrder‚Äù number.</p>
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <input id="deckReverseInput" type="checkbox" class="accent-dull-purple">
                    <span>Reverse mode enabled</span>
                </label>
                <div>
                    <label class="text-xs text-earth-metal/70">AI revision prompt (optional)</label>
                    <textarea id="deckPromptInput" rows="3"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"
                        placeholder="Use {{question}} {{answer}} {{user}} placeholders"></textarea>
                    <div class="flex flex-wrap gap-2 mt-2 text-[11px] text-earth-metal/60 dark:text-white/70">
                        <span
                            class="px-2 py-1 rounded-lg bg-oatmeal-dark/50 dark:bg-white/10 italic text-dull-purple dark:text-dull-purple">{{question}}</span>
                        <span
                            class="px-2 py-1 rounded-lg bg-oatmeal-dark/50 dark:bg-white/10 italic text-dull-purple dark:text-dull-purple">{{answer}}</span>
                        <span
                            class="px-2 py-1 rounded-lg bg-oatmeal-dark/50 dark:bg-white/10 italic text-dull-purple dark:text-dull-purple">{{user}}</span>
                    </div>
                    <p class="mt-2 text-[11px] text-earth-metal/70 dark:text-white/70">Variables replace question,
                        correct answer, and learner answer.</p>
                </div>
                <div id="fsrsParamsField" class="hidden">
                    <div class="grid grid-cols-2 gap-3 items-end">
                        <div>
                            <label class="text-xs text-earth-metal/70">FSRS desired retention</label>
                            <input id="deckFsrsDesiredRetention" type="number" step="0.01" min="0.01" max="0.99"
                                class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-xs font-mono"
                                placeholder="0.90">
                        </div>
                    </div>
                    <label class="text-xs text-earth-metal/70 mt-2 block">FSRS v6 weights (21 numbers)</label>
                    <textarea id="deckFsrsParams" rows="2"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-xs font-mono"
                        placeholder="0.212, 1.2931, ..."></textarea>
                    <div class="flex items-center justify-between gap-2 mt-2">
                        <button id="optimizeFsrsBtn"
                            class="px-3 py-2 rounded-lg border border-earth-metal/40 text-earth-metal text-xs hover:bg-oatmeal/50 dark:hover:bg-white/10">
                            Optimize FSRS weights
                        </button>
                        <span class="text-[10px] text-earth-metal/60">Uses this deck‚Äôs review history</span>
                    </div>
                    <p class="text-[10px] text-earth-metal/60 mt-1">Leave retention empty to use 0.90. Leave weights
                        empty to use defaults. These also sync via the Notion ‚ÄúFSRS Params‚Äù property (rich_text).</p>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="archiveDeckBtn"
                    class="px-3 py-2 rounded-lg border border-earth-metal/40 text-earth-metal text-sm hidden">Archive
                    deck</button>
                <button id="saveDeckBtn"
                    class="px-4 py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all">Save</button>
            </div>
        </div>
    </div>

    <!-- Card modal -->
    <div id="cardModal" role="dialog" aria-modal="true" aria-labelledby="cardModalTitle"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="card rounded-2xl p-5 w-full max-w-2xl shadow-soft max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-display text-lg text-charcoal" id="cardModalTitle">New card</h3>
                <button id="closeCardModal" aria-label="Close card modal"
                    class="text-earth-metal/60 hover:text-charcoal"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <p class="text-[10px] text-earth-metal/50 dark:text-white/60 mb-2">Editing Name, Back, or Notes will remove
                Notion text colors
                and highlights on sync</p>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div class="space-y-2">
                    <label class="text-xs text-earth-metal/70">Deck</label>
                    <select id="cardDeckInput"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-earth-metal/70">Card type</label>
                    <select id="cardTypeInput"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                        <option value="Front-Back">Front / Back</option>
                        <option value="Cloze">Cloze</option>
                    </select>
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="text-xs text-earth-metal/70">Name</label>
                    <textarea id="cardNameInput" rows="3"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"></textarea>
                </div>
                <div id="cardBackSection" class="md:col-span-2 space-y-2">
                    <label class="text-xs text-earth-metal/70">Back</label>
                    <textarea id="cardBackInput" rows="4"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"></textarea>
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="text-xs text-earth-metal/70">Notes (markdown)</label>
                    <textarea id="cardNotesInput" rows="3" placeholder="Add notes for this card..."
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2"></textarea>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="text-xs text-earth-metal/70">Tags</label>
                        <button id="refreshTagOptionsBtn" class="p-1 rounded-lg hover:bg-oatmeal text-dull-purple"
                            title="Refresh tags from Notion">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <input id="cardTagSearch" type="text" placeholder="Search or add tag" maxlength="100"
                            class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm">
                        <div id="cardTagDropdown"
                            class="hidden absolute left-0 right-0 z-40 mt-1 max-h-44 overflow-y-auto rounded-lg border border-oatmeal-dark/60 bg-[color:var(--card-bg)] shadow-lg">
                        </div>
                    </div>
                    <div id="cardTagSelected" class="flex flex-wrap gap-1.5 mt-1"></div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-earth-metal/70">Order</label>
                    <input id="cardOrderInput" type="number" placeholder="Optional number"
                        class="w-full rounded-lg border border-oatmeal-dark/70 bg-[var(--surface)] dark:bg-white/5 px-3 py-2">
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-earth-metal/70">Suspended / Leech</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2"><input id="cardSuspendedInput" type="checkbox"
                                class="accent-dull-purple"> Suspended</label>
                        <label class="flex items-center gap-2"><input id="cardLeechInput" type="checkbox"
                                class="accent-dull-purple"> Leech</label>
                    </div>
                </div>
            </div>
            <!-- Review History Section (shown when editing existing card) -->
            <div id="cardReviewHistorySection" class="mt-4 hidden">
                <details class="group">
                    <summary class="text-xs text-earth-metal/70 cursor-pointer select-none flex items-center gap-1">
                        <i data-lucide="chevron-right" class="w-3 h-3 group-open:rotate-90 transition-transform"></i>
                        Review History (<span id="cardReviewHistoryCount">0</span>)
                    </summary>
                    <div id="cardReviewHistoryTable"
                        class="mt-2 max-h-40 overflow-y-auto border border-charcoal/10 rounded-lg"></div>
                </details>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="deleteCardBtn"
                    class="px-3 py-2 rounded-lg border border-muted-pink text-muted-pink text-sm hidden">Delete
                    card</button>
                <button id="saveCardBtn"
                    class="px-4 py-2 rounded-lg bg-charcoal dark:bg-white/10 dark:border-white/10 dark:border text-white text-sm hover:bg-earth-metal dark:hover:bg-white/20">Save</button>
            </div>
        </div>
    </div>

    <!-- AI Settings Required Modal -->
    <div id="aiSettingsRequiredModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div
            class="card rounded-2xl p-5 w-full max-w-md shadow-soft text-center space-y-4 bg-[color:var(--card-bg)] border border-[color:var(--card-border)]">
            <div class="w-12 h-12 rounded-full bg-dull-purple/20 flex items-center justify-center mx-auto">
                <i data-lucide="bot" class="w-6 h-6 text-dull-purple"></i>
            </div>
            <h3 id="aiSettingsModalTitle" class="font-display text-lg text-charcoal dark:text-white">AI not available
            </h3>
            <p id="aiSettingsModalBody" class="text-sm text-earth-metal/70 dark:text-white/70"></p>
            <div id="aiSettingsModalActions" class="flex gap-2 justify-center">
                <button id="closeAiSettingsModal"
                    class="px-4 py-2 rounded-lg border border-oatmeal-dark text-earth-metal dark:text-white dark:border-white/10 text-sm">Close</button>
                <button id="openSettingsFromAiModal"
                    class="px-4 py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all">Open
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- Notes Edit Modal -->
    <div id="notesModal" role="dialog" aria-modal="true" aria-labelledby="notesModalTitle"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="card rounded-2xl p-5 w-full max-w-lg shadow-soft space-y-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between">
                <h3 id="notesModalTitle" class="font-display text-lg text-charcoal">Edit Notes</h3>
                <button id="closeNotesModal" aria-label="Close notes modal"
                    class="p-1.5 rounded-lg hover:bg-oatmeal text-earth-metal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-xs text-earth-metal/70 dark:text-white/70">Write notes in Markdown format. They will be
                synced to Notion.</p>
            <textarea id="notesArea" rows="12"
                class="flex-1 w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm font-mono resize-none focus:outline-none focus:ring-2 focus:ring-dull-purple/40"
                placeholder="Add notes for this card..."></textarea>
            <div class="flex items-center justify-between">
                <span id="noteStatus" class="text-xs text-earth-metal/60"></span>
                <div class="flex gap-2">
                    <button id="cancelNotesBtn"
                        class="px-4 py-2 rounded-lg border border-oatmeal-dark text-earth-metal text-sm">Cancel</button>
                    <button id="saveNotesBtn"
                        class="px-4 py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetConfirmModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="card rounded-2xl p-5 w-full max-w-sm shadow-soft">
            <div class="flex items-center gap-3 mb-3">
                <div class="p-2 rounded-full bg-muted-pink/20">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-muted-pink"></i>
                </div>
                <h3 class="font-display text-lg text-charcoal">Reset GhostInk?</h3>
            </div>
            <p class="text-sm text-earth-metal/70 dark:text-white/70 mb-4">This will permanently delete all local data
                including decks,
                cards, settings, and study session. This cannot be undone.</p>
            <div class="flex justify-end gap-2">
                <button id="cancelReset"
                    class="px-4 py-2 rounded-lg border border-oatmeal-dark text-earth-metal dark:text-white dark:border-white/10 dark:hover:bg-zinc-800 text-sm">Cancel</button>
                <button id="confirmReset"
                    class="px-4 py-2 rounded-lg bg-muted-pink text-white text-sm hover:bg-muted-pink-hover transition-all">Reset</button>
            </div>
        </div>
    </div>

    <!-- Add Block Note Modal -->
    <div id="addBlockModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center p-4 z-50">
        <div class="card rounded-2xl p-5 w-full max-w-lg shadow-soft space-y-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between">
                <h3 class="font-display text-lg text-charcoal">Add Note to Page</h3>
                <button id="closeAddBlockModal" class="p-1.5 rounded-lg hover:bg-oatmeal text-earth-metal">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-xs text-earth-metal/70 dark:text-white/70">This will be appended as a new paragraph on the
                Notion page with a
                timestamp.</p>
            <textarea id="blockNoteArea" rows="8"
                class="flex-1 w-full rounded-lg border border-oatmeal-dark/60 bg-[var(--surface)] dark:bg-white/5 px-3 py-2 text-sm font-mono resize-none focus:outline-none focus:ring-2 focus:ring-dull-purple/40"
                placeholder="Write in Markdown..."></textarea>
            <div
                class="rounded-lg border border-[color:var(--card-border)] p-3 bg-[color:var(--surface)] dark:bg-white/5">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold text-charcoal dark:text-white">Preview</span>
                    <span class="text-[11px] text-earth-metal/60 dark:text-white/60">Timestamp added on save</span>
                </div>
                <div id="blockNotePreview"
                    class="md-content text-xs text-[color:var(--text-main)] max-h-40 overflow-y-auto scroll-minimal">
                    <p class="text-earth-metal/50 dark:text-white/60">Type a note to preview media embeds.</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2">
                <button id="cancelAddBlockBtn"
                    class="px-4 py-2 rounded-lg border border-oatmeal-dark text-earth-metal text-sm">Cancel</button>
                <button id="saveAddBlockBtn"
                    class="px-4 py-2 rounded-lg bg-dull-purple text-white text-sm hover:bg-dull-purple-hover transition-all">Add
                    to
                    Page</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { App } from './js/app.js';
        import { toast } from './js/ui/index.js';

        document.addEventListener('DOMContentLoaded', async () => {
            document.body.classList.remove('preinit');
            try {
                await App.init();
            } catch (e) {
                console.error('Failed to initialize GhostInk', e);
                toast('Startup failed ‚Äì see console for details');
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => { });
            });
        }
    </script>
</body>

</html>