<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GhostInk Flashcards</title>
    <meta name="theme-color" content="#917FB3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="icons/icon-96.png" sizes="96x96">

    <!-- Preconnect hints for CDN domains -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>

    <!-- Tailwind config must be defined before loading the CDN script -->
    <script>
        tailwind = {
            config: {
                darkMode: ['class', '[data-theme="dark"]'],
                theme: {
                    extend: {
                        colors: {
                            oatmeal: {
                                DEFAULT: 'rgb(var(--oatmeal-rgb) / <alpha-value>)',
                                dark: 'rgb(var(--oatmeal-dark-rgb) / <alpha-value>)',
                                hover: 'rgb(var(--oatmeal-hover-rgb) / <alpha-value>)'
                            },
                            'earth-metal': 'rgb(var(--earth-metal-rgb) / <alpha-value>)',
                            charcoal: 'rgb(var(--charcoal-rgb) / <alpha-value>)',
                            'white-linen': 'rgb(var(--linen-rgb) / <alpha-value>)',
                            'dull-purple': {
                                DEFAULT: 'rgb(var(--dull-purple-rgb) / <alpha-value>)',
                                hover: 'rgb(var(--dull-purple-hover-rgb) / <alpha-value>)'
                            },
                            'muted-pink': {
                                DEFAULT: 'rgb(var(--muted-pink-rgb) / <alpha-value>)',
                                hover: 'rgb(var(--muted-pink-hover-rgb) / <alpha-value>)'
                            }
                        },
                        fontFamily: {
                            display: ['var(--font-display, "Fraunces")', 'serif'],
                            sans: ['var(--font-sans, "Sora")', 'system-ui', 'sans-serif']
                        }
                    }
                }
            }
        };
    </script>

    <!-- Core Dependencies (Pinned Versions) -->
    <!-- Tailwind CSS (v3 latest) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.562.0/dist/umd/lucide.min.js"></script>
    <!-- Marked (Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@17.0.1/lib/marked.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/sql.js@1.13.0/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- KaTeX for equations -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/contrib/auto-render.min.js"></script>

    <!-- GLightbox (CSS before JS) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.1/dist/css/glightbox.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/glightbox@3.3.1/dist/js/glightbox.min.js"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Sora:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">

    <script>
        (() => {
            const resolveSettingsKey = () => {
                try {
                    const rawPath = location?.pathname || '';
                    const trimmed = rawPath.replace(/\/index\.html$/i, '').replace(/\/$/, '');
                    const parts = trimmed.split('/').filter(Boolean);
                    const last = parts[parts.length - 1] || 'ghostink-flashcards';
                    const normalized = last.toLowerCase().replace(/[^a-z0-9_-]+/g, '-').replace(/^-+|-+$/g, '');
                    return `${normalized || 'ghostink-flashcards'}_settings_v1`;
                } catch (_) {
                    return 'ghostink-flashcards_settings_v1';
                }
            };
            let raw = null;
            try {
                const key = resolveSettingsKey();
                raw = localStorage.getItem(key);
            } catch (_) { }

            let mode = 'system';
            let font = 'mono';
            try {
                const s = raw ? JSON.parse(raw) : {};
                mode = s.themeMode || 'system';
                font = s.fontMode || 'mono';
            } catch (_) { }
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = mode === 'system' ? (prefersDark ? 'dark' : 'light') : mode;
            const root = document.documentElement;
            root.setAttribute('data-theme', theme);
            root.setAttribute('data-font', font);
            root.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
        })();
    </script>

    <!-- Application styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>

<body class="text-main font-sans min-h-[100dvh] preinit" data-theme="light" data-font="mono">
    <div class="min-h-[100dvh] flex flex-col">
        <header
            class="flex flex-wrap items-center justify-between gap-2 px-3 sm:px-5 md:px-10 pt-4 sm:pt-6 pb-3 sm:pb-4">
            <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                <div class="w-9 h-9 sm:w-12 sm:h-12 rounded-lg dash flex items-center justify-center shrink-0">
                    <img src="icons/icon-512.png" alt="GhostInk" class="w-8 h-8 sm:w-10 sm:h-10 object-contain">
                </div>
                <div class="min-w-0">
                    <h1 class="font-display text-lg sm:text-2xl text-accent tracking-tight truncate">GhostInk</h1>
                    <p class="text-xs sm:text-sm text-accent-2 hidden sm:block">AI-assisted spaced repetition
                        for flashcards stored in Notion</p>
                </div>
            </div>
            <div class="flex items-center gap-1 sm:gap-1.5 md:gap-2 shrink-0 header-actions">
                <div id="connectionBadge"
                    class="px-2.5 py-1 rounded text-[10px] sm:text-xs font-mono uppercase tracking-wide bg-[color:var(--surface-strong)] border border-[color:var(--card-border)] text-[color:var(--text-main)] hidden md:block">
                    <span id="connectionBadgeText">Offline ready</span><i id="connectionBadgeIcon"
                        data-lucide="cloud-check"
                        class="hidden inline-block w-3.5 h-3.5 align-text-bottom ml-1 text-accent"></i>
                </div>
                <!-- Desktop-only options -->
                <div class="hidden sm:flex items-center gap-0.5 sm:gap-1 pill-toggle rounded-md px-1 sm:px-2 py-1">
                    <button class="p-1 rounded-full theme-btn" data-theme="light" data-tip="Light theme"
                        aria-label="Light theme"><i data-lucide="sun" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="dark" data-tip="Dark theme"
                        aria-label="Dark theme"><i data-lucide="moon" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="system" data-tip="System theme"
                        aria-label="System theme"><i data-lucide="laptop" class="w-4 h-4"></i></button>
                </div>
                <div class="hidden md:flex items-center gap-1 pill-toggle rounded-md px-2 py-1">
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="serif" data-tip="Serif font"
                        aria-label="Serif font">
                        <span class="font-swatch-serif inline-block">Aa</span>
                    </button>
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="mono" data-tip="Mono font"
                        aria-label="Monospace font">
                        <span class="font-swatch-mono inline-block">Aa</span>
                    </button>
                </div>
                <button id="openShortcuts"
                    class="hidden sm:flex p-1.5 sm:p-2 rounded-md bg-[color:var(--surface)] border border-[color:var(--card-border)] hover:bg-[color:var(--surface-strong)] transition-all"
                    data-tip="Keyboard shortcuts" aria-label="Keyboard shortcuts">
                    <i data-lucide="keyboard" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                </button>
                <div class="hidden sm:flex items-center gap-1 pill-toggle rounded-md px-1 sm:px-2 py-1">
                    <span
                        class="text-[8px] font-mono uppercase tracking-[0.18em] text-[color:var(--text-sub)] leading-none opacity-70">Anki</span>
                    <button id="exportAnkiBtn" class="p-1 rounded-full" data-tip="Export Anki"
                        aria-label="Export to Anki">
                        <i data-lucide="download" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                    </button>
                    <label class="p-1 rounded-full cursor-pointer" data-tip="Import Anki" aria-label="Import from Anki">
                        <i data-lucide="upload-cloud" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                        <input aria-label="Import .apkg" id="ankiImportInput" type="file" accept=".apkg,.json"
                            class="hidden">
                    </label>
                </div>
                <!-- Mobile more button -->
                <button id="mobileMoreBtn"
                    class="sm:hidden p-1.5 rounded-md bg-[color:var(--surface)] border border-[color:var(--card-border)]"
                    data-tip="More options" aria-label="More options">
                    <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                </button>
                <button id="syncNowBtn"
                    class="p-1.5 sm:p-2 rounded-md bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] hover:opacity-80 transition-all"
                    data-tip="Sync now" aria-label="Sync with Notion">
                    <i data-lucide="refresh-ccw" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                </button>
                <button id="openSettings"
                    class="p-1.5 sm:p-2 rounded-md bg-[color:var(--surface)] border border-[color:var(--card-border)] hover:bg-[color:var(--surface-strong)] transition-all"
                    data-tip="Settings" aria-label="Open settings">
                    <i data-lucide="settings" class="w-3.5 h-3.5 sm:w-4 sm:h-4"></i>
                </button>
            </div>
            <!-- Mobile expanded menu -->
            <div id="mobileMoreMenu"
                class="hidden w-full pt-2 pb-1 border-t border-[color:var(--card-border)] mt-2 flex-wrap gap-2 sm:hidden justify-end">
                <div class="flex items-center gap-1 pill-toggle rounded-md px-2 py-1">
                    <button class="p-1 rounded-full theme-btn" data-theme="light" aria-label="Light theme"><i
                            data-lucide="sun" class="w-4 h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="dark" aria-label="Dark theme"><i
                            data-lucide="moon" class="w-4 h-4"></i></button>
                    <button class="p-1 rounded-full theme-btn" data-theme="system" aria-label="System theme"><i
                            data-lucide="laptop" class="w-4 h-4"></i></button>
                </div>
                <div class="flex items-center gap-1 pill-toggle rounded-md px-2 py-1">
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="serif"
                        aria-label="Serif font"><span class="font-swatch-serif">Aa</span></button>
                    <button class="px-2 py-1 rounded-full font-btn text-xs" data-font="mono"
                        aria-label="Monospace font"><span class="font-swatch-mono">Aa</span></button>
                </div>
                <div class="flex items-center gap-1 pill-toggle rounded-md px-2 py-1">
                    <span
                        class="text-[8px] font-mono uppercase tracking-[0.18em] text-[color:var(--text-sub)] opacity-70">Anki</span>
                    <button id="exportAnkiBtnMobile" class="p-1 rounded-full" data-tip="Export Anki"
                        aria-label="Export to Anki"><i data-lucide="download" class="w-4 h-4"></i></button>
                    <label class="p-1 rounded-full cursor-pointer" data-tip="Import Anki" aria-label="Import from Anki">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        <input aria-label="Import .apkg" id="ankiImportInputMobile" type="file" accept=".apkg,.json"
                            class="hidden">
                    </label>
                    <button id="openShortcutsMobile" class="p-1 rounded-full" data-tip="Keyboard shortcuts"
                        aria-label="Keyboard shortcuts"><i data-lucide="keyboard" class="w-4 h-4"></i></button>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav id="tabBar"
            class="px-3 sm:px-5 md:px-10 py-2 sm:py-3 flex gap-1.5 sm:gap-2 border-b border-[color:var(--card-border)]">
            <button data-tab="study" class="tab-btn active text-xs sm:text-sm inline-flex items-center gap-1.5">
                <i data-lucide="brain" class="w-3.5 h-3.5"></i>Study
            </button>
            <button data-tab="library" class="tab-btn text-xs sm:text-sm inline-flex items-center gap-1.5">
                <i data-lucide="layers" class="w-3.5 h-3.5"></i>Library
            </button>
            <button data-tab="analytics" class="tab-btn text-xs sm:text-sm inline-flex items-center gap-1.5">
                <i data-lucide="bar-chart-3" class="w-3.5 h-3.5"></i>Analytics
            </button>
        </nav>

        <main class="px-3 sm:px-5 md:px-10 pb-6 sm:pb-10 space-y-4 md:space-y-6">
            <div id="lockedOverlay"
                class="rounded-lg p-6 bg-[color:var(--surface-strong)] border border-[color:var(--card-border)] flex flex-col gap-5 max-w-3xl mx-auto mt-6 text-center hidden">

                <!-- What is GhostInk Feature Card -->
                <div
                    class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-4 text-left">
                    <div class="flex items-center gap-2 text-accent font-semibold mb-3">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        <span class="text-sm">Features</span>
                    </div>
                    <div class="max-h-44 overflow-y-auto scroll-minimal pr-1">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-xs text-sub ">
                            <div class="flex items-center gap-2">
                                <i data-lucide="eye" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Reveal mode</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="bot" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>AI answer judging</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="brain" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>SM-2 & FSRS v6</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="mic" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Voice input</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="layers" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Front-back & Cloze</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Dynamic Context variants</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="image" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Media & LaTeX</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="download" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Anki import/export</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="keyboard" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Keyboard shortcuts</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="wifi-off" class="w-3.5 h-3.5 text-accent shrink-0"></i>
                                <span>Offline PWA</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3">
                    <p class="font-display text-lg sm:text-xl text-main leading-tight">AI-assisted spaced repetition for
                        flashcards stored in Notion</p>
                    <p class="text-xs sm:text-sm text-sub leading-relaxed">
                        Your cards live in Notion where you can see and edit them. Review like Anki, optionally get AI
                        judging for your answers, and generate fresh Dynamic Context variants as you advance.
                    </p>
                    <p class="text-[11px] text-muted ">
                        Built by <a class="underline text-accent " href="https://mimansajaiswal.github.io"
                            target="_blank" rel="noopener noreferrer">Mimansa
                            Jaiswal</a> · In the <a class="underline text-accent "
                            href="https://mimansajaiswal.github.io/tools/" target="_blank"
                            rel="noopener noreferrer">Tools Made with LLMs</a> · Code: <a class="underline text-accent "
                            href="https://github.com/mimansajaiswal/tools/tree/main/ghostink-flashcards" target="_blank"
                            rel="noopener noreferrer">ghostink-flashcards</a>
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-3 text-sm text-left">
                    <div
                        class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-3 space-y-1">
                        <div class="flex items-center gap-2 text-accent font-semibold"><i data-lucide="copy"
                                class="w-4 h-4"></i>1. Template</div>
                        <p class="text-sub">Duplicate this <a
                                href="https://mimansajaiswal-embedded-dbs.notion.site/ghostink-template" target="_blank"
                                rel="noopener noreferrer" class="underline text-accent">Notion template</a>. Custom
                            DBs must match property names/options exactly (case-sensitive).</p>
                    </div>
                    <div
                        class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-3 space-y-1">
                        <div class="flex items-center gap-2 text-accent font-semibold"><i data-lucide="link"
                                class="w-4 h-4"></i>2. Connect</div>
                        <p class="text-sub">Add worker URL, Notion token, and select your new databases.</p>
                    </div>
                    <div
                        class="rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] p-3 space-y-1">
                        <div class="flex items-center gap-2 text-accent font-semibold"><i data-lucide="wand-2"
                                class="w-4 h-4"></i>3. Study</div>
                        <p class="text-sub">Sync, review, and unlock Dynamic Context variants as you progress.</p>
                    </div>
                </div>
                <div class="flex justify-center">
                    <button id="lockedOpenSettings"
                        class="px-5 py-3 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all flex items-center gap-2 whitespace-nowrap shadow-soft">
                        <i data-lucide="settings" class="w-4 h-4"></i><span>Open settings</span>
                    </button>
                </div>
            </div>

            <section id="mainContent" class="space-y-6">
                <!-- LIBRARY TAB -->
                <div id="libraryTab" class="tab-content space-y-4 md:space-y-6 hidden">
                    <!-- Decks Section -->
                    <article class="card rounded-lg p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                        <div class="flex items-center justify-between gap-2">
                            <div class="min-w-0">
                                <h2 class="font-display text-base md:text-lg text-main">Decks</h2>
                                <p class="text-xs md:text-sm text-sub hidden sm:block">Click to select a deck
                                    and view its cards.</p>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <button id="refreshDecksBtn"
                                    class="p-2 rounded-lg border border-card text-main hover:bg-surface-strong flex items-center gap-2"
                                    data-tip="Sync with Notion">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                </button>
                                <button id="newDeckBtn"
                                    class="p-2 md:px-3 md:py-2 rounded-lg bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--badge-bg-hover)] flex items-center gap-2"
                                    data-tip="New deck">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span class="hidden md:inline">New deck</span>
                                </button>
                            </div>
                        </div>
                        <!-- Deck search -->
                        <div class="mt-3">
                            <input id="libraryDeckSearch" type="text" placeholder="Search decks..." maxlength="100"
                                aria-label="Search decks"
                                class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dull-purple/40">
                        </div>
                        <div id="deckGrid"
                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 md:gap-3 mt-3 max-h-[400px] sm:max-h-[400px] md:max-h-[240px] lg:max-h-[240px] overflow-y-auto scroll-minimal p-1">
                        </div>
                    </article>

                    <!-- Selected Deck Bar + Cards Section -->
                    <article id="cardsSection"
                        class="card rounded-lg p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                        <div id="selectedDeckBar" class="flex items-center justify-between gap-2">
                            <h2 class="font-display text-base md:text-lg text-main truncate" id="selectedDeckName">
                                Select a deck above</h2>
                            <div class="flex items-center gap-1 md:gap-2 shrink-0">
                                <button id="resetAlgorithmBtn"
                                    class="p-2 md:px-3 md:py-2 rounded-lg border border-[color:var(--danger-soft-text)] text-[color:var(--danger-soft-text)] text-sm hover:bg-[color:var(--danger-soft-bg)] flex items-center gap-2 hidden"
                                    data-tip="Reset algorithm parameters">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    <span class="hidden lg:inline">Reset Algorithm</span>
                                </button>
                                <button id="newCardBtn"
                                    class="p-2 md:px-3 md:py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all flex items-center gap-2 hidden"
                                    data-tip="New card">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                    <span class="hidden md:inline">New card</span>
                                </button>
                            </div>
                        </div>
                        <!-- Cards content (hidden until deck selected) -->
                        <div id="cardsContent" class="hidden mt-3 md:mt-4">
                            <!-- Card search -->
                            <div class="mb-3">
                                <input id="cardSearchInput" type="text" placeholder="Search cards by name..."
                                    maxlength="200" aria-label="Search cards"
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dull-purple/40">
                            </div>
                            <div class="mb-3 flex flex-wrap items-center justify-between gap-2">
                                <div class="flex flex-wrap items-center gap-3 text-xs text-[color:var(--text-sub)]">
                                    <label class="flex items-center gap-2">
                                        <input id="filterSuspended" type="checkbox" class="accent-dull-purple">
                                        <span>Hide suspended</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input id="filterLeech" type="checkbox" class="accent-dull-purple">
                                        <span>Hide leeches</span>
                                    </label>
                                </div>
                                <div id="unsuspendAllWrap" class="hidden">
                                    <button id="unsuspendAllBtn" class="text-xs text-accent hover:underline">Unsuspend
                                        all</button>
                                </div>
                            </div>
                            <div id="cardsContainer"
                                class="max-h-[350px] md:max-h-[400px] overflow-y-auto scroll-minimal">
                                <table class="w-full text-xs md:text-sm">
                                    <thead class="text-muted sticky top-0 bg-[color:var(--card-bg)]">
                                        <tr class="border-b border-card">
                                            <th class="py-2 text-left">Name</th>
                                            <th class="py-2 text-left hidden sm:table-cell">Type</th>
                                            <th class="py-2 text-left">Due</th>
                                            <th class="py-2 text-left hidden md:table-cell">Tags</th>
                                            <th class="py-2 text-left w-8 md:w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="cardTable" class="divide-y divide-[color:var(--border-weak)]"></tbody>
                                </table>
                            </div>
                            <div id="noCardsMessage"
                                class="text-center py-6 md:py-8 text-muted text-xs md:text-sm hidden">
                                No cards in this deck yet. Click "New card" to add one.
                            </div>
                        </div>
                    </article>
                </div>

                <!-- STUDY TAB -->
                <div id="studyTab" class="tab-content">
                    <!-- Centered Study Content -->
                    <div class="max-w-2xl mx-auto space-y-4 md:space-y-6">
                        <!-- Session Active Bar (shown when session is active) -->
                        <div id="sessionActiveBar"
                            class="hidden card rounded-lg p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                            <div class="flex items-center justify-between gap-3">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="book-open" class="w-5 h-5 text-accent"></i>
                                    <span id="sessionProgressText"
                                        class="text-sm md:text-base text-main font-medium">Session: 0/0</span>
                                </div>
                                <div id="previewBadge"
                                    class="hidden text-[11px] px-2 py-1 rounded-lg bg-accent-soft text-accent border border-[color:var(--accent)]/60">
                                    Preview mode: no scheduling changes
                                </div>
                                <button id="abandonSessionBtn"
                                    class="flex items-center gap-1.5 px-2 md:px-3 py-1.5 rounded-lg text-xs md:text-sm text-sub hover:text-accent-2 hover:bg-accent-2-soft border border-card transition whitespace-nowrap">
                                    <i data-lucide="square" class="w-3 h-3"></i>
                                    <span class="hidden md:inline">Stop Session</span>
                                    <span class="md:hidden">Stop</span>
                                    <kbd id="stopSessionHotkey"
                                        class="hidden md:inline hotkey-chip text-[10px] ml-1 px-1.5 py-0.5 rounded font-medium"></kbd>
                                </button>
                            </div>
                        </div>

                        <!-- Study Filters Card -->
                        <article id="studySettingsCard"
                            class="card rounded-lg p-4 md:p-5 shadow-soft text-[color:var(--text-main)]">
                            <div class="flex items-center justify-between gap-2 mb-3 md:mb-4">
                                <div class="flex items-center gap-2 min-w-0">
                                    <i data-lucide="settings-2" class="w-4 h-4 text-accent shrink-0"></i>
                                    <h2 class="font-display text-base md:text-lg text-main truncate">Study Mode
                                        Settings</h2>
                                </div>
                                <button id="resetFilters"
                                    class="text-xs text-accent hover:underline hidden">Reset</button>
                            </div>

                            <!-- Always visible: Decks + Mode -->
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-sub block mb-2">Study from decks</label>
                                    <div class="relative">
                                        <input id="deckSearchInput" type="text" placeholder="Search decks..."
                                            maxlength="100"
                                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-dull-purple/40">
                                        <div id="deckDropdown"
                                            class="hidden absolute left-0 right-0 z-50 w-full mt-1 max-h-48 overflow-y-auto rounded-lg border border-card bg-[color:var(--card-bg)] shadow-lg">
                                        </div>
                                    </div>
                                    <div id="selectedDecksDisplay" class="flex flex-wrap gap-1.5 mt-2"></div>
                                </div>
                                <div>
                                    <label class="text-xs text-sub block mb-2">Revision mode</label>
                                    <select id="revisionMode"
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                                        <option value="manual">Reveal</option>
                                        <option value="ai">AI</option>
                                    </select>
                                </div>
                                <!-- Session controls -->
                                <div id="sessionControls" class="pt-3">
                                    <button id="startSessionBtn"
                                        class="w-full px-4 py-2.5 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all transition flex items-center justify-center gap-2">
                                        <i data-lucide="play" class="w-4 h-4"></i>
                                        <span>Start Study Session</span>
                                        <kbd id="startSessionHotkey"
                                            class="hidden md:inline-block hotkey-chip text-[10px] px-1.5 py-0.5 rounded font-medium ml-1"></kbd>
                                    </button>
                                </div>
                            </div>

                            <!-- More options divider -->
                            <button id="toggleFilters"
                                class="w-full flex items-center justify-center gap-2 mt-4 py-2 text-xs text-muted hover:text-main transition-colors">
                                <span class="flex-1 h-px bg-[color:var(--card-border)]"></span>
                                <span class="flex items-center gap-1">
                                    <span id="moreOptionsText">More options</span>
                                    <i data-lucide="chevron-down" id="filtersChevron"
                                        class="w-3 h-3 transition-transform"></i>
                                </span>
                                <span class="flex-1 h-px bg-[color:var(--card-border)]"></span>
                            </button>

                            <div id="filtersContent" class="hidden pt-3 md:pt-4">
                                <div class="grid grid-cols-2 gap-2 md:gap-3 text-xs md:text-sm">
                                    <!-- Card selection mode -->
                                    <div class="col-span-2">
                                        <label class="text-xs text-sub block mb-2">Practice cards</label>
                                        <select id="cardSelectionMode"
                                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                                            <option value="due">Due cards only</option>
                                            <option value="all">All cards</option>
                                            <option value="cram">Cram (no scheduling)</option>
                                        </select>
                                    </div>
                                    <div id="noScheduleRow" class="col-span-2 hidden">
                                        <label class="flex items-center gap-2 text-xs md:text-sm">
                                            <input id="noScheduleChanges" type="checkbox" class="accent-dull-purple"
                                                checked>
                                            <span>No scheduling changes (preview mode)</span>
                                        </label>
                                        <p class="text-[11px] text-faint mt-1">When on,
                                            ratings won’t update
                                            due dates or algorithms.</p>
                                    </div>
                                    <label class="flex items-center gap-2">
                                        <input id="filterAgain" type="checkbox" class="accent-dull-purple">
                                        <span>Again recently</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input id="filterHard" type="checkbox" class="accent-dull-purple">
                                        <span>Hard/Again</span>
                                    </label>
                                    <label class="flex items-center gap-2 col-span-2">
                                        <input id="filterAddedToday" type="checkbox" class="accent-dull-purple">
                                        <span>Added today</span>
                                    </label>
                                    <div class="col-span-2">
                                        <label class="text-xs text-sub">Tags</label>
                                        <div class="relative">
                                            <input id="filterTagSearch" type="text" placeholder="Search tags"
                                                maxlength="100"
                                                class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                                            <div id="filterTagDropdown"
                                                class="hidden absolute left-0 right-0 z-40 mt-1 max-h-44 overflow-y-auto rounded-lg border border-card bg-[color:var(--card-bg)] shadow-lg">
                                            </div>
                                        </div>
                                        <div id="filterTagSelected" class="flex flex-wrap gap-1.5 mt-2"></div>
                                    </div>
                                    <label class="flex items-center gap-2">
                                        <input id="filterMarked" type="checkbox" class="accent-dull-purple">
                                        <span>Only marked</span>
                                    </label>
                                    <div class="col-span-2">
                                        <div class="flex items-center justify-between">
                                            <label class="text-xs text-sub">Flag</label>
                                            <button id="filterFlagClear" type="button"
                                                class="text-[11px] text-accent hover:underline">Clear</button>
                                        </div>
                                        <div id="filterFlagSwatches" class="flag-swatch-row">
                                            <button type="button" class="flag-swatch-btn" data-flag="Red"
                                                aria-label="Red flag">
                                                <span class="flag-swatch flag-red"></span>
                                            </button>
                                            <button type="button" class="flag-swatch-btn" data-flag="Orange"
                                                aria-label="Orange flag">
                                                <span class="flag-swatch flag-orange"></span>
                                            </button>
                                            <button type="button" class="flag-swatch-btn" data-flag="Yellow"
                                                aria-label="Yellow flag">
                                                <span class="flag-swatch flag-yellow"></span>
                                            </button>
                                            <button type="button" class="flag-swatch-btn" data-flag="Green"
                                                aria-label="Green flag">
                                                <span class="flag-swatch flag-green"></span>
                                            </button>
                                            <button type="button" class="flag-swatch-btn" data-flag="Blue"
                                                aria-label="Blue flag">
                                                <span class="flag-swatch flag-blue"></span>
                                            </button>
                                            <button type="button" class="flag-swatch-btn" data-flag="Purple"
                                                aria-label="Purple flag">
                                                <span class="flag-swatch flag-purple"></span>
                                            </button>
                                        </div>
                                        <p class="text-[10px] text-muted mt-1">Select one or more to filter. Empty = all
                                            flags.</p>
                                    </div>
                                    <button id="resetFiltersMobile"
                                        class="col-span-2 sm:hidden text-xs text-accent hover:underline text-center py-2">Reset
                                        all filters</button>
                                    <button id="resetFiltersAll"
                                        class="col-span-2 hidden sm:block text-xs text-accent hover:underline text-center py-2">Reset
                                        all filters</button>
                                </div>
                            </div>
                        </article>
                        <!-- Study Card -->
                        <article id="studyCardSection"
                            class="card rounded-lg p-4 md:p-5 shadow-soft text-[color:var(--text-main)] hidden">
                            <div class="flex items-center justify-between gap-2">
                                <h2 class="font-display text-base md:text-lg text-main">Study</h2>
                                <div class="flex items-center gap-1">
                                    <button id="markCardBtn" class="p-1.5 rounded-lg hover:bg-surface-strong text-muted"
                                        title="Mark card (M)">
                                        <i data-lucide="star" class="w-4 h-4"></i>
                                    </button>
                                    <button id="flagCardBtn" class="p-1.5 rounded-lg hover:bg-surface-strong text-muted"
                                        title="Flag card (F)">
                                        <i data-lucide="flag" class="w-4 h-4"></i>
                                    </button>
                                    <button id="addNoteBlock"
                                        class="p-1.5 rounded-lg hover:bg-surface-strong text-accent hidden"
                                        title="Add note to page">
                                        <i data-lucide="file-plus" class="w-4 h-4"></i>
                                    </button>
                                    <button id="copyCardContent"
                                        class="p-1.5 rounded-lg hover:bg-surface-strong text-accent hidden"
                                        title="Copy card content">
                                        <i data-lucide="clipboard" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="studyCardContent"
                                class="relative mt-3 p-3 md:p-4 rounded-lg bg-[color:var(--surface-strong)] border border-[color:var(--card-border)] space-y-3">
                                <div class="flex items-center justify-between text-xs text-[color:var(--text-sub)]">
                                    <span id="studyDeckLabel" class="truncate">Choose a deck</span>
                                </div>
                                <div id="cardFront"
                                    class="md-content min-h-[100px] md:min-h-[120px] leading-relaxed text-[color:var(--text-main)] max-h-[40vh] md:max-h-[45vh] overflow-y-auto pr-1 scroll-minimal text-sm md:text-base">
                                </div>
                                <div class="space-y-2">
                                    <button id="revealBtn"
                                        class="relative px-3 py-2.5 w-full rounded-lg bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--badge-bg-hover)] ">
                                        Reveal
                                        <kbd
                                            class="hidden md:inline-block hotkey-chip absolute right-3 top-1/2 -translate-y-1/2 text-[10px] px-2 py-0.5 rounded font-medium">Space</kbd>
                                    </button>
                                    <div id="aiControls" class="hidden space-y-2">
                                        <textarea id="aiAnswer" rows="3" placeholder="Type your answer..."
                                            class="w-full rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] px-3 py-2 text-sm"></textarea>
                                        <div class="flex gap-2">
                                            <button id="aiRecord"
                                                class="relative p-2 pr-2 md:pr-8 rounded-lg bg-[color:var(--surface)] border border-[color:var(--card-border)] text-[color:var(--text-main)] text-sm flex flex-1 items-center justify-center"
                                                title="Record">
                                                <i data-lucide="mic" class="w-4 h-4"></i>
                                                <kbd id="micHotkey"
                                                    class="hidden md:inline-block hotkey-chip absolute right-2 top-1/2 -translate-y-1/2 text-[10px] px-1 py-0.5 rounded"></kbd>
                                            </button>
                                            <button id="aiSubmit"
                                                class="px-3 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all flex-1">
                                                Send <kbd id="aiSendHotkey"
                                                    class="hidden md:inline-block hotkey-chip text-[10px] px-1.5 py-0.5 rounded font-medium ml-1"></kbd>
                                            </button>
                                        </div>
                                        <div id="aiFeedback"
                                            class="md-content hidden text-sm text-sub-strong bg-[var(--surface)] border border-weak rounded-lg p-2">
                                        </div>
                                    </div>
                                </div>
                                <div id="cardBack"
                                    class="md-content leading-relaxed text-[color:var(--text-sub)] hidden max-h-[40vh] md:max-h-[45vh] overflow-y-auto pr-1 scroll-minimal text-sm md:text-base">
                                </div>
                                <!-- Study controls (hidden when session complete) -->
                                <div id="studyControls">
                                    <div class="grid grid-cols-4 gap-1 md:gap-2">
                                        <button data-rate="Again" aria-label="Rate as Again (1)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg text-[10px] md:text-xs flex items-center justify-center gap-1">
                                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                                            <span>Again</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-[color:var(--rating-again-bg)] text-[color:var(--rating-again-text)] font-medium shadow-sm">1</kbd>
                                        </button>
                                        <button data-rate="Hard" aria-label="Rate as Hard (2)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg text-[10px] md:text-xs flex items-center justify-center gap-1">
                                            <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                                            <span>Hard</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-[color:var(--rating-hard-bg)] text-[color:var(--rating-hard-text)] font-medium shadow-sm">2</kbd>
                                        </button>
                                        <button data-rate="Good" aria-label="Rate as Good (3)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg text-[10px] md:text-xs flex items-center justify-center gap-1">
                                            <i data-lucide="thumbs-up" class="w-3 h-3"></i>
                                            <span>Good</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-[color:var(--rating-good-bg)] text-[color:var(--rating-good-text)] font-medium shadow-sm">3</kbd>
                                        </button>
                                        <button data-rate="Easy" aria-label="Rate as Easy (4)"
                                            class="rate-btn relative px-1 md:px-2 py-2 rounded-lg text-[10px] md:text-xs flex items-center justify-center gap-1">
                                            <i data-lucide="zap" class="w-3 h-3"></i>
                                            <span>Easy</span>
                                            <kbd
                                                class="hidden md:flex absolute -top-1.5 -right-1.5 w-4 h-4 items-center justify-center text-[8px] rounded bg-[color:var(--rating-easy-bg)] text-[color:var(--rating-easy-text)] font-medium shadow-sm">4</kbd>
                                        </button>
                                    </div>
                                    <div class="text-[10px] md:text-[11px] text-sub flex justify-end mt-2">
                                        <button id="skipCard"
                                            class="px-2 py-1 rounded-lg border border-weak text-accent hover:bg-accent-soft shrink-0 flex items-center gap-1">
                                            <i data-lucide="square-slash" class="w-3 h-3"></i>
                                            <span>Skip</span>
                                            <kbd id="skipHotkey"
                                                class="hidden md:inline hotkey-chip text-[9px] ml-0.5 px-1 py-0.5 rounded font-medium">S</kbd>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </article>

                        <!-- Mobile FAB cluster - Joystick and action buttons (only visible on mobile) -->
                        <div id="mobileFabCluster" class="mobile-fab-cluster hidden">
                            <!-- Joystick wrapper with side actions -->
                            <div class="joystick-wrapper">
                                <!-- Arcade-style joystick for rating -->
                                <div id="joystickContainer" class="joystick-container hidden">
                                    <div id="joystick" class="joystick">
                                        <!-- Direction labels with filled icons -->
                                        <!-- Clockwise from bottom: Again (down) → Hard (left) → Good (up) → Easy (right) -->
                                        <div class="joystick-label joystick-label-up">
                                            <i data-lucide="thumbs-up"></i>
                                        </div>
                                        <div class="joystick-label joystick-label-down">
                                            <i data-lucide="refresh-cw"></i>
                                        </div>
                                        <div class="joystick-label joystick-label-left">
                                            <i data-lucide="alert-triangle"></i>
                                        </div>
                                        <div class="joystick-label joystick-label-right">
                                            <i data-lucide="zap"></i>
                                        </div>
                                        <!-- The knob -->
                                        <div class="joystick-knob"></div>
                                    </div>
                                </div>

                                <!-- Side action buttons (next to joystick) -->
                                <div class="joystick-side-actions">
                                    <button id="fabAddNote" class="fab-btn fab-btn-secondary hidden" title="Add note">
                                        <i data-lucide="file-plus"></i>
                                    </button>
                                    <button id="fabCopy" class="fab-btn fab-btn-secondary hidden" title="Copy">
                                        <i data-lucide="clipboard"></i>
                                    </button>
                                    <button id="fabMic" class="fab-btn fab-btn-secondary hidden"
                                        title="Record (AI mode)">
                                        <i data-lucide="mic"></i>
                                    </button>
                                    <button id="fabSend" class="fab-btn fab-btn-secondary hidden"
                                        title="Send (AI mode)">
                                        <i data-lucide="send"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Pre-reveal actions -->
                            <div id="fabPreRevealActions" class="joystick-side-actions">
                                <button id="fabSkip" class="fab-btn fab-btn-secondary" title="Skip">
                                    <i data-lucide="square-slash"></i>
                                </button>
                                <button id="fabReveal" class="fab-btn fab-btn-primary" title="Reveal">
                                    <i data-lucide="eye"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Notes Preview (below study card, no textarea) -->
                        <div id="notesSection"
                            class="rounded-lg border border-[color:var(--card-border)] p-3 md:p-4 bg-[color:var(--card-bg)] hidden">
                            <div class="flex items-center justify-between mb-2 md:mb-3">
                                <span class="font-semibold text-main text-sm md:text-base">Notes</span>
                                <button id="editNotesBtn" class="p-1.5 rounded-lg hover:bg-surface-strong text-accent"
                                    title="Edit notes">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="notesPreview"
                                class="md-content prose prose-sm max-h-60 md:max-h-80 overflow-y-auto text-xs md:text-sm text-[color:var(--text-main)] scroll-minimal">
                                <p class="text-muted text-xs md:text-sm">No notes for this card</p>
                            </div>
                        </div>

                        <!-- Mobile bottom spacer to prevent joystick overlap -->
                        <div class="h-36 md:hidden" aria-hidden="true"></div>
                    </div>
                </div>

                <!-- ANALYTICS TAB -->
                <div id="analyticsTab" class="tab-content hidden space-y-4 md:space-y-5">
                    <!-- Header with filters -->
                    <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                        <div class="flex flex-col gap-3 md:gap-1">
                            <div class="flex items-start justify-between gap-3">
                                <div class="min-w-0">
                                    <h2
                                        class="font-display text-base sm:text-lg md:text-xl text-[color:var(--text-main)]">
                                        Analytics</h2>
                                    <p class="text-xs sm:text-sm text-[color:var(--text-sub)] mt-0.5">Your learning
                                        progress
                                        and review patterns</p>
                                </div>
                                <button id="analyticsResetBtn"
                                    class="analytics-reset-btn rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] px-2.5 py-1.5 text-[11px] sm:text-xs text-[color:var(--text-main)] inline-flex items-center gap-1.5 hover:bg-surface-muted">
                                    <i data-lucide="rotate-ccw" class="w-3 h-3 text-[color:var(--text-sub)]"></i>
                                    Reset
                                </button>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 justify-start sm:justify-end">
                                <div id="analyticsRangeWrap" class="relative">
                                    <button id="analyticsRangeBtn"
                                        class="rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] px-3 py-2 text-sm text-[color:var(--text-main)] inline-flex items-center gap-2">
                                        <span id="analyticsRangeLabel">This year</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-[color:var(--text-sub)]"></i>
                                    </button>
                                    <div id="analyticsRangeMenu"
                                        class="analytics-menu analytics-menu-left mt-2 hidden min-w-[190px] rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] shadow-lg p-1 z-50">
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="all">All time</button>
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="7">Last week</button>
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="30">Last month</button>
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="90">Last 3 months</button>
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="180">Last 6 months</button>
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="365">Last year</button>
                                        <button type="button"
                                            class="analytics-range-option w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted"
                                            data-range="this-year">This year</button>
                                        <div class="analytics-submenu-wrap">
                                            <button type="button"
                                                class="analytics-range-option analytics-submenu-trigger w-full text-left px-3 py-2 text-sm rounded-md hover:bg-surface-muted inline-flex items-center justify-between"
                                                data-range="by-year">
                                                By year
                                                <i data-lucide="chevron-right"
                                                    class="submenu-chevron w-3 h-3 text-[color:var(--text-sub)]"></i>
                                            </button>
                                            <div id="analyticsYearMenu"
                                                class="analytics-submenu hidden min-w-[140px] rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] shadow-lg p-1 z-50">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="analyticsDeckWrap" class="relative">
                                    <button id="analyticsDeckBtn"
                                        class="rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] px-3 py-2 text-sm text-[color:var(--text-main)] inline-flex items-center gap-2">
                                        <span id="analyticsDeckLabel">All decks</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-[color:var(--text-sub)]"></i>
                                    </button>
                                    <div id="analyticsDeckMenu"
                                        class="analytics-menu analytics-menu-left mt-2 hidden min-w-[240px] rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] shadow-lg p-1 z-50">
                                    </div>
                                </div>
                                <div id="analyticsFilterWrap" class="relative">
                                    <button id="analyticsFilterBtn"
                                        class="rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] px-3 py-2 text-sm text-[color:var(--text-main)] inline-flex items-center gap-2">
                                        <i data-lucide="filter" class="w-4 h-4 text-[color:var(--text-sub)]"></i>
                                        <span id="analyticsFilterLabel">Filters</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-[color:var(--text-sub)]"></i>
                                    </button>
                                    <div id="analyticsFilterMenu"
                                        class="analytics-menu analytics-menu-left mt-2 hidden min-w-[260px] rounded-lg border border-[color:var(--card-border)] bg-[color:var(--surface)] shadow-lg p-1 z-50">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Quick stats row -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <p class="analytics-stat-label">Today</p>
                            <div id="analyticsToday" class="mt-1"></div>
                        </article>
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <p class="analytics-stat-label">Streaks</p>
                            <div id="analyticsStreaks" class="mt-1"></div>
                        </article>
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <p class="analytics-stat-label">Retention</p>
                            <div id="analyticsRetention" class="mt-1"></div>
                        </article>
                    </div>

                    <!-- Heatmap -->
                    <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
                            <div>
                                <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Activity
                                    heatmap</h3>
                                <p class="text-xs text-[color:var(--text-sub)] mt-0.5">Daily review activity</p>
                            </div>
                            <div class="flex flex-wrap items-center gap-2 self-start sm:self-auto">
                                <div
                                    class="inline-flex rounded-full border border-[color:var(--card-border)] bg-[color:var(--surface)] overflow-hidden">
                                    <button id="heatmapMetricReviews" type="button"
                                        class="heatmap-metric-btn is-active px-2.5 py-1 text-[10px] font-mono uppercase tracking-wide">
                                        Reviews</button>
                                    <button id="heatmapMetricRating" type="button"
                                        class="heatmap-metric-btn px-2.5 py-1 text-[10px] font-mono uppercase tracking-wide">
                                        Avg rating</button>
                                </div>
                                <button id="heatmapDownloadBtn"
                                    class="p-1.5 rounded-lg border border-[color:var(--card-border)] text-[color:var(--text-sub)] hover:text-[color:var(--text-main)] hover:bg-surface-strong transition-all"
                                    title="Download heatmap PNG">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                </button>
                                <span id="analyticsStreakBadge" class="analytics-pill"></span>
                            </div>
                        </div>
                        <div id="analyticsHeatmap" class="heatmap-years"></div>
                        <div class="flex items-center justify-end mt-3">
                            <div class="heatmap-legend">
                                <span id="heatmapLegendLow">Fewer reviews</span>
                                <span class="heatmap-swatch level-0"></span>
                                <span class="heatmap-swatch level-1"></span>
                                <span class="heatmap-swatch level-2"></span>
                                <span class="heatmap-swatch level-3"></span>
                                <span class="heatmap-swatch level-4"></span>
                                <span id="heatmapLegendHigh">More reviews</span>
                            </div>
                        </div>
                    </article>

                    <!-- Charts row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Reviews per day
                            </h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Number of cards reviewed</p>
                            <div id="analyticsReviewCount" class="chart-scroll"></div>
                        </article>
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Study time</h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Minutes spent reviewing</p>
                            <div id="analyticsReviewTime" class="chart-scroll"></div>
                        </article>
                    </div>

                    <!-- Breakdown row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Answer breakdown
                            </h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">How you rated your recalls</p>
                            <div id="analyticsAnswerBreakdown"></div>
                        </article>
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Study schedule
                            </h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Reviews by hour of day</p>
                            <div id="analyticsHourlyBreakdown" class="chart-scroll"></div>
                        </article>
                    </div>

                    <!-- Distribution row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Interval
                                distribution</h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Card scheduling spread</p>
                            <div id="analyticsIntervalDistribution"></div>
                        </article>
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Difficulty
                                spread</h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Card ease and difficulty factors
                            </p>
                            <div id="analyticsEaseDifficulty"></div>
                        </article>
                    </div>

                    <!-- Summary row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">Card status</h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Overview of your deck</p>
                            <div id="analyticsCardCounts"></div>
                        </article>
                        <article class="card rounded-lg p-4 md:p-5 shadow-soft">
                            <h3 class="font-display text-sm sm:text-base text-[color:var(--text-main)]">True retention
                            </h3>
                            <p class="text-xs text-[color:var(--text-sub)] mt-0.5 mb-3">Success rate by interval</p>
                            <div id="analyticsTrueRetention"></div>
                        </article>
                    </div>
                </div>
            </section>
        </main>
        <footer id="footerAttribution" class="hidden px-3 sm:px-5 md:px-10 pb-4 text-[11px] text-muted text-center">
            Built by <a class="underline text-accent " href="https://mimansajaiswal.github.io" target="_blank"
                rel="noopener noreferrer">Mimansa Jaiswal</a> · In the <a class="underline text-accent "
                href="https://mimansajaiswal.github.io/tools/" target="_blank" rel="noopener noreferrer">Tools Made with
                LLMs</a> · Code: <a class="underline text-accent "
                href="https://github.com/mimansajaiswal/tools/tree/main/ghostink-flashcards" target="_blank"
                rel="noopener noreferrer">ghostink-flashcards</a>
        </footer>
    </div>

    <div id="toast" role="status" aria-live="polite"
        class="fixed z-[230] bottom-6 right-6 px-4 py-3 rounded-md bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] text-sm font-medium hidden opacity-0 transition-opacity duration-300 border border-[color:var(--card-border)]">
    </div>
    <div id="tooltip"
        class="fixed z-[230] px-2.5 py-1.5 rounded-md text-xs font-mono bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] pointer-events-none hidden border border-[color:var(--card-border)]">
    </div>

    <!-- Global loading overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 z-[180] bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center">
        <div class="flex flex-col items-center gap-3 text-[color:var(--overlay-text)] text-center px-6">
            <div
                class="h-12 w-12 border-4 border-[color:var(--overlay-track)] border-t-[color:var(--overlay-text)] rounded-full animate-spin">
            </div>
            <p id="loadingMessage" class="text-sm font-medium">Loading...</p>
            <p class="text-xs text-[color:var(--overlay-text-muted)]" id="loadingSubtext">Preparing your decks and
                cards.</p>
            <div id="loadingProgressWrap" class="w-full max-w-xs hidden">
                <div class="w-full h-2 bg-surface-muted rounded-full overflow-hidden">
                    <div id="loadingProgressBar" class="h-2 bg-[color:var(--accent)] w-0 transition-all duration-300">
                    </div>
                </div>
                <p id="loadingProgressText" class="text-[11px] text-[color:var(--overlay-text-muted)] mt-1">0%</p>
            </div>
            <button id="loadingCancelBtn"
                class="hidden mt-2 px-4 py-2 text-xs bg-surface-muted hover:bg-surface-muted rounded-lg transition-colors">
                Cancel
            </button>
        </div>
    </div>

    <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmModalTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[220]">
        <div class="card rounded-lg p-5 w-full max-w-sm shadow-soft">
            <p id="confirmModalTitle" class="modal-title font-display text-lg mb-2">Confirm delete</p>
            <p class="text-sm text-sub ">This removes it locally and syncs deletion to
                Notion.</p>
            <div class="flex justify-end gap-2 mt-4">
                <button id="cancelDelete"
                    class="px-3 py-2 rounded-lg bg-surface border border-card text-main text-sm hover:bg-[color:var(--control-hover)]">Cancel</button>
                <button id="confirmDelete"
                    class="px-3 py-2 rounded-lg bg-[color:var(--accent-2)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-2-hover)] transition-all">Delete</button>
            </div>
        </div>
    </div>

    <!-- Reset Algorithm Confirmation Modal -->
    <div id="resetAlgorithmModal" role="dialog" aria-modal="true" aria-labelledby="resetAlgorithmTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[220]">
        <div class="card rounded-lg p-5 w-full max-w-md shadow-soft">
            <div class="flex items-center gap-3 mb-3">
                <div class="p-2 rounded-full bg-[color:var(--danger-soft-bg)]">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-[color:var(--danger-soft-text)]"></i>
                </div>
                <h3 id="resetAlgorithmTitle" class="modal-title font-display text-lg">Reset Algorithm Parameters</h3>
            </div>
            <div class="space-y-3 text-sm text-sub-strong ">
                <p>This will reset <strong>all spaced repetition data</strong> for every card in <span
                        id="resetDeckName" class="font-semibold text-main">this deck</span>:</p>
                <ul class="list-disc list-inside space-y-1 text-sub ml-2">
                    <li>Due dates will be cleared</li>
                    <li>Ease factors, intervals, and stability will reset</li>
                    <li>Review history will be preserved</li>
                    <li>Cards will appear as new again</li>
                </ul>
                <div
                    class="p-3 rounded-lg bg-accent-2-soft border border-[color:var(--accent-2)]/60 flex items-start gap-2">
                    <i data-lucide="cloud-upload" class="w-4 h-4 text-accent-2 mt-0.5 shrink-0"></i>
                    <p class="text-sub text-xs">These changes will be synced to Notion. This
                        action cannot be
                        undone.</p>
                </div>
                <div id="resetProgressContainer" class="hidden mt-4 space-y-1">
                    <div class="flex justify-between text-xs text-sub ">
                        <span id="resetProgressText">Resetting...</span>
                        <span id="resetProgressPercent">0%</span>
                    </div>
                    <div class="h-1.5 bg-surface-muted rounded-full overflow-hidden">
                        <div id="resetProgressBar"
                            class="h-full bg-[color:var(--danger-bg)] transition-all duration-300" style="width: 0%">
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-5">
                <button id="cancelResetAlgorithm"
                    class="px-4 py-2 rounded-lg bg-surface border border-card text-main text-sm hover:bg-surface-strong">Cancel</button>
                <button id="confirmResetAlgorithm"
                    class="px-4 py-2 rounded-lg bg-[color:var(--danger-bg)] text-[color:var(--danger-text)] text-sm hover:bg-[color:var(--danger-bg-hover)] flex items-center gap-2">
                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                    Reset All Cards
                </button>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[200]">
        <div id="settingsCard" class="card rounded-lg p-5 w-full max-w-3xl shadow-soft max-h-[90vh] overflow-y-auto">
            <div class="sticky top-[-20px] pt-[20px] -mt-[20px] z-20 bg-[color:var(--surface)] pb-2 space-y-3">
                <div class="flex items-center justify-between">
                    <h3 id="settingsTitle" class="modal-title font-display text-lg">Settings</h3>
                    <div class="flex items-center gap-2">
                        <button id="saveSettings"
                            class="px-3 py-1.5 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:bg-[color:var(--accent)] inline-flex items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>Save
                        </button>
                        <button id="closeSettings" aria-label="Close settings" class="text-muted hover:text-main"><i
                                data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <!-- Combined Sticky Header: Status + Vault -->
                <div class="space-y-3">
                    <!-- Status bar -->
                    <div class="rounded-lg border border-card p-3 bg-[color:var(--surface-strong)]">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="shield-check" class="w-4 h-4 text-accent "></i>
                                <p class="font-semibold text-main text-sm">Status</p>
                            </div>
                            <div id="q2syncIndicator"
                                class="hidden flex items-center gap-1.5 px-2 py-0.5 rounded bg-surface-muted border border-[color:var(--border-faint)] whitespace-nowrap min-w-max">
                                <span class="relative flex h-1.5 w-1.5">
                                    <span
                                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[color:var(--dull-purple)] opacity-75"></span>
                                    <span
                                        class="relative inline-flex rounded-full h-1.5 w-1.5 bg-[color:var(--dull-purple)]"></span>
                                </span>
                                <span class="font-mono text-[9px] font-medium text-[color:var(--text-sub)]"><span
                                        id="q2syncCount">0</span> items in q2sync</span>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-4 text-xs text-sub-strong ">
                            <span id="statusWorker">Worker: missing</span>
                            <span id="statusAuth">Auth: missing</span>
                            <span id="statusSources">Sources: missing</span>
                        </div>
                    </div>
                    <!-- Offline vault (shown only when setup) -->
                    <div id="vaultStatusSection" class="hidden">
                        <div class="rounded-lg border border-card p-3 bg-surface ">
                            <div class="flex items-center gap-2">
                                <i data-lucide="database" class="w-4 h-4 text-accent "></i>
                                <p class="font-semibold text-main text-sm">Offline vault</p>
                            </div>
                            <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                                <div class="rounded-lg bg-surface-strong p-3">
                                    <p class="text-muted text-[10px] uppercase tracking-wider font-semibold">
                                        Decks cached</p>
                                    <p id="deckCount" class="text-xl font-semibold text-main ">0</p>
                                </div>
                                <div class="rounded-lg bg-surface-strong p-3">
                                    <p class="text-muted text-[10px] uppercase tracking-wider font-semibold">
                                        Entries cached</p>
                                    <p id="cardCount" class="text-xl font-semibold text-main ">0</p>
                                </div>
                                <div class="rounded-lg bg-surface p-3 border border-weak">
                                    <p class="text-muted text-[10px] uppercase tracking-wider font-semibold">
                                        Pending sync</p>
                                    <p id="queueCount" class="text-xl font-semibold text-main ">0</p>
                                </div>
                                <div class="rounded-lg bg-surface p-3 border border-weak">
                                    <p class="text-muted text-[10px] uppercase tracking-wider font-semibold">
                                        Last sync</p>
                                    <p id="lastSync" class="text-sm font-semibold text-main truncate mt-1">—</p>
                                </div>
                            </div>
                            <p class="mt-3 text-[10px] text-muted ">IndexedDB holds all
                                decks/cards/FSRS/notes for offline-first use.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-6 text-sm mt-4">
                <div class="space-y-4">
                    <!-- Worker Proxy Accordion -->
                    <details id="workerSettingsDetails" class="group" open>
                        <summary
                            class="flex items-center gap-2 font-display text-base text-main cursor-pointer select-none py-1 mb-2 hover:text-accent transition-colors list-none outline-none">
                            <i data-lucide="chevron-right"
                                class="w-4 h-4 transition-transform group-open:rotate-90"></i>
                            <span>Worker Proxy</span>
                        </summary>
                        <div class="space-y-4 pl-2 border-l-2 border-faint ml-1.5">
                            <div class="rounded-lg border border-card p-3 bg-surface ">
                                <div class="flex items-center justify-between">
                                    <p class="font-semibold text-main text-sm">Configuration</p>
                                    <button id="openWorkerHelp"
                                        class="px-3 py-1.5 rounded-md bg-[color:var(--surface-strong)] text-[color:var(--text-main)] text-xs border border-[color:var(--card-border)] flex items-center gap-2 hover:bg-[color:var(--surface)] transition-all">
                                        <i data-lucide="code" class="w-4 h-4"></i> Worker code
                                    </button>
                                </div>
                                <p class="text-xs text-sub mt-1">Add Cloudflare Worker URL
                                    even if you plan to sign in with Notion.</p>
                            </div>
                            <div>
                                <label class="text-xs text-sub">Cloudflare Worker URL</label>
                                <input id="settingWorkerUrl" type="text" placeholder="https://your-proxy.workers.dev"
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2">
                            </div>
                            <form autocomplete="off" onsubmit="return false;">
                                <input type="text" name="username" autocomplete="username" class="sr-only" tabindex="-1"
                                    aria-hidden="true">
                                <label class="text-xs text-sub">Proxy token (optional)</label>
                                <input id="settingProxyToken" type="password" autocomplete="new-password"
                                    placeholder="ALL_CORS_PROXY_MATCH_TOKEN"
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2">
                            </form>
                            <button id="verifyWorker"
                                class="px-3 py-2 rounded-lg bg-surface-strong text-main text-sm border border-card w-full">Verify
                                worker</button>
                        </div>
                    </details>

                    <!-- Notion Integration Accordion -->
                    <details id="notionSettingsDetails" class="group" open>
                        <summary
                            class="flex items-center gap-2 font-display text-base text-main cursor-pointer select-none py-1 mb-2 hover:text-accent transition-colors list-none outline-none">
                            <i data-lucide="chevron-right"
                                class="w-4 h-4 transition-transform group-open:rotate-90"></i>
                            <span>Notion Integration</span>
                        </summary>
                        <div class="space-y-4 pl-2 border-l-2 border-faint ml-1.5">
                            <div class="text-sm text-sub mb-2">
                                Please duplicate this <a
                                    href="https://mimansajaiswal-embedded-dbs.notion.site/ghostink-template"
                                    target="_blank" rel="noopener noreferrer"
                                    class="text-accent hover:underline font-medium inline-flex items-center gap-0.5 align-baseline">Template</a><br>
                                <div class="text-xs text-fainter mb-2">
                                    If using custom, ensure all property names and options match exactly
                                    (case-sensitive); extra properties are allowed.
                                </div>
                            </div>
                            <form autocomplete="off" onsubmit="return false;">
                                <input type="text" name="username" autocomplete="username" class="sr-only" tabindex="-1"
                                    aria-hidden="true">
                                <label class="text-xs text-sub">Notion integration secret (instead of
                                    OAuth)</label>
                                <input id="settingAuthToken" type="password" autocomplete="new-password"
                                    placeholder="secret_..."
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 disabled:opacity-60 disabled:cursor-not-allowed">
                            </form>
                            <button id="verifyAuth"
                                class="px-3 py-2 rounded-lg bg-surface-strong text-main text-sm border border-card w-full disabled:opacity-60 disabled:cursor-not-allowed">Verify
                                Notion token</button>
                            <button id="oauthBtn"
                                class="w-full px-3 py-2 rounded-lg border border-[color:var(--accent)] text-accent text-sm hover:bg-surface-strong flex items-center gap-2 justify-center disabled:opacity-60 disabled:cursor-not-allowed">
                                <i data-lucide="log-in" class="w-4 h-4"></i>Sign in with Notion
                            </button>
                            <div>
                                <label class="text-xs text-muted">Decks source</label>
                                <select id="deckSourceSelect" disabled
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm disabled:opacity-60 disabled:cursor-not-allowed"></select>
                            </div>
                            <div>
                                <label class="text-xs text-muted">Cards source</label>
                                <select id="cardSourceSelect" disabled
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm disabled:opacity-60 disabled:cursor-not-allowed"></select>
                            </div>
                            <div class="flex gap-2">
                                <button id="scanSources" disabled
                                    class="w-1/3 px-3 py-2 rounded-lg bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--badge-bg-hover)] disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:bg-[color:var(--badge-bg)]">Scan</button>
                                <button id="saveSourcesChoice" disabled
                                    class="w-2/3 px-3 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                                    <i data-lucide="save" class="w-4 h-4"></i> Save selection
                                </button>
                            </div>
                            <div class="w-full h-2 bg-surface-strong rounded-full overflow-hidden">
                                <div id="syncProgress"
                                    class="h-2 bg-[color:var(--accent)]/60 w-0 transition-all duration-500"></div>
                            </div>
                        </div>
                    </details>
                </div>
                <div class="space-y-4">
                    <div class="sm:hidden rounded-lg border border-card p-3 bg-surface ">
                        <div class="flex items-center justify-between gap-2 mb-2">
                            <div class="flex items-center gap-2">
                                <i data-lucide="smartphone" class="w-4 h-4 text-accent "></i>
                                <p class="font-semibold text-main ">Mobile layout</p>
                            </div>
                        </div>
                        <p class="text-[11px] text-muted ">Choose where the study
                            joystick/action cluster should appear on mobile screens.</p>
                        <div class="mt-3 space-y-2">
                            <label class="flex items-center gap-2 text-xs text-sub ">
                                <input id="fabEnabledToggle" type="checkbox" class="accent-dull-purple" checked>
                                <span>Enable mobile FAB controls</span>
                            </label>
                            <div id="fabPosControls" class="space-y-2">
                                <label class="text-xs text-sub ">FAB position
                                    (grid)</label>
                                <div class="flex items-center gap-2">
                                    <select id="fabPosCellSelect"
                                        class="flex-1 rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                        <option value="6">6</option>
                                        <option value="7">7</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                        <option value="15">15</option>
                                    </select>
                                    <span class="text-[10px] text-muted whitespace-nowrap">3×5
                                        + border</span>
                                </div>
                                <pre id="fabGridAscii"
                                    class="font-mono text-[11px] leading-[1.15] text-muted bg-surface-muted border border-weak rounded-lg p-2 overflow-hidden whitespace-pre"
                                    style="-webkit-text-size-adjust: 100%;"></pre>
                                <p class="text-[10px] text-muted ">Pick a number from the
                                    grid
                                    (1 = top-left, 15 = bottom-right). Applies on screens ≤ 640px wide.</p>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border border-card p-3 bg-surface ">
                        <div class="flex items-center gap-2">
                            <i data-lucide="bot" class="w-4 h-4 text-accent "></i>
                            <p class="font-semibold text-main ">AI Judge</p>
                        </div>
                        <p class="text-[11px] text-sub mb-2">Checks your answer against the card.</p>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-sub">Provider</label>
                                <select id="aiProvider"
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                    <option value="">Disabled</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Claude</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                            </div>
                            <div id="aiProviderFields" class="space-y-2 hidden">
                                <div>
                                    <label class="text-xs text-sub">Model</label>
                                    <input id="aiModel" type="text"
                                        placeholder="gpt-4o-mini / claude-3-haiku / gemini-1.5-flash"
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                </div>
                                <form autocomplete="off" onsubmit="return false;">
                                    <input type="text" name="username" autocomplete="username" class="sr-only"
                                        tabindex="-1" aria-hidden="true">
                                    <input id="aiKey" type="password" autocomplete="new-password"
                                        placeholder="API key (kept locally)"
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                                </form>
                                <button id="verifyAi" data-tip="Requires internet"
                                    class="px-3 py-2 rounded-lg bg-surface-strong text-main text-sm border border-card w-full">Verify
                                    API keys</button>
                                <p class="text-[11px] text-muted">Keys stay on-device (localStorage). AI
                                    judging
                                    only runs if verified.</p>
                            </div>
                        </div>
                    </div>
                    <div class="rounded-lg border border-card p-3 bg-surface ">
                        <div class="flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4 text-accent "></i>
                            <p class="font-semibold text-main ">Dynamic Context Variants</p>
                        </div>
                        <p class="text-[11px] text-sub mb-2">Generates harder variants from your last card.</p>
                        <div class="space-y-2">
                            <div id="dyUseJudgeAiRow">
                                <label class="flex items-center gap-2 text-xs text-sub">
                                    <input id="dyUseJudgeAi" type="checkbox" class="accent-dull-purple">
                                    <span>Use AI judge settings</span>
                                </label>
                            </div>
                            <div id="dyProviderFields" class="space-y-2 hidden">
                                <div>
                                    <label class="text-xs text-sub">Provider</label>
                                    <select id="dyProvider"
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                        <option value="">Disabled</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Claude</option>
                                        <option value="gemini">Gemini</option>
                                    </select>
                                </div>
                                <div id="dyProviderDetailFields" class="space-y-2 hidden">
                                    <div>
                                        <label class="text-xs text-sub">Model</label>
                                        <input id="dyModel" type="text"
                                            placeholder="gpt-4o-mini / claude-3-haiku / gemini-1.5-flash"
                                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <input type="text" name="username" autocomplete="username" class="sr-only"
                                            tabindex="-1" aria-hidden="true">
                                        <input id="dyKey" type="password" autocomplete="new-password"
                                            placeholder="API key (kept locally)"
                                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                                    </form>
                                    <button id="verifyDyContextAi" data-tip="Requires internet"
                                        class="px-3 py-2 rounded-lg bg-surface-strong text-main text-sm border border-card w-full">Verify
                                        API keys</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Speech-to-Text Settings (only shown when AI mode is enabled) -->
                    <div id="sttSettings" class="rounded-lg border border-card p-3 bg-surface hidden">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="mic" class="w-4 h-4 text-accent"></i>
                            <p class="font-semibold text-main">Speech-to-text</p>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="text-xs text-sub">Provider</label>
                                <select id="sttProvider"
                                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                    <option value="">Disabled</option>
                                    <option value="browser">Browser</option>
                                    <option value="openai">OpenAI Whisper</option>
                                    <option value="gemini">Gemini</option>
                                    <option value="groq">Groq Whisper</option>
                                </select>
                            </div>
                            <div id="sttProviderFields" class="space-y-2 hidden">
                                <div>
                                    <label class="text-xs text-sub">Model</label>
                                    <input id="sttModel" type="text" placeholder="whisper-1 / gemini-2.0-flash"
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-2 py-2 text-sm">
                                </div>
                                <form autocomplete="off" onsubmit="return false;">
                                    <input type="text" name="username" autocomplete="username" class="sr-only"
                                        tabindex="-1" aria-hidden="true">
                                    <input id="sttKey" type="password" autocomplete="new-password"
                                        placeholder="API key (required for cloud providers)"
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                                </form>
                                <div>
                                    <label class="text-xs text-sub">Starter prompt (optional context)</label>
                                    <input id="sttPrompt" type="text" placeholder="e.g., Technical terms, names..."
                                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm mt-1">
                                </div>
                                <button id="verifyStt" data-tip="Requires internet"
                                    class="px-3 py-2 rounded-lg bg-surface-strong text-main text-sm border border-card w-full">Verify
                                    API keys</button>
                            </div>
                            <p class="text-[11px] text-muted">Browser uses free built-in speech recognition.
                                Cloud providers offer better accuracy.</p>
                            <p class="text-[10px] text-faint mt-1">
                                <i data-lucide="info" class="w-3 h-3 inline-block align-text-bottom mr-0.5"></i>
                                Browser STT requires Chrome/Edge. Safari/Firefox have limited support.
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Danger Zone spanning both columns -->
                <div class="md:col-span-2 mt-4 border-t border-weak pt-4">
                    <button id="toggleDangerZone"
                        class="w-full flex items-center justify-between text-sm text-accent-2 hover:text-accent-2 transition">
                        <span class="flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                            <span>Danger Zone</span>
                        </span>
                        <i data-lucide="chevron-down" id="dangerZoneChevron" class="w-4 h-4 transition-transform"></i>
                    </button>
                    <div id="dangerZoneContent"
                        class="hidden mt-3 p-3 rounded-lg bg-accent-2-soft border border-[color:var(--accent-2)]">
                        <p class="text-xs text-sub mb-3">This will permanently delete
                            all GhostInk data
                            including decks, cards, settings, and session data. Data synced to Notion will not be
                            affected.</p>
                        <button id="resetApp"
                            class="px-3 py-2 rounded-lg bg-[color:var(--accent-2)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-2-hover)] transition-all w-full">Reset
                            GhostInk</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Worker helper -->
    <div id="workerHelpModal"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[210]">
        <div class="card rounded-lg p-5 w-full max-w-3xl shadow-soft h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-3">
                <h3 class="modal-title font-display text-lg">Cloudflare Worker proxy</h3>
                <button id="closeWorkerHelp" class="text-muted hover:text-main"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto space-y-3 text-sm text-main">
                <p>Deploy this Worker to bypass CORS and forward Notion requests.</p>
                <ol class="list-decimal pl-6 space-y-2">
                    <li>Open <a class="text-accent underline" href="https://workers.cloudflare.com/"
                            target="_blank">Cloudflare Workers</a> and create a new Worker.</li>
                    <li>Replace its contents with the code below, save, and deploy.</li>
                    <li>(Optional) Add variable <code>ALL_CORS_PROXY_MATCH_TOKEN</code> to require a token.</li>
                    <li>Paste the Worker URL into Settings.</li>
                </ol>
                <div class="relative">
                    <button id="copyWorkerCode"
                        class="absolute top-2 right-2 bg-surface hover:bg-white px-2 py-1 rounded text-xs shadow text-main font-bold ">Copy</button>
                    <pre id="workerCodeBlock"
                        class="bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] p-4 rounded text-xs font-mono overflow-x-auto">
export default {
 async fetch(request, env) {
 return await handleRequest(request, env);
 },
};

function getCorsHeaders(request) {
 return {
 "Access-Control-Allow-Origin": request.headers.get("Origin") || "*",
 "Access-Control-Allow-Methods": "GET, HEAD, POST, PUT, PATCH, DELETE, OPTIONS",
 "Access-Control-Allow-Headers": "Content-Type, Authorization, Notion-Version",
 };
}

function handleOptions(request) {
 return new Response(null, {
 headers: getCorsHeaders(request),
 });
}

function withCors(request, response) {
 const corsHeaders = getCorsHeaders(request);
 const newResponse = new Response(response.body, response);
 for (const [key, value] of Object.entries(corsHeaders)) {
 newResponse.headers.set(key, value);
 }
 newResponse.headers.append("Vary", "Origin");
 return newResponse;
}

async function handleRequest(request, env) {
 if (request.method === "OPTIONS") {
 return handleOptions(request);
 }

 const url = new URL(request.url);
 const requiredToken = (env.ALL_CORS_PROXY_MATCH_TOKEN || "").trim();

 if (requiredToken !== "") {
 const providedToken = url.searchParams.get("token");
 if (providedToken !== requiredToken) {
 return withCors(request, new Response("Unauthorized", { status: 403 }));
 }
 url.searchParams.delete("token");
 }

 const targetUrlParam = url.searchParams.get("url");
 if (!targetUrlParam) {
 return withCors(request, new Response("Missing url parameter", { status: 400 }));
 }

 let targetUrl;
 try {
 targetUrl = new URL(targetUrlParam).toString();
 } catch (err) {
 return withCors(request, new Response("Invalid target URL", { status: 400 }));
 }

 const modifiedRequest = new Request(targetUrl, request);
 modifiedRequest.headers.set("Origin", new URL(targetUrl).origin);

 const response = await fetch(modifiedRequest);
 return withCors(request, response);
}
 </pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Deck modal -->
    <div id="deckModal" role="dialog" aria-modal="true" aria-labelledby="deckModalTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[200]">
        <div class="card rounded-lg p-5 w-full max-w-md shadow-soft max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h3 class="modal-title font-display text-lg" id="deckModalTitle">New deck</h3>
                <div class="flex items-center gap-2">
                    <button id="saveDeckTopBtn" aria-label="Save deck"
                        class="group p-1.5 rounded-lg border border-card text-main hover:bg-surface-strong">
                        <i data-lucide="save"
                            class="w-4 h-4 transition-transform duration-150 group-hover:scale-110 group-hover:text-accent"></i>
                    </button>
                    <button id="closeDeckModal" aria-label="Close deck modal" class="text-muted hover:text-main"><i
                            data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div class="space-y-3 text-sm">
                <input id="deckNameInput" type="text" placeholder="Deck name" maxlength="200"
                    class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2">
                <div>
                    <label class="text-xs text-sub">Algorithm</label>
                    <select id="deckAlgoInput"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2">
                        <option>SM-2</option>
                        <option>FSRS</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-sub">Daily review limit</label>
                        <input id="deckReviewLimit" type="number"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2" value="50">
                    </div>
                    <div>
                        <label class="text-xs text-sub">New card limit</label>
                        <input id="deckNewLimit" type="number"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2" value="20">
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-sub">Order mode</label>
                    <select id="deckOrderMode"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2">
                        <option value="none">None (shuffle)</option>
                        <option value="created">Created Time</option>
                        <option value="property">Order Property</option>
                    </select>
                    <p class="text-[11px] text-muted">Created time sorts by insertion time; Order property
                        sorts by each card’s “Order” number.</p>
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <input id="deckReverseInput" type="checkbox" class="accent-dull-purple">
                    <span>Reverse mode enabled</span>
                </label>
                <div>
                    <label class="text-xs text-sub">AI revision prompt (optional)</label>
                    <div id="deckPromptInput" contenteditable="true"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 min-h-[3.5rem] max-h-48 overflow-y-auto whitespace-pre-wrap font-mono text-xs focus:outline-none focus:ring-2 focus:ring-dull-purple/40 scroll-minimal"
                        role="textbox" aria-multiline="true"></div>
                    <div class="flex flex-wrap gap-2 mt-2 text-[11px] text-muted ">
                        <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{question}}</span>
                        <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{answer}}</span>
                        <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{user}}</span>
                    </div>
                    <p class="mt-2 text-[11px] text-sub ">Variables replace question,
                        correct answer, and learner answer.</p>
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <input id="deckDynamicContextInput" type="checkbox" class="accent-dull-purple">
                    <span>Dynamic Context?</span>
                </label>
                <div id="dyContextFields" class="space-y-2 hidden">
                    <div>
                        <label class="text-xs text-sub">Dynamic Context AI prompt (optional)</label>
                        <div id="deckDyPromptInput" contenteditable="true"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 min-h-[3.5rem] max-h-48 overflow-y-auto whitespace-pre-wrap font-mono text-xs focus:outline-none focus:ring-2 focus:ring-dull-purple/40 scroll-minimal"
                            role="textbox" aria-multiline="true"></div>
                        <div class="flex flex-wrap gap-2 mt-2 text-[11px] text-muted">
                            <span
                                class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{root_front}}</span>
                            <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{root_back}}</span>
                            <span
                                class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{root_notes}}</span>
                            <span
                                class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{prev_front}}</span>
                            <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{prev_back}}</span>
                            <span
                                class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{prev_notes}}</span>
                            <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{deck_name}}</span>
                            <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{tags}}</span>
                            <span class="px-2 py-1 rounded-lg bg-surface-muted italic text-accent ">{{card_type}}</span>
                        </div>
                        <p class="mt-2 text-[11px] text-sub">Variables replace root/previous text, tags, and card type.
                        </p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="text-xs text-sub">Learning steps (SM-2)</label>
                        <input id="deckLearningSteps" type="text" placeholder="1m,10m"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-sub">Relearning steps (SM-2)</label>
                        <input id="deckRelearningSteps" type="text" placeholder="10m"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono">
                    </div>
                    <div>
                        <label class="text-xs text-sub">Graduating interval</label>
                        <input id="deckGraduatingInterval" type="text" placeholder="1d"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono">
                    </div>
                    <div>
                        <label class="text-xs text-sub">Easy interval</label>
                        <input id="deckEasyInterval" type="text" placeholder="4d"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono">
                    </div>
                    <div class="col-span-2">
                        <label class="text-xs text-sub">Easy days</label>
                        <input id="deckEasyDays" type="text" placeholder="Sat,Sun"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono">
                    </div>
                </div>
                <div id="fsrsParamsField" class="hidden">
                    <div class="grid grid-cols-2 gap-3 items-end">
                        <div>
                            <label class="text-xs text-sub">FSRS desired retention</label>
                            <input id="deckFsrsDesiredRetention" type="number" step="0.01" min="0.01" max="0.99"
                                class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono"
                                placeholder="0.90">
                        </div>
                    </div>
                    <label class="text-xs text-sub mt-2 block">FSRS v6 weights (21 numbers)</label>
                    <textarea id="deckFsrsParams" rows="2"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-xs font-mono"
                        placeholder="0.212, 1.2931, ..."></textarea>
                    <div class="flex items-center justify-between gap-2 mt-2">
                        <button id="optimizeFsrsBtn"
                            class="px-3 py-2 rounded-lg border border-weak text-main text-xs hover:bg-surface-muted ">
                            Optimize FSRS weights
                        </button>
                        <span class="text-[10px] text-muted">Uses this deck’s review history</span>
                    </div>
                    <p class="text-[10px] text-muted mt-1">Leave retention empty to use 0.90. Leave weights
                        empty to use defaults. These sync via the Notion “SRS Config” property.</p>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="archiveDeckBtn"
                    class="px-3 py-2 rounded-lg border border-weak text-main text-sm hidden">Archive
                    deck</button>
                <button id="saveDeckBtn"
                    class="px-4 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all">Save</button>
            </div>
        </div>
    </div>

    <!-- Card modal -->
    <div id="cardModal" role="dialog" aria-modal="true" aria-labelledby="cardModalTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[200]">
        <div class="card rounded-lg p-5 w-full max-w-2xl shadow-soft max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-3">
                <h3 class="modal-title font-display text-lg" id="cardModalTitle">New card</h3>
                <div class="flex items-center gap-2">
                    <button id="openCardNotionBtn" aria-label="Open in Notion"
                        class="p-1.5 rounded-lg border border-card text-main hover:bg-surface-strong hidden"
                        title="Open page in Notion">
                        <i data-lucide="external-link" class="w-4 h-4"></i>
                    </button>
                    <button id="saveCardTopBtn" aria-label="Save card"
                        class="group p-1.5 rounded-lg border border-card text-main hover:bg-surface-strong">
                        <i data-lucide="save"
                            class="w-4 h-4 transition-transform duration-150 group-hover:scale-110 group-hover:text-accent"></i>
                    </button>
                    <button id="closeCardModal" aria-label="Close card modal" class="text-muted hover:text-main"><i
                            data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <p class="text-[10px] text-faint mb-2">Editing Name, Back, or Notes will remove
                Notion text colors
                and highlights on sync</p>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div class="space-y-2">
                    <label class="text-xs text-sub">Deck</label>
                    <select id="cardDeckInput"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2"></select>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-sub">Card type</label>
                    <select id="cardTypeInput"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2">
                        <option value="Front-Back">Front / Back</option>
                        <option value="Cloze">Cloze</option>
                    </select>
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="text-xs text-sub">Name</label>
                    <textarea id="cardNameInput" rows="3"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="flex items-center gap-2 text-sm text-[color:var(--text-main)]">
                        <input id="cardMarkedInput" type="checkbox" class="accent-dull-purple">
                        <span>Marked</span>
                    </label>
                </div>
                <div class="space-y-2">
                    <label class="text-xs text-sub">Flag</label>
                    <input id="cardFlagInput" type="hidden" value="">
                    <div id="cardFlagSwatches" class="flag-swatch-row">
                        <button type="button" class="flag-swatch-btn" data-flag="" aria-label="No flag">
                            <span class="flag-swatch is-none"></span>
                        </button>
                        <button type="button" class="flag-swatch-btn" data-flag="Red" aria-label="Red flag">
                            <span class="flag-swatch flag-red"></span>
                        </button>
                        <button type="button" class="flag-swatch-btn" data-flag="Orange" aria-label="Orange flag">
                            <span class="flag-swatch flag-orange"></span>
                        </button>
                        <button type="button" class="flag-swatch-btn" data-flag="Yellow" aria-label="Yellow flag">
                            <span class="flag-swatch flag-yellow"></span>
                        </button>
                        <button type="button" class="flag-swatch-btn" data-flag="Green" aria-label="Green flag">
                            <span class="flag-swatch flag-green"></span>
                        </button>
                        <button type="button" class="flag-swatch-btn" data-flag="Blue" aria-label="Blue flag">
                            <span class="flag-swatch flag-blue"></span>
                        </button>
                        <button type="button" class="flag-swatch-btn" data-flag="Purple" aria-label="Purple flag">
                            <span class="flag-swatch flag-purple"></span>
                        </button>
                    </div>
                </div>
                <div id="cardBackSection" class="md:col-span-2 space-y-2">
                    <label class="text-xs text-sub">Back</label>
                    <textarea id="cardBackInput" rows="4"
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2"></textarea>
                </div>
                <div class="md:col-span-2 space-y-2">
                    <label class="text-xs text-sub">Notes (markdown)</label>
                    <textarea id="cardNotesInput" rows="3" placeholder="Add notes for this card..."
                        class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2"></textarea>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="text-xs text-sub">Tags</label>
                        <button id="refreshTagOptionsBtn" class="p-1 rounded-lg hover:bg-surface-strong text-accent"
                            title="Refresh tags from Notion">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="relative">
                        <input id="cardTagSearch" type="text" placeholder="Search or add tag" maxlength="100"
                            class="w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm">
                        <div id="cardTagDropdown"
                            class="hidden absolute left-0 right-0 z-40 mt-1 max-h-44 overflow-y-auto rounded-lg border border-card bg-[color:var(--card-bg)] shadow-lg">
                        </div>
                    </div>
                    <div id="cardTagSelected" class="flex flex-wrap gap-1.5 mt-1"></div>
                </div>
                <div id="cardOrderField" class="space-y-2 hidden">
                    <label class="text-xs text-sub">Order</label>
                    <input id="cardOrderInput" type="text" placeholder="Optional (e.g. 1.1)"
                        class="w-full rounded-md border border-[color:var(--card-border)] bg-[color:var(--surface)] px-3 py-2 text-sm text-[color:var(--text-main)] placeholder:text-[color:var(--text-sub)] focus:border-blue-500 focus:outline-none transition-colors">
                </div>
                <div id="cardSuspendedLeechField" class="space-y-2 hidden">
                    <label class="text-xs text-sub">Suspended / Leech</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="flex items-center gap-2"><input id="cardSuspendedInput" type="checkbox"
                                class="accent-dull-purple"> Suspended</label>
                        <label class="flex items-center gap-2"><input id="cardLeechInput" type="checkbox"
                                class="accent-dull-purple"> Leech</label>
                    </div>
                </div>
            </div>
            <!-- Review History Section (shown when editing existing card) -->
            <div id="cardReviewHistorySection" class="mt-4 hidden">
                <details class="group">
                    <summary class="text-xs text-sub cursor-pointer select-none flex items-center gap-1">
                        <i data-lucide="chevron-right" class="w-3 h-3 group-open:rotate-90 transition-transform"></i>
                        Review History (<span id="cardReviewHistoryCount">0</span>)
                    </summary>
                    <div id="cardReviewHistoryTable"
                        class="mt-2 max-h-40 overflow-y-auto border border-weak rounded-lg"></div>
                </details>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button id="deleteCardBtn"
                    class="px-3 py-2 rounded-lg border border-[color:var(--accent-2)] text-accent-2 text-sm hidden">Delete
                    card</button>
                <button id="saveCardBtn"
                    class="px-4 py-2 rounded-lg bg-[color:var(--badge-bg)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--badge-bg-hover)] ">Save</button>
            </div>
        </div>
    </div>

    <!-- Shortcuts modal -->
    <div id="shortcutsModal" role="dialog" aria-modal="true" aria-labelledby="shortcutsModalTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[210]">
        <div class="card rounded-lg p-5 w-full max-w-2xl shadow-soft max-h-[90vh] overflow-y-auto shortcuts-card">
            <div class="shortcuts-header">
                <div>
                    <h3 class="modal-title font-display text-lg" id="shortcutsModalTitle">Keyboard
                        shortcuts</h3>
                    <p class="text-xs text-[color:var(--text-sub)]">Quick actions by mode</p>
                </div>
                <button id="closeShortcutsModal" aria-label="Close shortcuts"
                    class="p-1.5 rounded-sm border border-[color:var(--card-border)] text-[color:var(--text-sub)] hover:text-[color:var(--text-main)] hover:bg-[color:var(--surface-strong)]">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcuts-section">
                    <p class="shortcuts-section-title">Study</p>
                    <div class="shortcuts-list">
                        <div class="shortcut-row"><span>Reveal</span><kbd class="shortcut-key">Space</kbd></div>
                        <div class="shortcut-row"><span>Skip</span><kbd class="shortcut-key">S</kbd></div>
                        <div class="shortcut-row"><span>Again / Hard / Good / Easy</span><kbd
                                class="shortcut-key">1–4</kbd></div>
                        <div class="shortcut-row"><span>Mark</span><kbd class="shortcut-key">M</kbd></div>
                        <div class="shortcut-row"><span>Flag (cycle)</span><kbd class="shortcut-key">F</kbd></div>
                        <div class="shortcut-row"><span>Clear flag</span><kbd class="shortcut-key">Shift + F</kbd></div>
                    </div>
                </div>
                <div class="shortcuts-section">
                    <p class="shortcuts-section-title">Sessions</p>
                    <div class="shortcuts-list">
                        <div class="shortcut-row"><span>Start session</span><kbd class="shortcut-key"
                                id="shortcutsStartSession">⌘/Ctrl + Enter</kbd></div>
                        <div class="shortcut-row"><span>Stop session</span><kbd class="shortcut-key"
                                id="shortcutsStopSession">⌘/Ctrl + .</kbd></div>
                        <div class="shortcut-row"><span>Undo rating</span><kbd class="shortcut-key"
                                id="shortcutsUndo">⌘/Ctrl + Z</kbd></div>
                    </div>
                </div>
                <div class="shortcuts-section shortcuts-section-wide">
                    <p class="shortcuts-section-title">AI mode</p>
                    <div class="shortcuts-list">
                        <div class="shortcut-row"><span>Send answer</span><kbd class="shortcut-key"
                                id="shortcutsSend">⌘/Ctrl + Enter</kbd></div>
                        <div class="shortcut-row"><span>Toggle mic</span><kbd class="shortcut-key"
                                id="shortcutsMic">⌘/Ctrl + E</kbd></div>
                        <div class="shortcut-row"><span>Skip (AI)</span><kbd class="shortcut-key">Alt + Shift + S</kbd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Settings Required Modal -->
    <div id="aiSettingsRequiredModal"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[210]">
        <div
            class="card rounded-lg p-5 w-full max-w-md shadow-soft text-center space-y-4 bg-[color:var(--card-bg)] border border-[color:var(--card-border)]">
            <div class="w-12 h-12 rounded-full bg-accent-soft flex items-center justify-center mx-auto">
                <i data-lucide="bot" class="w-6 h-6 text-accent"></i>
            </div>
            <h3 id="aiSettingsModalTitle" class="modal-title font-display text-lg">AI not available
            </h3>
            <p id="aiSettingsModalBody" class="text-sm text-sub "></p>
            <div id="aiSettingsModalActions" class="flex gap-2 justify-center">
                <button id="closeAiSettingsModal"
                    class="px-4 py-2 rounded-lg border border-card text-main text-sm">Close</button>
                <button id="openSettingsFromAiModal"
                    class="px-4 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all">Open
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- Notes Edit Modal -->
    <div id="notesModal" role="dialog" aria-modal="true" aria-labelledby="notesModalTitle"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[210]">
        <div class="card rounded-lg p-5 w-full max-w-lg shadow-soft space-y-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between">
                <h3 id="notesModalTitle" class="modal-title font-display text-lg">Edit Notes</h3>
                <button id="closeNotesModal" aria-label="Close notes modal"
                    class="p-1.5 rounded-lg hover:bg-surface-strong text-main">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-xs text-sub ">Write notes in Markdown format. They will be
                synced to Notion.</p>
            <textarea id="notesArea" rows="12"
                class="flex-1 w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm font-mono resize-none focus:outline-none focus:ring-2 focus:ring-dull-purple/40"
                placeholder="Add notes for this card..."></textarea>
            <div class="flex items-center justify-between">
                <span id="noteStatus" class="text-xs text-muted"></span>
                <div class="flex gap-2">
                    <button id="cancelNotesBtn"
                        class="px-4 py-2 rounded-lg border border-card text-main text-sm">Cancel</button>
                    <button id="saveNotesBtn"
                        class="px-4 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="resetConfirmModal"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[220]">
        <div class="card rounded-lg p-5 w-full max-w-sm shadow-soft">
            <div class="flex items-center gap-3 mb-3">
                <div class="p-2 rounded-full bg-[color:var(--accent-2)]/20">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-accent-2"></i>
                </div>
                <h3 class="modal-title font-display text-lg">Reset GhostInk?</h3>
            </div>
            <p class="text-sm text-sub mb-4">This will permanently delete all local data
                including decks,
                cards, settings, and study session. This cannot be undone.</p>
            <div class="flex justify-end gap-2">
                <button id="cancelReset"
                    class="px-4 py-2 rounded-lg border border-card text-main hover:bg-[color:var(--control-hover)] text-sm">Cancel</button>
                <button id="confirmReset"
                    class="px-4 py-2 rounded-lg bg-[color:var(--accent-2)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-2-hover)] transition-all">Reset</button>
            </div>
        </div>
    </div>

    <!-- Add Block Note Modal -->
    <div id="addBlockModal"
        class="fixed inset-0 bg-[color:var(--overlay-bg)] backdrop-blur-sm hidden items-center justify-center p-4 z-[210]">
        <div class="card rounded-lg p-5 w-full max-w-lg shadow-soft space-y-4 max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between">
                <h3 class="modal-title font-display text-lg">Add Note to Page</h3>
                <button id="closeAddBlockModal" class="p-1.5 rounded-lg hover:bg-surface-strong text-main">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-xs text-sub ">This will be appended as a new paragraph on the
                Notion page with a
                timestamp.</p>
            <textarea id="blockNoteArea" rows="8"
                class="flex-1 w-full rounded-lg border border-card bg-[var(--surface)] px-3 py-2 text-sm font-mono resize-none focus:outline-none focus:ring-2 focus:ring-dull-purple/40"
                placeholder="Write in Markdown..."></textarea>
            <div class="rounded-lg border border-[color:var(--card-border)] p-3 bg-[color:var(--surface)] ">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold text-main ">Preview</span>
                    <span class="text-[11px] text-muted ">Timestamp added on save</span>
                </div>
                <div id="blockNotePreview"
                    class="md-content text-xs text-[color:var(--text-main)] max-h-40 overflow-y-auto scroll-minimal">
                    <p class="text-faint ">Type a note to preview media embeds.</p>
                </div>
            </div>
            <div class="flex items-center justify-end gap-2">
                <button id="cancelAddBlockBtn"
                    class="px-4 py-2 rounded-lg border border-card text-main text-sm">Cancel</button>
                <button id="saveAddBlockBtn"
                    class="px-4 py-2 rounded-lg bg-[color:var(--accent)] text-[color:var(--badge-text)] text-sm hover:bg-[color:var(--accent-hover)] transition-all">Add
                    to
                    Page</button>
            </div>
        </div>
    </div>


    <script>
        (function () {
            if (window.__ghostinkStartup) return;

            const showStartupError = (detail) => {
                const render = () => {
                    document.body.classList.remove('preinit');
                    let wrap = document.getElementById('startupError');
                    if (!wrap) {
                        wrap = document.createElement('div');
                        wrap.id = 'startupError';
                        wrap.style.cssText = [
                            'position:fixed',
                            'inset:0',
                            'display:flex',
                            'align-items:center',
                            'justify-content:center',
                            'padding:24px',
                            'background:#0f0f12',
                            'color:#f2f2f4',
                            'z-index:300'
                        ].join(';');
                        const card = document.createElement('div');
                        card.style.cssText = [
                            'max-width:520px',
                            'width:100%',
                            'background:#15161a',
                            'border:1px solid #2a2d33',
                            'border-radius:16px',
                            'padding:20px 22px',
                            'font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',
                            'font-size:14px',
                            'line-height:1.4'
                        ].join(';');
                        const title = document.createElement('div');
                        title.style.cssText = 'font-size:16px;font-weight:700;margin-bottom:8px;';
                        title.textContent = 'GhostInk failed to start';
                        const body = document.createElement('div');
                        body.style.cssText = 'opacity:0.9;margin-bottom:10px;';
                        body.textContent = 'Check your connection, CDN availability, and refresh the page.';
                        card.appendChild(title);
                        card.appendChild(body);
                        wrap.appendChild(card);
                        document.body.appendChild(wrap);
                    }
                    if (detail && wrap.firstChild) {
                        const detailLine = document.createElement('div');
                        detailLine.style.cssText = 'opacity:0.6;font-size:12px;word-break:break-word;';
                        detailLine.textContent = String(detail);
                        wrap.firstChild.appendChild(detailLine);
                    }
                };
                if (document.body) render();
                else document.addEventListener('DOMContentLoaded', render, { once: true });
            };

            const timer = setTimeout(() => {
                if (window.__ghostinkStartup?.readyFlag) return;
                showStartupError('Startup timeout');
            }, 12000);

            window.__ghostinkStartup = {
                readyFlag: false,
                ready() {
                    this.readyFlag = true;
                    clearTimeout(timer);
                    const el = document.getElementById('startupError');
                    if (el) el.remove();
                },
                fail(err) {
                    clearTimeout(timer);
                    showStartupError(err && err.message ? err.message : 'Startup failed');
                }
            };
        })();
    </script>

    <script type="module">
        import { App } from './js/app.js';
        import { toast } from './js/ui/index.js';

        document.addEventListener('DOMContentLoaded', async () => {
            document.body.classList.remove('preinit');
            try {
                await App.init();
                window.__ghostinkStartup?.ready();
            } catch (e) {
                console.error('Failed to initialize GhostInk', e);
                toast('Startup failed – see console for details');
                window.__ghostinkStartup?.fail(e);
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => { });
            });
        }
    </script>
</body>

</html>