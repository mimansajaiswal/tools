<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer Bingo</title>

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        oatmeal: '#F3EFE6',
                        earth: '#4A4E4D',
                        charcoal: '#2C3E50',
                        linen: '#FAF0E6',
                        dullpurple: '#9B8EA9',
                        mutedpink: '#D8A7B1',
                        success: '#8EA99B',
                    },
                    fontFamily: {
                        serif: ['Merriweather', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    animation: {
                        'toast-in': 'toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'toast-out': 'toastOut 0.3s ease-in forwards',
                        'modal-in': 'modalIn 0.2s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        toastIn: {
                            '0%': { transform: 'translate(-50%, 100%)', opacity: '0' },
                            '100%': { transform: 'translate(-50%, 0)', opacity: '1' },
                        },
                        toastOut: {
                            '0%': { transform: 'translate(-50%, 0)', opacity: '1' },
                            '100%': { transform: 'translate(-50%, 100%)', opacity: '0' },
                        },
                        modalIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F3EFE6;
            color: #4A4E4D;
            font-family: 'Merriweather', serif;
        }

        .cell-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Ensure textarea aligns perfectly with line numbers */
        textarea.sync-scroll {
            line-height: 1.5rem !important;
            /* leading-6 */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .line-numbers-col {
            line-height: 1.5rem !important;
            /* leading-6 */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Utils ---
        const generateId = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_DIM = 400;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_DIM) { height *= MAX_DIM / width; width = MAX_DIM; }
                        } else {
                            if (height > MAX_DIM) { width *= MAX_DIM / height; height = MAX_DIM; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/webp', 0.25));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const PALETTE = [
            { name: 'Earth', hex: '#4A4E4D', class: 'border-[#4A4E4D] bg-[#4A4E4D]/10 text-[#4A4E4D]' },
            { name: 'Purple', hex: '#9B8EA9', class: 'border-[#9B8EA9] bg-[#9B8EA9]/10 text-[#9B8EA9]' },
            { name: 'Pink', hex: '#D8A7B1', class: 'border-[#D8A7B1] bg-[#D8A7B1]/10 text-[#D8A7B1]' },
            { name: 'Green', hex: '#8EA99B', class: 'border-[#8EA99B] bg-[#8EA99B]/10 text-[#8EA99B]' },
            { name: 'Blue', hex: '#60A5FA', class: 'border-blue-400 bg-blue-400/10 text-blue-600' },
            { name: 'Orange', hex: '#FB923C', class: 'border-orange-400 bg-orange-400/10 text-orange-600' },
            { name: 'Red', hex: '#F87171', class: 'border-red-400 bg-red-400/10 text-red-600' },
            { name: 'Indigo', hex: '#818CF8', class: 'border-indigo-400 bg-indigo-400/10 text-indigo-600' },
            { name: 'Teal', hex: '#2DD4BF', class: 'border-teal-400 bg-teal-400/10 text-teal-600' },
            { name: 'Lime', hex: '#A3E635', class: 'border-lime-400 bg-lime-400/10 text-lime-600' },
            { name: 'Magenta', hex: '#E879F9', class: 'border-fuchsia-400 bg-fuchsia-400/10 text-fuchsia-600' },
            { name: 'Cyan', hex: '#22D3EE', class: 'border-cyan-400 bg-cyan-400/10 text-cyan-600' },
        ];

        // Sleeping Cat SVG as a Data URI for portability
        const CAT_SVG = `<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 2372 1898" style="enable-background:new 0 0 2372 1898;" xml:space="preserve"><g><path style="fill:#C3B5AA;" d="M1866.856,682.422c-35.16-67.482-90.6-121.145-156.564-158.441c-4.764-2.694-3.464-8.471,0.041-10.813c-94.925-54.498-207.638-70.885-316.741-51.633c-242.472,42.785-326.994,214.814-326.994,214.814c-1.442-1.415-2.808-2.938-4.134-4.516c2.159,5.628,4.316,11.255,6.474,16.882c2.934,7.654-9.354,10.935-12.253,3.378c-7.694-20.065-15.389-40.13-23.084-60.195c-2.06-5.371-3.978-10.874-6.077-16.287c-9.215-11.079-20.907-18.023-38.778-15.163c-8.006,8.069-14.05,19.833-18.838,27.674c-10.436,17.085-20.868,34.169-31.302,51.254c0.016,2.546-1.798,5.237-4.399,6.368c-2.941,2.289-7.12,1.102-9.145-1.585c-57.189-23.792-122.38-24.809-180.488-3.513c-2.864,1.05-5.115,0.007-6.425-1.857c-0.683,0.48-1.502,0.79-2.459,0.94c-3.154,1.106-7.14,0.107-8.379-4.011c-6.662-22.145-16.74-42.996-30.053-61.917c-2.793-3.97-5.759-7.837-8.834-11.615c-1.933-1.117-3.962-2.187-6.159-3.176c-34.646-15.592-68.998,12.926-96.52,48.906c-7.68,13.614-14.277,27.819-19.536,42.572c-1.735,4.869-7.315,5.289-10.453,2.976c-8.743,15.117-15.819,28.913-20.698,38.634c-17.286,34.441-37.389,84.355-49.301,135.647c45.677,10.133,90.684,22.801,135.399,37.65c7.061,2.345,4.016,13.54-3.083,11.183c-44.521-14.785-89.334-27.401-134.807-37.513c-4.735,22.871-7.663,45.792-7.853,67.562c10.682-0.762,21.368-1.444,32.049-1.985c35.125-1.78,72.019-3.947,106.791,2.659c7.336,1.394,4.211,12.569-3.082,11.182c-33.665-6.396-69.711-3.968-103.709-2.245c-10.618,0.538-21.247,1.208-31.873,1.954c1.079,27.746,7.077,53.156,20.245,73.447c2.088,3.216,4.28,6.37,6.524,9.494c2.488,3.464,5.072,6.871,7.744,10.223c54.872,68.805,147.733,113.975,242.031,138.22c32.653-19.139,65.975-37.383,94.059-63.105c31.4-28.761,57.007-63.233,88.781-91.732c6.074-5.448,15.083,3.514,8.984,8.984c-33.797,30.313-60.679,67.563-94.961,97.234c-24.141,20.895-51.601,36.946-79.072,52.945c38.446,8.812,76.746,14.207,112.422,16.297c72.387,4.243,143.601,9.475,215.734-2.013c12.903-2.055,25.543-4.208,38.002-6.396c25.679-18.008,49.884-38.141,72.186-60.35c5.802-5.779,14.785,3.207,8.984,8.984c-16.619,16.549-34.327,31.97-52.873,46.307c65.495-11.844,127.047-23.378,194.783-25.348c34.567-30.688,80.505-49.185,124.551-60.79c44.429-11.705,90.212-17.122,135.848-21.803c-11.404-18.101-22.695-36.284-33.076-54.996c-39.525-71.244-66.643-159.357-27.883-236.923c3.659-7.323,14.615-0.881,10.969,6.412c-22.743,45.515-20.711,99.14-6.166,146.828c15.497,50.81,44.301,96.156,72.45,140.719c2.796,4.426-0.975,9.104-5.485,9.558c-24.755,2.496-49.512,5.081-74.13,8.717c-42.118,6.219-84.471,15.223-123.676,32.254c-18.473,8.024-36.154,17.92-52.486,29.719c6.908,0.008,13.88,0.11,20.943,0.338c170.183,5.494,371.577,33.128,466.682-117.466c1.328-2.561,2.686-5.104,3.942-7.708c25.837-53.544,38.302-113.675,39.071-172.959C1911.572,807.353,1897.4,741.045,1866.856,682.422z"/><path style="fill:#332F28;" d="M436.075,1068.325c-12.648,3.541-25.554,6.304-38.573,8.074c-12.501,1.7-25.145,1.319-37.612,2.901c-33.509,4.251-63.228,33.102-67.193,66.926c-2.105,17.968,4.817,34.229,19.181,45.135c6.51,4.944,12.847-6.084,6.411-10.971c-24.971-18.961-10.553-54.715,8.405-72.075c13.046-11.947,28.324-16.383,45.635-17.047c23.906-0.916,47.736-4.997,70.686-11.715c23.336-6.831,45.827-16.415,67.087-28.198c-2.673-3.352-5.257-6.759-7.744-10.223C481.345,1052.636,459.188,1061.854,436.075,1068.325z"/><path style="fill:#C3B5AA;" d="M739.382,669.419c0.524-0.403,1.108-0.765,1.815-1.025c3.522-1.29,7.073-2.472,10.639-3.602c-8.219-3.236-14.413-7.655-19.525-12.749c2.179,5.4,4.176,10.869,5.948,16.418L739.382,669.419z"/><path style="fill:#C3B5AA;" d="M965.078,611.656c0.541-0.88,1.102-1.775,1.679-2.678c-21.794,15.807-23.887,48.648-43.559,60.853c1.713,0.648,3.397,1.369,5.097,2.053C940.546,651.803,952.759,631.696,965.078,611.656z"/><path style="fill:#332F28;" d="M566.208,690.487c5.259-14.753,11.856-28.958,19.536-42.572c3.549-6.29,7.256-12.492,11.3-18.493c6.68-9.914,14.017-19.353,21.978-28.272c7.327-8.208,15.188-17.445,25.159-22.451c12.193-6.121,22.324,0.216,31.053,8.855c4.659,4.611,9.037,9.531,13.189,14.63c3.075,3.779,6.041,7.646,8.834,11.615c13.313,18.921,23.391,39.772,30.053,61.917c1.239,4.118,5.225,5.117,8.379,4.011c0.958-0.15,1.776-0.46,2.459-0.94c1.31,1.864,3.562,2.907,6.425,1.857c58.108-21.296,123.3-20.279,180.488,3.513c2.026,2.687,6.204,3.873,9.145,1.585c2.601-1.131,4.415-3.822,4.399-6.368c10.434-17.085,20.866-34.169,31.302-51.254c4.788-7.841,10.832-19.606,18.838-27.674c4.782-4.82,10.267-8.322,16.603-8.878c8.906-0.782,14.247,6.505,17.744,13.667c1.642,3.365,3.068,6.854,4.431,10.373c2.099,5.413,4.016,10.916,6.077,16.287c7.694,20.065,15.39,40.13,23.084,60.195c2.898,7.557,15.187,4.276,12.253-3.378c-2.159-5.627-4.316-11.254-6.474-16.882c-6.769-17.647-13.538-35.296-20.304-52.944c-6.342-16.538-13.392-39.848-35.051-40.088c-17.924-0.199-31.355,16.107-40.351,30.179c-0.577,0.904-1.138,1.799-1.679,2.678c-12.319,20.039-24.532,40.147-36.784,60.228c-1.7-0.684-3.384-1.406-5.097-2.053c-54.72-20.7-115.516-22.733-171.361-5.04c-3.565,1.13-7.117,2.312-10.639,3.602c-0.707,0.26-1.291,0.622-1.815,1.025l-1.123-0.959c-1.772-5.549-3.769-11.018-5.948-16.418c-4.896-12.134-10.705-23.895-17.661-34.991c-10.457-16.683-23.417-34.595-39.489-46.284c-17.318-12.595-35.747-6.786-50.602,6.48c-15.042,13.434-27.967,30.012-39.133,46.737c-13.11,19.635-23.544,40.9-31.467,63.127c-1.002,2.811,0,5.028,1.798,6.354C558.893,695.776,564.474,695.356,566.208,690.487z"/><path style="fill:#332F28;" d="M1123.085,801.706c-71.775,32.015-139.216,72.95-201.653,120.617c-5.447,4.159-0.078,13.536,5.447,9.319c62.437-47.667,129.879-88.603,201.653-120.617C1134.864,808.201,1129.38,798.898,1123.085,801.706z"/><path style="fill:#332F28;" d="M1122.968,956.494c-32.659-0.591-65.235-4.198-97.861-5.666c-31.415-1.413-65.978-3.622-96.444,5.825c-6.613,2.05-3.791,12.472,2.868,10.407c30.138-9.345,64.489-6.802,95.554-5.349c31.963,1.495,63.884,4.996,95.883,5.575C1129.914,967.412,1129.916,956.619,1122.968,956.494z"/><path style="fill:#332F28;" d="M621.155,905.395c-44.714-14.849-89.722-27.517-135.399-37.65c-28.215-6.26-56.682-11.562-85.503-15.786c-7.299-1.07-10.45,10.102-3.082,11.182c29.022,4.253,57.686,9.606,86.094,15.923c45.473,10.112,90.286,22.728,134.807,37.513C625.171,918.936,628.216,907.74,621.155,905.395z"/><path style="fill:#332F28;" d="M611.171,958.483c7.293,1.386,10.418-9.789,3.082-11.182c-34.772-6.607-71.666-4.439-106.791-2.659c-10.682,0.541-21.368,1.223-32.049,1.985c-25.065,1.789-50.102,4.218-74.962,7.704c-7.359,1.032-4.227,12.208,3.083,11.183c23.883-3.349,47.961-5.625,72.055-7.32c10.626-0.747,21.255-1.417,31.873-1.954C541.459,954.515,577.506,952.087,611.171,958.483z"/><path style="fill:#332F28;" d="M652.618,853.466c-7.854-2.336-11.208,9.922-3.378,12.251c17.771,5.285,34.106,16.426,45.192,31.32c2.045,2.748,5.498,4.147,8.693,2.279c2.709-1.585,4.339-5.923,2.278-8.692C692.211,872.9,673.847,859.78,652.618,853.466z"/><path style="fill:#332F28;" d="M883.295,855.131c-21.154,7.018-39.333,21.557-50.631,40.8c-4.148,7.066,6.829,13.467,10.971,6.412c9.604-16.355,25.198-29.042,43.038-34.961c3.255-1.08,5.379-4.384,4.437-7.815C890.233,856.384,886.565,854.046,883.295,855.131z"/><path style="fill:#332F28;" d="M943.957,1043.723c6.099-5.47-2.91-14.432-8.984-8.984c-31.773,28.499-57.38,62.971-88.781,91.732c-28.084,25.722-61.406,43.966-94.059,63.105c-0.547,0.322-1.098,0.64-1.646,0.962c-18.904,11.107-38.229,18.533-59.862,22.409c-21.602,3.87-43.652,4.657-65.55,5.073c-17.981,0.341-37-1.444-54.108,5.178c-14.125,5.468-26.293,14.86-35.464,26.882c-18.843,24.698-22.81,60.636,4.084,81.057c6.511,4.944,12.848-6.084,6.413-10.971c-22.008-16.71-13.177-48.112,2.407-65.935c9.465-10.826,21.907-18.767,36.032-21.817c8.705-1.88,17.868-1.353,26.721-1.474c10.089-0.139,20.179-0.28,30.262-0.648c20.624-0.753,41.371-2.404,61.556-6.889c20.234-4.496,38.145-12.647,55.937-23.076c3.665-2.147,7.338-4.285,11.009-6.423c27.471-15.999,54.932-32.05,79.072-52.945C883.279,1111.286,910.16,1074.035,943.957,1043.723z"/><path style="fill:#332F28;" d="M585.55,1273.911c-6.403,7.603-8.782,17.662-9.347,27.399c-0.535,9.195,0.644,19.636,5.729,27.548c1.854,2.883,5.642,4.062,8.693,2.279c2.869-1.679,4.141-5.793,2.278-8.692c-0.443-0.691-0.858-1.396-1.228-2.13l-0.315-0.658l-0.286-0.708c-0.65-1.769-1.137-3.598-1.51-5.445c-0.117-0.583-0.21-1.17-0.317-1.755l-0.041-0.236c-0.121-0.978-0.212-1.962-0.278-2.946c-0.144-2.204-0.158-4.417-0.053-6.623c0.049-1.056,0.128-2.11,0.234-3.162l0.146-1.276l0.128-0.771c0.356-2.001,0.78-3.982,1.36-5.931c0.277-0.93,0.592-1.845,0.927-2.755l0.219-0.552l0.463-0.988c0.389-0.787,0.813-1.557,1.278-2.301l0.697-1.056l0.05-0.086l0.157-0.169c2.209-2.622,2.573-6.412,0-8.984C592.266,1271.643,587.77,1271.275,585.55,1273.911z"/><path style="fill:#332F28;" d="M1208.268,1141.442c-22.302,22.209-46.507,42.342-72.186,60.35c-53.519,37.53-113.522,65.704-176.62,83.326c-46.326,12.936-94.174,20.219-142.263,21.391c-18.643,0.455-37.629-1.805-56.193,0.057c-12.155,1.22-23.901,4.562-35.788,7.219c-10.487,2.345-21.058,4.276-31.684,5.872c-6.461,0.97-14.667,0.684-20.571,3.46c-3.227,1.517-5.744,2.681-9.419,2.802c-19.048,0.627-31.694-17.638-28.003-35.328c1.666-7.978-10.58-11.39-12.252-3.378c-3.798,18.2,2.748,36.353,19.289,45.806c6.653,3.801,14.529,6.006,22.219,5.552c3.784-0.223,7.447-1.019,10.911-2.557c4.63-2.055,9.161-2.406,14.225-3.104c18.47-2.546,36.535-6.424,54.676-10.634c13.082-3.037,25.503-3.684,38.914-3.226c102.099,3.491,204.863-20.36,295.399-67.553c30.049-15.663,58.655-34.047,85.457-54.764c18.546-14.337,36.254-29.758,52.873-46.307C1223.053,1144.648,1214.07,1135.663,1208.268,1141.442z"/><path style="fill:#332F28;" d="M357.84,1134.135c-6.403,7.603-8.782,17.662-9.349,27.398c-0.534,9.195,0.645,19.637,5.731,27.548c1.853,2.883,5.642,4.063,8.691,2.279c2.87-1.679,4.142-5.793,2.28-8.692c-0.444-0.691-0.858-1.396-1.229-2.13l-0.317-0.664l-0.285-0.702c-0.648-1.77-1.137-3.598-1.509-5.445c-0.117-0.584-0.21-1.17-0.317-1.755l-0.041-0.234c-0.123-0.979-0.212-1.964-0.278-2.949c-0.145-2.204-0.159-4.416-0.055-6.623c0.051-1.056,0.128-2.11,0.234-3.161l0.146-1.274l0.128-0.773c0.357-2.002,0.781-3.982,1.362-5.932c0.276-0.93,0.592-1.845,0.924-2.756l0.215-0.542l0.469-0.999c0.389-0.786,0.813-1.556,1.277-2.301l0.698-1.056l0.051-0.087l0.156-0.168c2.209-2.622,2.573-6.412,0-8.984C364.556,1131.867,360.06,1131.499,357.84,1134.135z"/><path style="fill:#332F28;" d="M551.325,1179.103c8.176,0.314,8.163-12.391,0-12.705c-25.453-0.977-49.294,7.325-74.109,11.642c-4.922,0.856-9.857,1.631-14.801,2.343c-5.77,0.829-12.449,0.647-17.656,3.284c-5.437,2.754-10.957,3.102-16.867,1.406c-15.278-4.384-23.252-18.973-20.061-34.258c1.664-7.978-10.58-11.389-12.252-3.377c-2.946,14.114-0.133,28.427,10.248,38.885c8.316,8.377,20.639,13.499,32.502,12.366c6.185-0.591,11.209-3.881,17.228-4.661c9.621-1.248,19.22-2.657,28.765-4.4c11.649-2.128,23.103-4.998,34.647-7.602C529.729,1179.598,540.29,1178.68,551.325,1179.103z"/><path style="fill:#332F28;" d="M1556.239,1109.106c24.618-3.636,49.376-6.221,74.13-8.717c4.51-0.455,8.281-5.132,5.485-9.558c-28.149-44.563-56.953-89.909-72.45-140.719c-14.545-47.688-16.577-101.313,6.166-146.828c3.646-7.293-7.31-13.735-10.969-6.412c-38.76,77.566-11.642,165.68,27.883,236.923c10.381,18.712,21.672,36.895,33.076,54.996c-45.636,4.681-91.42,10.098-135.848,21.803c-44.046,11.604-89.983,30.102-124.551,60.79c-1.193,1.06-2.483,2.014-3.649,3.103c-8.429,7.878-15.851,18.391-15.644,30.41c0.196,11.335,6.289,21.278,17.024,25.224c7.686,2.826,11.001-9.449,3.377-12.251c-8.977-3.301-8.912-15.457-5.284-22.592c4.809-9.457,14.371-16.38,22.699-22.543c0.78-0.577,1.605-1.091,2.392-1.659c16.332-11.799,34.014-21.694,52.486-29.719C1471.768,1124.329,1514.121,1115.325,1556.239,1109.106z"/><path style="fill:#332F28;" d="M1407.497,1231.335l-0.746-0.262l-0.843-0.347c-0.846-0.421-1.665-0.898-2.449-1.425l-0.56-0.399l-0.746-0.635c-0.7-0.632-1.363-1.306-1.986-2.014l-0.569-0.693l-0.465-0.648c-0.534-0.79-1.027-1.609-1.478-2.45l-0.645-1.283c-0.14-0.296-0.607-1.722-0.123-0.243c-0.3-0.914-0.66-1.803-0.926-2.73c-0.264-0.924-0.483-1.861-0.656-2.807l-0.119-0.91l-0.066-0.729c-0.063-0.952-0.078-1.907-0.041-2.86l0.091-1.422l0.004-0.143l0.01-0.047c0.184-0.928,0.36-1.849,0.621-2.759l0.354-1.122l0.331-0.857l0.316-0.657l0.691-1.239l0.776-1.197l0.135-0.22l0.195-0.204c2.209-2.623,2.573-6.412,0-8.984c-2.268-2.267-6.764-2.637-8.984,0c-14.011,16.648-6.384,44.747,14.5,51.535c3.162,1.027,7.076-1.197,7.814-4.437C1412.727,1235.664,1410.882,1232.436,1407.497,1231.335z"/><path style="fill:#332F28;" d="M2075.591,980.179c-3.975-30.362-10.863-60.278-22.745-88.573c-21.151-50.366-57.772-91.178-104.719-118.927c-12.497-7.386-25.526-13.799-38.862-19.515l-1.276-0.404c-4.506-16.185-9.993-32.097-16.516-47.603c-30.296-72.016-82.219-132.357-147.255-175.359c-8.966-5.928-18.159-11.497-27.515-16.787c-2.363-1.336-4.634-1.005-6.372,0.157c-3.505,2.343-4.804,8.12-0.041,10.813c65.964,37.297,121.404,90.96,156.564,158.441c30.544,58.623,44.716,124.931,43.86,190.86c-0.769,59.284-13.234,119.415-39.071,172.959c-1.257,2.604-2.614,5.147-3.942,7.708c-33.384,64.449-88.686,115.167-155.068,144.623c-38.17,16.938-79.444,26.958-120.802,32.088c-21.084,2.615-42.308,4.027-63.545,4.507c-19.911,0.45-50.512,4.449-65.167-12.342c-5.932-6.795-9.451-18.36-3.134-26.046c5.152-6.269-3.786-15.307-8.984-8.984c-13.395,16.298-5.684,39.756,10.984,50.57c19.71,12.787,47.005,10.03,69.39,9.431c44.44-1.191,89.079-6.464,131.99-18.347c83.086-23.011,157.465-73.346,203.165-147.364c32.172-52.109,49.454-113.12,55.049-173.804c2.374-25.74,2.509-51.73,0.346-77.52c40.019,43.326,55.414,105.122,50.898,163.274c-5.191,66.844-39.235,127.996-86.225,174.703c-52.781,52.463-121.082,85.833-191.737,107.052c-34.975,10.504-70.678,17.02-106.262,24.939c-32.535,7.24-65.324,17.287-91.687,38.483c-12.434,9.998-24.206,23.14-27.506,39.227c-3.167,15.447,2.014,30.857,11.751,42.93c23.138,28.688,63.049,29.637,96.818,28.134c71.905-3.197,142.115-23.154,207.017-53.77c64.769-30.554,124.87-71.691,178.192-119.413c26.332-23.566,50.848-49.479,70.496-78.953c20.845-31.27,34.744-66.42,41.027-103.472C2081.089,1056.293,2080.532,1017.916,2075.591,980.179z M2066.566,1047.607c-1.138,37.517-8.357,75.236-24.489,109.309c-14.995,31.671-36.555,59.633-60.905,84.656c-48.922,50.275-107.538,92.794-169.1,126.211c-61.724,33.505-129.318,57.804-199.281,66.154c-17.024,2.031-34.185,3.219-51.333,3.299c-18.641,0.087-38.477-1.301-55.016-10.759c-13.459-7.696-25.069-21.941-25.335-38.031c-0.285-17.267,13.13-31.216,25.885-41.092c26.349-20.406,59.569-28.978,91.585-35.805c35.06-7.477,70.061-14.36,104.373-24.936c67.552-20.822,132.771-52.688,184.764-101.3c46.917-43.867,83.2-101.371,94.501-165.219c10.532-59.496,1.128-125.12-33.178-175.753c-8.217-12.127-17.792-23.252-28.642-33.091l-0.659-0.489c-1.874-14.311-4.442-28.526-7.771-42.563c45.971,21.286,86.55,52.52,113.082,96.458C2057.6,918.565,2068.452,985.432,2066.566,1047.607z"/><path style="fill:#332F28;" d="M813.38,981.569c-0.705,0.18-1.412,0.327-2.126,0.47l-0.338,0.055l-0.943,0.085c-1.229,0.085-2.467,0.08-3.697-0.012l-0.914-0.086l-0.317-0.051c-0.688-0.136-1.374-0.264-2.056-0.435c-1.195-0.299-2.368-0.675-3.516-1.119l-0.282-0.112l-0.914-0.426l-1.422-0.733c-1.257-0.687-2.459-1.459-3.627-2.287c-0.861-0.609,0.088,0.109-0.668-0.501c-0.561-0.453-1.107-0.927-1.639-1.414c-1.001-0.915-1.952-1.885-2.849-2.902c-2.01-2.277-3.693-4.978-4.972-7.899c0.199-1.709,0.29-3.423,0.157-5.126c-0.09-1.154-0.334-2.244-0.59-3.327l0,0c2.713-1.542,5.445-3.768,8.409-6.395c3.381-2.995,11.917-11.042,10.623-17.193c-0.634-3.024-2.997-3.474-5.558-3.88c-3.369-0.534-6.749-0.989-10.14-1.363c-1.273-0.141-2.549-0.27-3.826-0.388c-4.478-0.413-10.753-0.384-15.252-0.437c-3.823-0.046-7.86-0.738-11.528,0.662c-4.581,1.748-5.138,6.166-3.548,10.92c2.133,6.368,9.981,14.286,15.224,17.592c1.261,0.796,2.463,1.367,3.632,1.801c0,0.001,0,0.002,0,0.002c0.109,1.217,0.283,2.425,0.494,3.627c0.274,1.553,0.625,3.093,1.147,4.597c-0.383,1.461-0.891,3.036-1.357,3.993c-1.313,2.699-2.599,4.532-4.577,6.433c-1.854,1.782-4.502,3.336-7.389,4.356c-3.59,1.268-7.308,1.922-11.104,2.091c-8.042,0.358-15.993-0.985-23.868-2.442c-2.747-0.508-5.583,0.758-6.368,3.616c-0.693,2.518,0.851,5.857,3.616,6.369c15.098,2.793,31.448,5.345,45.747-1.894c4.747-2.404,8.737-6.36,11.607-11.022c5.142,6.689,12.232,11.945,20.066,14.362c5.646,1.743,11.699,1.857,17.418,0.4C822.586,989.909,819.852,979.92,813.38,981.569z"/><path style="fill:#332F28;" d="M996.729,656.307c1.383-1.541,2.871-2.945,4.444-4.288c0.173-0.148,0.213-0.187,0.245-0.223c0.055-0.033,0.105-0.062,0.299-0.195l1.079-0.742c0.784-0.515,1.592-0.995,2.431-1.417c0.235-0.119,0.813-0.344,0.809-0.353l1.001-0.333l1.338-0.302c-1.292,0.284-0.071,0.047,0.271,0.049c0.447,0.002,1.494,0.35,0.219-0.029l0.812,0.228l0.455,0.266l0.199-0.188l0.555,0.52c0.173,0.157,0.158,0.097,0.136,0.051c0.023,0.044,0.08,0.139,0.2,0.329l0.827,1.452c0.001,0.003,0.741,1.583,0.359,0.716c0.259,0.587,0.491,1.189,0.735,1.783c1.001,2.427,2.002,4.853,3.003,7.28c2.044,4.959,4.088,9.919,6.133,14.878c1.107,2.687,3.752,4.902,6.861,3.896c2.589-0.837,5.088-3.973,3.896-6.861c-2.349-5.698-4.698-11.396-7.047-17.093c-2.342-5.682-4.088-12.514-9.451-16.139c-9.421-6.367-20.99,1.793-27.299,8.828c-1.947,2.171-2.302,5.775,0,7.888C990.968,658.26,994.649,658.627,996.729,656.307z"/><path style="fill:#332F28;" d="M649.037,626.69c1.001-0.622,1.639-0.997,2.734-1.167c-0.599,0.093,0.923-0.006,1.103,0.022c-0.687-0.107,0.939,0.463,0.239,0.135l1.088,0.685c0.093,0.112,0.708,0.651,0.73,0.672c0.792,0.768,1.517,1.6,2.243,2.429c3.231,3.681,7.15,7.45,12.477,6.906c2.997-0.306,5.578-2.344,5.578-5.578c0-2.778-2.562-5.886-5.578-5.578l-0.829,0.05l-0.416-0.227c-0.151-0.078-0.17-0.073-0.222-0.088c-0.035-0.053-0.054-0.093-0.201-0.244l-1.108-1.098c-1.63-1.717-3.05-3.64-4.849-5.192c-5.464-4.714-12.467-5.181-18.619-1.36c-5.967,3.706-10.05,9.763-13.811,15.542c-3.892,5.978-7.234,12.286-10.053,18.837c-1.189,2.765-0.821,5.981,2.002,7.632c2.35,1.375,6.434,0.781,7.631-2.001c2.601-6.046,5.645-11.889,9.163-17.453C641.205,635.083,644.367,629.591,649.037,626.69z"/></g></svg>`;
        const CAT_IMAGE = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(CAT_SVG);

        const copyToClipboard = (text, onSuccess, onError) => {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(onSuccess).catch(() => fallbackCopy(text, onSuccess, onError));
            } else {
                fallbackCopy(text, onSuccess, onError);
            }
        };

        const fallbackCopy = (text, onSuccess, onError) => {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.opacity = "0";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                if (onSuccess) onSuccess();
            } catch (err) { if (onError) onError(); }
        };

        const formatTime = (ms) => {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        // --- Icons ---
        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current || !window.lucide) return;
                ref.current.innerHTML = '';
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconNode = window.lucide.icons[iconName];
                if (iconNode) {
                    const svg = window.lucide.createElement(iconNode);
                    svg.setAttribute('width', size); svg.setAttribute('height', size); svg.setAttribute('stroke-width', 2);
                    if (className) svg.setAttribute('class', className);
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" style={{ width: size, height: size }}></span>;
        };

        // --- Toast (Auto-Dismiss, Click to Close) ---
        const Toast = ({ message, type = 'info', onClose }) => {
            const [exiting, setExiting] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => setExiting(true), 3000);
                return () => clearTimeout(timer);
            }, []);

            useEffect(() => {
                if (exiting) {
                    const timer = setTimeout(onClose, 300);
                    return () => clearTimeout(timer);
                }
            }, [exiting, onClose]);

            const bgClass = type === 'error' ? 'bg-red-500' : 'bg-earth';
            const animClass = exiting ? 'animate-toast-out' : 'animate-toast-in';

            return (
                <div
                    onClick={() => setExiting(true)}
                    className={`fixed bottom-6 left-1/2 -translate-x-1/2 ${bgClass} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 z-[100] ${animClass} max-w-[90vw] cursor-pointer hover:opacity-90 transition`}
                >
                    <span className="font-medium text-sm text-center">{message}</span>
                </div>
            );
        };

        // --- Host ID Display ---
        const HostIDDisplay = ({ id, show, onToggle, onCopy }) => {
            if (!id) return null;
            return (
                <div className="bg-white/50 px-3 py-2 rounded-full border border-earth/5 flex items-center gap-2 max-w-full overflow-hidden h-10">
                    <span className="text-xs font-bold text-earth/50 uppercase tracking-wide font-sans whitespace-nowrap shrink-0">Host ID</span>
                    <span className="font-mono text-dullpurple select-all text-xs md:text-sm whitespace-nowrap overflow-hidden text-ellipsis flex-1 min-w-0">
                        {show ? id : '*'.repeat(id.length)}
                    </span>
                    <div className="flex gap-1 shrink-0">
                        <button onClick={onToggle} className="text-earth/40 hover:text-earth transition p-1"><Icon name={show ? "eye" : "eye-off"} size={16} /></button>
                        <button onClick={onCopy} className="text-earth/40 hover:text-earth transition p-1"><Icon name="copy" size={16} /></button>
                    </div>
                </div>
            );
        };

        // --- Modal Component ---
        const LinkModal = ({ url, onClose, onCopy }) => (
            <div className="fixed inset-0 bg-charcoal/50 flex items-center justify-center z-50 p-4 animate-fade-in">
                <div className="bg-linen p-6 rounded-2xl max-w-md w-full shadow-lg border-2 border-earth/10 relative animate-modal-in">
                    <button onClick={onClose} className="absolute top-4 right-4 text-earth/40 hover:text-earth transition"><Icon name="x" size={20} /></button>
                    <h3 className="text-xl font-bold font-serif text-earth mb-4">Share Template</h3>
                    <div className="bg-white/50 p-3 rounded-lg border border-earth/5 mb-4 break-all font-mono text-xs text-charcoal max-h-[200px] overflow-y-auto">{url}</div>
                    <button onClick={onCopy} className="w-full bg-dullpurple text-white py-3 rounded-xl font-sans font-bold hover:bg-earth transition flex items-center justify-center gap-2"><Icon name="copy" size={16} /> Copy Link</button>
                </div>
            </div>
        );

        // --- Line Numbered Text Area ---
        const LineNumberedTextarea = ({ value, onChange, onBlur, placeholder, className }) => {
            const textareaRef = useRef(null);
            const linesRef = useRef(null);

            const handleScroll = () => {
                if (textareaRef.current && linesRef.current) {
                    linesRef.current.scrollTop = textareaRef.current.scrollTop;
                }
            };

            const lines = value.split('\n');
            const lineCount = lines.length;
            // Ensure at least one line number is shown, even if empty
            const lineNumbers = Array.from({ length: Math.max(lineCount, 1) }, (_, i) => i + 1).join('\n');

            return (
                <div className={`relative flex bg-white/50 rounded-xl border-2 border-earth/10 overflow-hidden ${className}`}>
                    <div
                        ref={linesRef}
                        className="bg-earth/5 text-right pr-2 text-earth/30 font-mono text-sm select-none overflow-hidden w-10 shrink-0 h-full line-numbers-col whitespace-pre"
                    >
                        {lineNumbers}
                    </div>
                    <textarea
                        ref={textareaRef}
                        className="flex-1 px-4 bg-transparent focus:outline-none resize-none text-sm font-serif whitespace-pre overflow-y-auto w-full h-full sync-scroll"
                        value={value}
                        onChange={onChange}
                        onBlur={onBlur}
                        onScroll={handleScroll}
                        placeholder={placeholder}
                    />
                </div>
            );
        };


        // --- Main App ---
        function App() {
            // View & Identity
            const [view, setView] = useState('welcome');
            const [isHost, setIsHost] = useState(false);
            const [isSolo, setIsSolo] = useState(false);
            const [peerId, setPeerId] = useState(null);
            const [myPlayerId, setMyPlayerId] = useState(generateId());
            const [hostConnId, setHostConnId] = useState('');

            // Game Data
            const [playerName, setPlayerName] = useState('');
            const [selectedColorIdx, setSelectedColorIdx] = useState(0);
            const [players, setPlayers] = useState([]);

            // Settings & Board
            const [settings, setSettings] = useState({ mode: 'lockout', visibility: 'standard', population: 'sequential', interaction: 'normal', middleFree: false });
            const [gridSize, setGridSize] = useState(5);
            const [boardData, setBoardData] = useState([]);
            const [goal, setGoal] = useState(''); // New Goal State

            // Setup Inputs (Draft State)
            const [setupVariant, setSetupVariant] = useState('standard');
            const [gridText, setGridText] = useState('');
            const [deckText, setDeckText] = useState([]);
            const [deckImages, setDeckImages] = useState([]);
            const [deckConfig, setDeckConfig] = useState({ textCount: 15, imgCount: 10 });
            const [imageInput, setImageInput] = useState({});

            // UI
            const [showId, setShowId] = useState(false);
            const [showTimer, setShowTimer] = useState(true);
            const [toast, setToast] = useState(null);
            const [generatedLink, setGeneratedLink] = useState(null);
            const [detailModal, setDetailModal] = useState(null);
            const [isLoaded, setIsLoaded] = useState(false);

            // Template State
            const [preloadedData, setPreloadedData] = useState(null);

            // Timer
            const [timerState, setTimerState] = useState({ isRunning: false, startTime: null, accumulatedTime: 0 });
            const [elapsedTime, setElapsedTime] = useState(0);

            // Refs
            const peerRef = useRef(null);
            const connRefs = useRef([]);
            const hostConnRef = useRef(null);
            const timerIntervalRef = useRef(null);
            const stateRef = useRef(null);

            // Handle Shared Link Load
            useEffect(() => {
                const hash = window.location.hash.substring(1);
                if (hash) {
                    try {
                        const decompressed = LZString.decompressFromEncodedURIComponent(hash);
                        if (decompressed) {
                            const parsed = JSON.parse(decompressed);
                            setPreloadedData(parsed);
                        }
                    } catch (e) { console.error("Invalid share link"); }
                }
            }, []);

            // Initialize boardData
            useEffect(() => {
                if (boardData.length !== gridSize * gridSize) {
                    setBoardData(Array(gridSize * gridSize).fill(null).map((_, i) => ({ id: i, type: 'text', content: '', markedBy: [] })));
                }
            }, [gridSize]);

            // Restore from Local Storage
            useEffect(() => {
                const saved = localStorage.getItem('bingo_state');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.myPlayerId) setMyPlayerId(parsed.myPlayerId);
                        if (parsed.playerName) setPlayerName(parsed.playerName);
                        if (parsed.selectedColorIdx !== undefined) setSelectedColorIdx(parsed.selectedColorIdx);
                        if (parsed.setupVariant) setSetupVariant(parsed.setupVariant);
                        if (parsed.gridSize) setGridSize(parsed.gridSize);
                        if (parsed.gridText) setGridText(parsed.gridText);
                        if (parsed.imageInput) setImageInput(parsed.imageInput);
                        if (parsed.deckText) setDeckText(parsed.deckText);
                        if (parsed.deckImages) setDeckImages(parsed.deckImages);
                        if (parsed.goal) setGoal(parsed.goal);

                        const activeGame = localStorage.getItem('bingo_active');
                        if (activeGame) {
                            setView('restore_prompt');
                        } else if (parsed.hostConnId && (parsed.view === 'lobby' || parsed.view === 'waiting')) {
                            setHostConnId(parsed.hostConnId);
                            setView('welcome');
                        }
                    } catch (e) { console.error("Restore failed", e); }
                }
                setIsLoaded(true);
            }, []);

            // Persist
            useEffect(() => {
                if (!isLoaded) return;

                stateRef.current = { players, boardData, settings, view, timerState, isHost, isSolo, myPlayerId, gridSize, goal };

                const saveState = {
                    myPlayerId, playerName, selectedColorIdx,
                    setupVariant, gridSize, gridText, imageInput, deckText, deckImages, deckConfig,
                    hostConnId, goal
                };
                localStorage.setItem('bingo_state', JSON.stringify(saveState));

                if (view === 'game' || view === 'lobby' || view === 'waiting') {
                    const activeState = {
                        isHost, isSolo, view, hostConnId,
                        boardData, players, timerState, settings, goal
                    };
                    localStorage.setItem('bingo_active', JSON.stringify(activeState));
                } else if (view === 'welcome' || view === 'setup') {
                    localStorage.removeItem('bingo_active');
                }
            }, [players, boardData, settings, view, timerState, isHost, isSolo, myPlayerId, playerName, selectedColorIdx, hostConnId, gridText, imageInput, deckText, deckImages, deckConfig, setupVariant, gridSize, isLoaded, goal]);

            const showToast = (message, type = 'info') => setToast({ message, type });

            // --- Stats Calculation ---
            const stats = useMemo(() => {
                const totalCells = gridSize * gridSize;
                const requiredItems = settings.middleFree ? totalCells - 1 : totalCells;

                const gridInputLines = gridText.split('\n').slice(0, requiredItems);

                // For count we need to count non-empty lines properly
                let filledCount = 0;
                const rawLines = gridText.split('\n');

                // Count valid items in the text area
                for (let i = 0; i < rawLines.length; i++) {
                    const line = rawLines[i].trim();
                    if (line.length > 0) filledCount++;
                }
                // Cap filledCount at requiredItems for display logic if in sequential mode
                if (settings.population === 'sequential' && filledCount > requiredItems) filledCount = requiredItems;

                const imageCount = Object.keys(imageInput).length;

                return { imageCount, filledCount, totalCells, requiredItems };
            }, [gridText, imageInput, gridSize, settings.middleFree, settings.population]);

            // Timer Tick
            useEffect(() => {
                if (timerState.isRunning) {
                    timerIntervalRef.current = setInterval(() => {
                        setElapsedTime(timerState.accumulatedTime + (Date.now() - timerState.startTime));
                    }, 100);
                } else {
                    clearInterval(timerIntervalRef.current);
                    setElapsedTime(timerState.accumulatedTime);
                }
                return () => clearInterval(timerIntervalRef.current);
            }, [timerState]);

            // Network
            useEffect(() => {
                if (isSolo) return;

                const peer = new Peer(myPlayerId, { debug: 1 });
                peerRef.current = peer;

                peer.on('open', (id) => {
                    setPeerId(id);
                });

                peer.on('disconnected', () => {
                    setTimeout(() => { if (peer && !peer.destroyed) peer.reconnect(); }, 1000);
                });

                peer.on('error', (err) => {
                    if (err.type === 'unavailable-id') {
                        const newId = generateId();
                        setMyPlayerId(newId);
                    } else {
                        if (err.type !== 'network' && err.type !== 'server-error') {
                            showToast("Connection Error: " + err.type, 'error');
                        }
                    }
                });

                peer.on('connection', (conn) => {
                    conn.on('open', () => {
                        connRefs.current.push(conn);
                        conn.on('data', (data) => handleHostData(data, conn));
                        conn.on('close', () => {
                            connRefs.current = connRefs.current.filter(c => c !== conn);
                        });
                    });
                });

                if (!isHost && hostConnRef.current) {
                    hostConnRef.current.on('close', () => {
                        // Logic moved to handleClientData for explicit leaves, and connection check effect for disconnects
                    });
                }

                return () => {
                    if (peerRef.current) peerRef.current.destroy();
                };
            }, [isSolo, myPlayerId]);

            // Connection Trigger Effect (Fixes Resume)
            useEffect(() => {
                if (peerId && !isHost && hostConnId && view === 'waiting' && !hostConnRef.current) {
                    connectToHost(hostConnId, peerRef.current);
                }
            }, [peerId, isHost, hostConnId, view]);

            const switchToSoloMode = () => {
                setIsSolo(true);
                setIsHost(false);
                setHostConnId('');
                setSettings(prev => ({ ...prev, mode: 'standard' })); // Fallback to standard for fairness
            };

            const connectToHost = (hId, peerInstance) => {
                const conn = peerInstance.connect(hId);
                conn.on('open', () => {
                    hostConnRef.current = conn;
                    conn.send({ type: 'JOIN', payload: { id: myPlayerId, name: playerName, colorIdx: selectedColorIdx } });
                    conn.on('data', handleClientData);
                    conn.on('close', () => {
                        // Connection closed logic handled elsewhere
                    });
                });
                conn.on('error', () => {
                    showToast("Host offline. Switched to Solo Mode.", "error");
                    switchToSoloMode();
                });
            }

            const handleHostData = (data, conn) => {
                const cur = stateRef.current;

                if (data.type === 'LEAVE') {
                    // Player clicked New Game -> Remove them explicitly
                    const leavingPlayerId = data.payload.id;
                    const newPlayers = cur.players.filter(p => p.id !== leavingPlayerId);

                    // Also clean up their marks if standard mode (or general cleanup)
                    const newBoard = cur.boardData.map(cell => ({
                        ...cell,
                        markedBy: cell.markedBy.filter(id => id !== leavingPlayerId),
                        details: { ...cell.details, [leavingPlayerId]: undefined } // Clean details
                    }));

                    setPlayers(newPlayers);
                    setBoardData(newBoard);

                    // Broadcast new state to remaining
                    broadcast({
                        type: 'SYNC_STATE', payload: {
                            players: newPlayers, boardData: newBoard,
                            view: cur.view, settings: cur.settings, timerState: cur.timerState, gridSize: cur.gridSize, goal: cur.goal
                        }
                    });
                    return;
                }

                if (data.type === 'JOIN') {
                    // Check Lobby Cap (12 players)
                    if (cur.players.length >= 12) {
                        conn.send({ type: 'ERROR', payload: 'Lobby is full (12 players max)' });
                        setTimeout(() => conn.close(), 500);
                        return;
                    }

                    let newColorIdx = data.payload.colorIdx;
                    // Check if player already exists (reconnect)
                    const existingIdx = cur.players.findIndex(p => p.id === data.payload.id);

                    let newPlayers;

                    if (existingIdx >= 0) {
                        // Update existing player info, keep the rest
                        newPlayers = [...cur.players];
                        newPlayers[existingIdx] = {
                            ...newPlayers[existingIdx],
                            name: data.payload.name,
                            colorIdx: newColorIdx
                        };
                    } else {
                        // New player: Ensure color uniqueness
                        const takenColors = new Set(cur.players.map(p => p.colorIdx));
                        if (takenColors.has(newColorIdx)) {
                            // Find first available color index from 0 to 11
                            const available = PALETTE.map((_, i) => i).find(i => !takenColors.has(i));
                            if (available !== undefined) newColorIdx = available;
                            else newColorIdx = Math.floor(Math.random() * PALETTE.length); // Fallback (shouldn't happen with cap)
                        }
                        const newPlayer = {
                            id: data.payload.id,
                            name: data.payload.name,
                            colorIdx: newColorIdx
                        };
                        newPlayers = [...cur.players, newPlayer];
                    }

                    setPlayers(newPlayers);

                    broadcast({
                        type: 'SYNC_STATE', payload: {
                            players: newPlayers, boardData: cur.boardData,
                            view: cur.view === 'setup' ? 'lobby' : cur.view,
                            settings: cur.settings, timerState: cur.timerState, gridSize: cur.gridSize, goal: cur.goal
                        }
                    });
                } else if (data.type === 'CLICK_CELL') {
                    handleCellClickLogic(data.payload.cellIndex, data.payload.playerId, data.payload.detail);
                }
            };

            const handleClientData = (data) => {
                if (data.type === 'HOST_LEAVING') {
                    showToast("Host ended the game.", "info");
                    switchToSoloMode();
                } else if (data.type === 'ERROR') {
                    showToast(data.payload, 'error');
                } else if (data.type === 'SYNC_STATE') {
                    setPlayers(data.payload.players);
                    setBoardData(data.payload.boardData);
                    setSettings(data.payload.settings);
                    if (data.payload.gridSize) setGridSize(data.payload.gridSize);
                    if (data.payload.timerState) setTimerState(data.payload.timerState);
                    if (data.payload.view) setView(data.payload.view);
                    if (data.payload.goal !== undefined) setGoal(data.payload.goal);
                } else if (data.type === 'SYNC_TIMER') {
                    setTimerState(data.payload);
                }
            };

            const broadcast = (msg) => connRefs.current.forEach(c => c.send(msg));

            const handleCellClickLogic = (index, pId, detailText = null) => {
                const cur = stateRef.current;
                const cell = cur.boardData[index];

                // Don't interact with free space
                if (cell.content && cell.content.type === 'free') return;

                if (cur.settings.visibility === 'fog' && !isCellVisible(index, cur.boardData, cur.settings, pId, cur.gridSize)) return;

                let newBoard = [...cur.boardData];
                let newCell = { ...cell };

                if (detailText !== null) {
                    const currentDetails = newCell.details || {};
                    if (detailText.trim() === "") delete currentDetails[pId];
                    else currentDetails[pId] = detailText;
                    newCell.details = { ...currentDetails };
                }

                if (!cur.isSolo && cur.settings.mode === 'lockout' && newCell.markedBy.length > 0) {
                    if (newCell.markedBy.includes(pId)) {
                        newCell.markedBy = [];
                        newCell.details = {};
                    }
                } else {
                    if (newCell.markedBy.includes(pId)) {
                        if (detailText === null) {
                            newCell.markedBy = newCell.markedBy.filter(id => id !== pId);
                            const d = { ...newCell.details };
                            delete d[pId];
                            newCell.details = d;
                        }
                    } else {
                        newCell.markedBy = [...newCell.markedBy, pId];
                    }
                }

                newBoard[index] = newCell;
                setBoardData(newBoard);
                if (!cur.isSolo) broadcast({
                    type: 'SYNC_STATE', payload: {
                        players: cur.players, boardData: newBoard, settings: cur.settings, view: 'game', timerState: cur.timerState, gridSize: cur.gridSize, goal: cur.goal
                    }
                });
            };

            const onCellClick = (index) => {
                if (isHost || isSolo) {
                    handleCellClickLogic(index, myPlayerId);
                } else {
                    hostConnRef.current.send({ type: 'CLICK_CELL', payload: { cellIndex: index, playerId: myPlayerId } });
                }
            };

            const isCellVisible = (idx, board, sett, playerId, size = gridSize) => {
                if (sett.visibility === 'standard') return true;
                const total = size * size;
                if (idx >= total - size) return true;

                const row = Math.floor(idx / size);
                const col = idx % size;

                const neighbors = [];
                if (row < size - 1) neighbors.push(idx + size);
                if (row > 0) neighbors.push(idx - size);
                if (col < size - 1) neighbors.push(idx + 1);
                if (col > 0) neighbors.push(idx - 1);

                return neighbors.some(n => board[n].markedBy.includes(playerId));
            };

            // Handle grid text change - Detect Image deletions
            const handleGridTextChange = (newText) => {
                const oldLines = gridText.split('\n');
                const newLines = newText.split('\n');

                const total = Math.max(oldLines.length, newLines.length);
                const updatedImageInput = { ...imageInput };

                for (let i = 0; i < total; i++) {
                    const oldL = oldLines[i] || '';
                    const newL = newLines[i] || '';
                    // If a line started with /* Image: and now it doesn't match that exact placeholder anymore, assume deleted
                    if (oldL.trim().startsWith('/* Image:') && newL.trim() !== oldL.trim()) {
                        delete updatedImageInput[i];
                    }
                }
                setImageInput(updatedImageInput);
                setGridText(newText);
            };

            const handleImageUpload = async (e, targetIdx = null) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                // Calculate middle index
                const total = gridSize * gridSize;
                const mid = Math.floor(total / 2);

                if (setupVariant === 'standard' && settings.population === 'sequential' && targetIdx !== null) {
                    // Prevent uploading to free space
                    if (settings.middleFree && targetIdx === mid) return;

                    try {
                        const file = files[0];
                        const webp = await compressImage(file);

                        // Calculate the actual data index by skipping middle if needed
                        let dataIndex = targetIdx;
                        if (settings.middleFree && targetIdx > mid) {
                            dataIndex = targetIdx - 1;
                        }

                        setImageInput(prev => ({ ...prev, [dataIndex]: webp }));

                        const lines = gridText.split('\n');
                        while (lines.length <= dataIndex) lines.push('');

                        // Explicitly replace the line with the descriptive placeholder
                        lines[dataIndex] = `/* Image: ${file.name} */`;
                        setGridText(lines.join('\n'));

                    } catch (err) { showToast("Image upload failed", "error"); }
                } else {
                    // Random/Deck mode: Bulk Upload to ImageInput (standard) or DeckImages (deck)
                    const promises = files.map(f => compressImage(f));
                    try {
                        const results = await Promise.all(promises);

                        if (setupVariant === 'standard') {
                            // Preselected Random: Fill empty slots in text grid OR append
                            const lines = gridText.split('\n');

                            let currentImgIdx = 0;
                            const newImageInput = { ...imageInput };

                            for (let i = 0; i < lines.length && currentImgIdx < results.length; i++) {
                                const lineContent = lines[i] ? lines[i].trim() : '';
                                if (lineContent === '' || lineContent.startsWith('/* Image:')) {
                                    lines[i] = `/* Image: ${files[currentImgIdx].name} */`;
                                    newImageInput[i] = results[currentImgIdx];
                                    currentImgIdx++;
                                }
                            }

                            // Append remaining images to new lines at the end
                            while (currentImgIdx < results.length) {
                                lines.push(`/* Image: ${files[currentImgIdx].name} */`);
                                newImageInput[lines.length - 1] = results[currentImgIdx];
                                currentImgIdx++;
                            }

                            setGridText(lines.join('\n'));
                            setImageInput(newImageInput);
                        } else {
                            setDeckImages(prev => [...prev, ...results]);
                        }
                    } catch (err) { showToast("Some images failed", "error"); }
                }
            };

            const clearImages = () => {
                setImageInput({});
                // Clear any line that looks like an image placeholder
                const lines = gridText.split('\n').map(l => l.trim().startsWith('/* Image:') ? '' : l);
                setGridText(lines.join('\n'));
            };

            const generateBoard = () => {
                let content = [];
                const totalCells = gridSize * gridSize;
                const mid = Math.floor(totalCells / 2);
                const requiredItems = settings.middleFree ? totalCells - 1 : totalCells;

                if (setupVariant === 'standard') {
                    if (settings.population === 'sequential') {
                        const gridInputLines = gridText.split('\n').slice(0, requiredItems);

                        // Check if we have enough items
                        const filled = gridInputLines.reduce((acc, val, i) => acc + ((val && val.trim() !== '') || imageInput[i] ? 1 : 0), 0);
                        if (filled < requiredItems) return { error: `Fill all ${requiredItems} cells!` };

                        let dataIndex = 0;
                        for (let i = 0; i < totalCells; i++) {
                            if (settings.middleFree && i === mid) {
                                content.push({ type: 'free', src: CAT_IMAGE });
                            } else {
                                const text = gridInputLines[dataIndex];
                                if (imageInput[dataIndex]) content.push({ type: 'image', src: imageInput[dataIndex] });
                                else content.push({ type: 'text', text: text || `Item ${dataIndex + 1}` });
                                dataIndex++;
                            }
                        }
                    } else {
                        // Random Standard
                        const textLines = gridText.split('\n').filter(l => l.trim() && !l.trim().startsWith('/* Image:')).map(t => ({ type: 'text', text: t }));
                        const images = Object.values(imageInput).map(src => ({ type: 'image', src }));
                        const pool = [...textLines, ...images];

                        if (pool.length < requiredItems) return { error: `Need ${requiredItems} items! (Have ${pool.length})` };

                        const shuffled = pool.sort(() => Math.random() - 0.5).slice(0, requiredItems);

                        if (settings.middleFree) {
                            shuffled.splice(mid, 0, { type: 'free', src: CAT_IMAGE });
                        }
                        content = shuffled;
                    }
                } else {
                    if (deckConfig.textCount > deckText.length) return { error: `Not enough text items! (Need ${deckConfig.textCount})` };
                    if (deckConfig.imgCount > deckImages.length) return { error: `Not enough images! (Need ${deckConfig.imgCount})` };

                    const neededTotal = settings.middleFree ? totalCells - 1 : totalCells;
                    if (deckConfig.textCount + deckConfig.imgCount !== neededTotal) return { error: `Total items must equal ${neededTotal}` };

                    const shuffledText = [...deckText].sort(() => Math.random() - 0.5).slice(0, deckConfig.textCount).map(t => ({ type: 'text', text: t }));
                    const shuffledImg = [...deckImages].sort(() => Math.random() - 0.5).slice(0, deckConfig.imgCount).map(src => ({ type: 'image', src }));
                    let shuffled = [...shuffledText, ...shuffledImg].sort(() => Math.random() - 0.5);

                    if (settings.middleFree) {
                        shuffled.splice(mid, 0, { type: 'free', src: CAT_IMAGE });
                    }
                    content = shuffled;
                }
                return content.map((c, i) => ({ id: i, content: c, markedBy: [], details: {} }));
            };

            const triggerStart = (mode) => {
                const result = generateBoard();
                if (result.error) { showToast(result.error, 'error'); return; }
                setBoardData(result);
                if (mode === 'lobby') {
                    setView('lobby');
                    broadcast({ type: 'SYNC_STATE', payload: { players, boardData: result, settings, view: 'lobby', timerState, gridSize, goal } });
                } else if (mode === 'solo') {
                    setIsSolo(true);
                    setView('game');
                }
            };

            const startGameForEveryone = () => {
                setView('game');
                broadcast({ type: 'SYNC_STATE', payload: { players, boardData, settings, view: 'game', timerState, gridSize, goal } });
            };

            const resetGame = () => {
                // Send explicit LEAVE message before clearing state
                if (!isSolo && !isHost && hostConnRef.current) {
                    hostConnRef.current.send({ type: 'LEAVE', payload: { id: myPlayerId } });
                }
                if (isHost) {
                    broadcast({ type: 'HOST_LEAVING' });
                }

                // Explicitly disconnect logic
                if (peerRef.current) peerRef.current.destroy();
                if (hostConnRef.current) hostConnRef.current.close();

                localStorage.removeItem('bingo_active');
                window.location.reload();
            };

            const resumeGame = () => {
                const savedActive = localStorage.getItem('bingo_active');
                if (savedActive) {
                    try {
                        const a = JSON.parse(savedActive);
                        setIsHost(a.isHost);
                        setIsSolo(a.isSolo);
                        setPlayers(a.players);
                        setBoardData(a.boardData);
                        setTimerState(a.timerState);
                        if (a.settings) setSettings(a.settings);
                        if (a.hostConnId) setHostConnId(a.hostConnId);
                        if (a.goal) setGoal(a.goal);

                        if (!a.isHost && !a.isSolo && a.hostConnId) {
                            setView('waiting');
                            // Connection is now handled by the useEffect above
                        } else {
                            setView(a.view);
                        }
                    } catch (e) {
                        console.error("Resume error", e);
                        showToast("Could not resume game", "error");
                        resetGame();
                    }
                } else {
                    resetGame();
                }
            };

            const restartGame = () => {
                const resetBoard = boardData.map(cell => ({ ...cell, markedBy: [], details: {} }));
                const resetTimer = { isRunning: false, startTime: null, accumulatedTime: 0 };

                setBoardData(resetBoard);
                setTimerState(resetTimer);
                setElapsedTime(0);

                if (!isSolo) {
                    broadcast({
                        type: 'SYNC_STATE', payload: {
                            players, boardData: resetBoard, settings, view: 'game', timerState: resetTimer, gridSize, goal
                        }
                    });
                }
                showToast("Game Restarted!");
            };

            const exportBoard = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ boardData, players, gridSize, goal }));
                const node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "bingo_export.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
            };

            const saveGameState = () => {
                const activeState = {
                    isHost, isSolo, view, hostConnId,
                    boardData, players, timerState, settings, goal
                };
                localStorage.setItem('bingo_active', JSON.stringify(activeState));
                showToast("Game state saved!");
            };

            const hostGame = () => {
                if (playerName.trim() === '') return showToast("Please enter your name.", "error");
                const name = playerName.trim() || 'Host';
                setIsHost(true);
                setPlayers([{ id: myPlayerId, name: name, colorIdx: selectedColorIdx }]);
                setView('setup');
            };

            const joinGame = (hostPeerId) => {
                if (!hostPeerId) return showToast("Please enter a Game ID", "error");
                if (!playerName.trim()) return showToast("Please enter a Name", "error");

                const conn = peerRef.current.connect(hostPeerId);
                conn.on('open', () => {
                    hostConnRef.current = conn;
                    conn.send({
                        type: 'JOIN',
                        payload: {
                            id: myPlayerId,
                            name: playerName.trim(),
                            colorIdx: selectedColorIdx
                        }
                    });
                    setView('waiting');
                    conn.on('data', handleClientData);
                });
                conn.on('error', (err) => showToast("Connection failed. Check ID.", "error"));
            };

            const loadTemplate = () => {
                if (!preloadedData) return;
                if (playerName.trim() === '') return showToast("Please enter your name.", "error");

                const name = playerName.trim() || 'Host';
                setIsHost(true);
                setPlayers([{ id: myPlayerId, name: name, colorIdx: selectedColorIdx }]);

                setSettings(preloadedData.settings);
                if (preloadedData.gridSize) setGridSize(preloadedData.gridSize);
                if (preloadedData.goal) setGoal(preloadedData.goal);

                const total = (preloadedData.gridSize || 5) ** 2;
                const required = preloadedData.settings.middleFree ? total - 1 : total;
                const newGridLines = Array(required).fill('');
                const newImageInput = {};

                // Need to filter out free space from preloaded board data if it exists there
                // This logic depends on if preloadedData.boardData has the free space or raw data
                // Assuming boardData has the final cells.

                let dataIdx = 0;
                preloadedData.boardData.forEach((cell) => {
                    if (cell.content.type === 'free') return; // Skip free space
                    if (cell.content.type === 'image') {
                        newImageInput[dataIdx] = cell.content.src;
                        newGridLines[dataIdx] = `/* Image: ${dataIdx}.png */`;
                    } else {
                        newGridLines[dataIdx] = cell.content.text;
                    }
                    dataIdx++;
                });

                setGridText(newGridLines.join('\n'));
                setImageInput(newImageInput);

                setView('setup');
                setPreloadedData(null);
            };

            const createLobby = () => {
                if (stats.filledCount < stats.requiredItems) {
                    showToast(`Fill all ${stats.requiredItems} items first!`, "error");
                    return;
                }
                setView('lobby');
            };

            const playSolo = () => {
                if (stats.filledCount < stats.requiredItems) {
                    showToast(`Fill all ${stats.requiredItems} items first!`, "error");
                    return;
                }
                setIsSolo(true);
                startGame();
            };

            const generateShareLink = () => {
                if (stats.filledCount < stats.requiredItems) {
                    showToast(`Fill all ${stats.requiredItems} items first!`, "error");
                    return;
                }

                const content = generateBoard();
                if (content.error) { showToast(content.error, 'error'); return; }

                const gameData = {
                    settings,
                    boardData: content,
                    gridSize,
                    goal // Include goal in share link
                };

                try {
                    const stringified = JSON.stringify(gameData);
                    const compressed = LZString.compressToEncodedURIComponent(stringified);
                    const url = `${window.location.origin}${window.location.pathname}#${compressed}`;

                    if (url.length > 8000) {
                        showToast("Board too large for URL (images too big).", "error");
                        return;
                    }

                    setGeneratedLink(url);
                } catch (e) {
                    console.error("Compression failed", e);
                    showToast("Failed to generate link.", "error");
                }
            };

            // --- Views ---

            if (view === 'loading') return null;

            if (view === 'restore_prompt') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 fade-in">
                        <div className="bg-linen p-8 rounded-2xl shadow-sm border-2 border-earth/10 max-w-md w-full text-center space-y-4">
                            <h2 className="text-2xl font-bold text-earth">Welcome Back</h2>
                            <p className="opacity-60">You have an active game session.</p>
                            <button onClick={resumeGame} className="w-full bg-success text-white py-4 rounded-xl font-bold shadow-sm hover:bg-earth transition">Resume Saved Game</button>
                            <button onClick={resetGame} className="w-full bg-white text-earth py-4 rounded-xl font-bold shadow-sm border border-earth/10 hover:bg-earth/5 transition">Discard Saved Game</button>
                        </div>
                    </div>
                )
            }

            if (view === 'welcome') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 fade-in relative">
                        {toast && <Toast {...toast} onClose={() => setToast(null)} />}
                        <div className="bg-linen p-8 rounded-2xl shadow-sm border-2 border-earth/10 max-w-md w-full text-center">
                            <h1 className="text-4xl font-bold text-earth mb-2 font-serif">Peer-to-Peer Bingo</h1>
                            <div className="mb-6 space-y-4 text-left">
                                <input type="text" value={playerName} onChange={e => setPlayerName(e.target.value)} placeholder="Your Name" className="w-full p-3 rounded-xl border-2 border-earth/10 focus:outline-none focus:border-dullpurple font-serif" />
                                <div>
                                    <label className="text-xs font-bold text-earth/60 uppercase">Color</label>
                                    <div className="flex gap-2 justify-center flex-wrap mt-1">
                                        {PALETTE.map((c, i) => (
                                            <button key={i} onClick={() => setSelectedColorIdx(i)} className={`w-8 h-8 rounded-full border-2 transition ${selectedColorIdx === i ? 'scale-110 border-earth' : 'border-transparent'}`} style={{ backgroundColor: c.hex }} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="space-y-3">
                                {preloadedData ? (
                                    <button onClick={loadTemplate} className="w-full bg-dullpurple text-white py-4 rounded-xl font-medium hover:bg-earth transition shadow-sm flex items-center justify-center gap-2 font-sans"><Icon name="download-cloud" /> Load Prefilled Board</button>
                                ) : (
                                    <button onClick={hostGame} className="w-full bg-earth text-white py-4 rounded-xl font-medium hover:bg-charcoal transition shadow-sm flex items-center justify-center gap-2 font-sans"><Icon name="crown" /> Host New Game</button>
                                )}
                                <div className="flex gap-2">
                                    <input type="password" placeholder="HOST ID" onChange={e => setHostConnId(e.target.value)} className="flex-1 p-3 rounded-xl border-2 border-earth/10 focus:border-dullpurple uppercase font-mono" />
                                    <button onClick={() => { if (playerName && hostConnId) { setIsHost(false); connectToHost(hostConnId, peerRef.current); setView('waiting'); } else showToast("Name & ID required", 'error'); }} className="bg-dullpurple text-white px-6 rounded-xl hover:bg-opacity-90 font-bold">Join</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'setup') {
                const previewCells = Array(gridSize * gridSize).fill(null);
                const lines = gridText.split('\n');
                const isRandomMode = setupVariant !== 'standard' || settings.population !== 'sequential';
                const mid = Math.floor((gridSize * gridSize) / 2);

                // --- PREVIEW LOGIC ---
                let previewItems = [];

                if (setupVariant === 'standard') {
                    // Standard Mode Preview
                    // Sequential: Maps 1:1, but skips middle if middleFree is true
                    // Random Standard: Just show pool items 1:1, but add placeholder in middle

                    let dataIndex = 0;
                    for (let i = 0; i < gridSize * gridSize; i++) {
                        if (settings.middleFree && i === mid) {
                            previewItems.push({ hasImage: true, image: CAT_IMAGE, isFree: true });
                        } else {
                            // Get next available item from inputs
                            let item = { text: '', hasImage: false };
                            if (imageInput[dataIndex]) {
                                item = { hasImage: true, image: imageInput[dataIndex] };
                            } else if (lines[dataIndex]) {
                                item = { text: lines[dataIndex] };
                            }
                            // In random mode, we just show them in order for preview
                            previewItems.push(item);
                            dataIndex++;
                        }
                    }
                } else {
                    // Deck Mode Preview
                    // Combine Deck Text + Deck Images
                    const deckT = deckText.map(t => ({ type: 'text', text: t }));
                    const deckI = deckImages.map(src => ({ type: 'image', src }));
                    const pool = [...deckT, ...deckI];

                    let dataIndex = 0;
                    for (let i = 0; i < gridSize * gridSize; i++) {
                        if (settings.middleFree && i === mid) {
                            previewItems.push({ hasImage: true, image: CAT_IMAGE, isFree: true });
                        } else {
                            if (dataIndex < pool.length) {
                                const p = pool[dataIndex];
                                previewItems.push(p.type === 'image' ? { hasImage: true, image: p.src } : { text: p.text });
                            } else {
                                previewItems.push(null);
                            }
                            dataIndex++;
                        }
                    }
                }

                return (
                    <div className="min-h-screen p-4 max-w-6xl mx-auto fade-in pb-20">
                        {toast && <Toast {...toast} onClose={() => setToast(null)} />}
                        {generatedLink && <LinkModal url={generatedLink} onClose={() => setGeneratedLink(null)} onCopy={() => copyToClipboard(generatedLink, () => showToast("Copied!", "success"), () => showToast("Failed copy", "error"))} />}
                        <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 className="text-2xl font-bold text-earth font-serif">Setup Board</h2>
                            <HostIDDisplay id={peerId} show={showId} onToggle={() => setShowId(!showId)} onCopy={() => copyToClipboard(peerId, () => showToast("Copied!"))} />
                        </header>
                        <div className="grid lg:grid-cols-[1fr_1.5fr] gap-8">
                            <div className="space-y-6">
                                <div className="bg-linen p-4 md:p-6 rounded-2xl border-2 border-earth/5 space-y-4">
                                    <h3 className="font-bold mb-2 flex items-center gap-2 font-serif"><Icon name="settings" size={18} /> Settings</h3>
                                    {[
                                        { label: 'Variant', options: [{ key: 'standard', label: 'Pre-selected' }, { key: 'deck', label: 'Deck' }], action: setSetupVariant, current: setupVariant },
                                        { label: 'Interaction', options: [{ key: 'normal', label: 'Normal' }, { key: 'detail', label: 'Detail' }], action: v => setSettings({ ...settings, interaction: v }), current: settings.interaction },
                                        { label: 'Mode', options: [{ key: 'lockout', label: 'Lockout' }, { key: 'standard', label: 'Standard' }], action: v => setSettings({ ...settings, mode: v }), current: settings.mode },
                                        { label: 'Visibility', options: [{ key: 'standard', label: 'Open' }, { key: 'fog', label: 'Fog' }], action: v => setSettings({ ...settings, visibility: v }), current: settings.visibility },
                                        ...(setupVariant === 'standard' ? [{ label: 'Order', options: [{ key: 'sequential', label: 'Ordered' }, { key: 'shuffle', label: 'Random' }], action: v => setSettings({ ...settings, population: v }), current: settings.population }] : [])
                                    ].map((s, i) => (
                                        <div key={i}>
                                            <label className="text-xs font-bold text-earth/50 uppercase block mb-1">{s.label}</label>
                                            <div className="flex bg-white rounded-lg p-1 border border-earth/5">
                                                {s.options.map(opt => <button key={opt.key} onClick={() => s.action(opt.key)} className={`flex-1 py-1 rounded capitalize text-sm ${s.current === opt.key ? 'bg-earth text-white' : 'text-earth/60'}`}>{opt.label}</button>)}
                                            </div>
                                        </div>
                                    ))}
                                    <div>
                                        <label className="text-xs font-bold text-earth/50 uppercase block mb-1">Grid Size</label>
                                        <div className="flex bg-white rounded-lg p-1 border border-earth/5">
                                            {[3, 4, 5, 6].map(s => (
                                                <button key={s} onClick={() => setGridSize(s)} className={`flex-1 py-1 rounded text-sm ${gridSize === s ? 'bg-earth text-white' : 'text-earth/60'}`}>{s}x{s}</button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-2 mt-2">
                                        <button
                                            onClick={() => setSettings(s => ({ ...s, middleFree: !s.middleFree }))}
                                            className={`w-5 h-5 rounded border flex items-center justify-center transition ${settings.middleFree ? 'bg-earth border-earth' : 'bg-white border-earth/30'}`}
                                        >
                                            {settings.middleFree && <Icon name="check" size={12} className="text-white" />}
                                        </button>
                                        <label className="text-sm font-medium cursor-pointer select-none" onClick={() => setSettings(s => ({ ...s, middleFree: !s.middleFree }))}>Center Free Space</label>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-earth/50 uppercase block mb-1">Winning Condition / Goal</label>
                                        <input
                                            type="text"
                                            value={goal}
                                            onChange={(e) => setGoal(e.target.value)}
                                            placeholder="e.g. 5 in a row, Blackout..."
                                            className="w-full p-2 rounded-lg border border-earth/20 focus:outline-none text-sm font-serif"
                                        />
                                    </div>
                                </div>

                                {setupVariant === 'standard' ? (
                                    <div className="bg-linen p-6 rounded-2xl border-2 border-earth/5 flex flex-col relative group">
                                        <div className="flex justify-between items-center mb-2">
                                            <h3 className="font-bold">Text Items</h3>
                                            <div className="flex gap-2">
                                                {/* Clear Images button specifically for Ordered mode as requested */}
                                                {settings.population === 'sequential' && <button onClick={clearImages} className="text-[10px] bg-orange-100 text-orange-600 px-2 py-1 rounded hover:bg-orange-200 flex items-center gap-1"><Icon name="image-minus" size={10} /> Clear Images</button>}
                                                <button onClick={() => setGridText('')} className="text-[10px] bg-red-100 text-red-500 px-2 py-1 rounded hover:bg-red-200 flex items-center gap-1"><Icon name="trash-2" size={10} /> Clear Text</button>
                                            </div>
                                        </div>
                                        <p className="text-xs opacity-60 mb-2">
                                            {settings.population === 'sequential'
                                                ? `Paste ${stats.requiredItems} lines (Images uploaded: ${stats.imageCount}). Click cell to upload images.`
                                                : `Paste items (Randomized). Uploaded: ${stats.filledCount}/${stats.requiredItems}.`
                                            }
                                        </p>

                                        {/* Unified Editor for both Sequential (Line #) and Shuffle (Bulk Area) */}
                                        {settings.population === 'sequential' ? (
                                            <LineNumberedTextarea
                                                className="h-96"
                                                value={gridText}
                                                onChange={e => handleGridTextChange(e.target.value)}
                                                onBlur={() => setGridText(t => t.split('\n').filter(line => line.trim() !== '').join('\n'))}
                                                placeholder={`Item 1\nItem 2\n...`}
                                            />
                                        ) : (
                                            <div className="flex flex-col gap-4 h-full">
                                                <textarea
                                                    className="flex-1 w-full p-4 rounded-xl border-2 border-earth/10 bg-white/50 focus:outline-none min-h-[150px] text-sm"
                                                    value={gridText}
                                                    onChange={e => setGridText(e.target.value)}
                                                    onBlur={() => setGridText(t => t.split('\n').filter(line => line.trim() !== '').join('\n'))}
                                                    placeholder={`Enter items to shuffle...`}
                                                />

                                                <div className="bg-white/50 p-3 rounded-xl flex flex-col h-48">
                                                    <div className="flex justify-between items-center mb-2 shrink-0">
                                                        <label className="text-xs font-bold uppercase">Images ({stats.imageCount})</label>
                                                        <div className="relative">
                                                            <button className="text-xs bg-earth text-white px-2 py-1 rounded flex items-center gap-1 hover:bg-charcoal transition shadow-sm">
                                                                <Icon name="upload" size={12} /> Add
                                                            </button>
                                                            <input type="file" multiple accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleImageUpload} />
                                                        </div>
                                                    </div>
                                                    <div className="flex-1 overflow-y-auto bg-white/40 rounded-lg border border-earth/10 p-2">
                                                        {stats.imageCount === 0 ? (
                                                            <div className="h-full flex flex-col items-center justify-center text-earth/30">
                                                                <Icon name="image" size={24} className="mb-1 opacity-50" />
                                                                <span className="text-[10px]">No images</span>
                                                            </div>
                                                        ) : (
                                                            <div className="grid grid-cols-3 gap-2">
                                                                {Object.entries(imageInput).map(([k, src]) => (
                                                                    <div key={k} className="relative aspect-square rounded-lg border border-earth/10 bg-white group overflow-hidden shadow-sm">
                                                                        <img src={src} className="w-full h-full object-contain p-1" />
                                                                        <button
                                                                            onClick={() => {
                                                                                const n = { ...imageInput }; delete n[k]; setImageInput(n);
                                                                                // Also remove placeholder if exists in text
                                                                                const lines = gridText.split('\n');
                                                                                if (lines[k] && lines[k].trim().startsWith('/* Image:')) { lines[k] = ''; setGridText(lines.join('\n')); }
                                                                            }}
                                                                            className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-bl-lg opacity-0 group-hover:opacity-100 transition hover:bg-red-600 shadow-md"
                                                                            title="Remove"
                                                                        >
                                                                            <Icon name="x" size={10} />
                                                                        </button>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="bg-linen p-6 rounded-2xl border-2 border-earth/5 flex flex-col gap-4">
                                        <h3 className="font-bold">Deck Variant</h3>
                                        <div className="bg-white/50 p-3 rounded-xl flex flex-col h-64">
                                            <div className="flex justify-between items-center mb-2 shrink-0">
                                                <label className="text-xs font-bold uppercase">Text Items ({deckText.length})</label>
                                                <button onClick={() => setDeckText([])} className="text-[10px] bg-red-100 text-red-500 px-2 py-1 rounded hover:bg-red-200">Clear</button>
                                            </div>
                                            <textarea
                                                className="w-full flex-1 p-2 rounded-lg border border-earth/10 text-xs focus:outline-none resize-none bg-white/40"
                                                placeholder="One item per line..."
                                                value={deckText.join('\n')}
                                                onChange={e => setDeckText(e.target.value.split('\n'))}
                                                onBlur={() => setDeckText(prev => prev.filter(line => line.trim() !== ''))}
                                            />
                                        </div>

                                        <div className="bg-white/50 p-3 rounded-xl flex flex-col h-64">
                                            <div className="flex justify-between items-center mb-2 shrink-0">
                                                <label className="text-xs font-bold uppercase">Images ({deckImages.length})</label>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setDeckImages([])} className="text-[10px] bg-red-100 text-red-500 px-2 py-1 rounded hover:bg-red-200">Clear</button>
                                                    <div className="relative">
                                                        <button className="text-xs bg-earth text-white px-2 py-1 rounded flex items-center gap-1 hover:bg-charcoal transition shadow-sm">
                                                            <Icon name="upload" size={12} /> Add
                                                        </button>
                                                        <input type="file" multiple accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleImageUpload} />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex-1 overflow-y-auto bg-white/40 rounded-lg border border-earth/10 p-2">
                                                {deckImages.length === 0 ? (
                                                    <div className="h-full flex flex-col items-center justify-center text-earth/30">
                                                        <Icon name="image" size={24} className="mb-1 opacity-50" />
                                                        <span className="text-[10px]">No images</span>
                                                    </div>
                                                ) : (
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {deckImages.map((src, i) => (
                                                            <div key={i} className="relative aspect-square rounded-lg border border-earth/10 bg-white group overflow-hidden shadow-sm">
                                                                <img src={src} className="w-full h-full object-contain p-1" />
                                                                <button
                                                                    onClick={() => setDeckImages(prev => prev.filter((_, idx) => idx !== i))}
                                                                    className="absolute top-0 right-0 bg-red-500 text-white p-1 rounded-bl-lg opacity-0 group-hover:opacity-100 transition hover:bg-red-600 shadow-md"
                                                                    title="Remove"
                                                                >
                                                                    <Icon name="x" size={10} />
                                                                </button>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="bg-white/80 p-4 rounded-xl border border-earth/10 flex gap-4 items-center">
                                            <label className="text-sm">Text: <input type="number" value={deckConfig.textCount} onChange={e => setDeckConfig({ ...deckConfig, textCount: parseInt(e.target.value) || 0 })} className="w-12 p-1 border rounded ml-1" /></label>
                                            <label className="text-sm">Img: <input type="number" value={deckConfig.imgCount} onChange={e => setDeckConfig({ ...deckConfig, imgCount: parseInt(e.target.value) || 0 })} className="w-12 p-1 border rounded ml-1" /></label>
                                            <span className={`text-sm font-bold ${deckConfig.textCount + deckConfig.imgCount === stats.requiredItems ? 'text-success' : 'text-red-500'}`}>Sum: {deckConfig.textCount + deckConfig.imgCount} (Need {stats.requiredItems})</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                            <div className="space-y-4">
                                <h3 className="font-bold flex justify-between"><span>Preview</span>{setupVariant === 'standard' && settings.population === 'sequential' && <span className="text-xs font-normal opacity-50">Click cell to upload</span>}</h3>

                                <div className="gap-2 w-full max-w-[500px] mx-auto" style={{ display: 'grid', gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))` }}>
                                    {previewItems.map((item, i) => (
                                        <div key={i} className={`relative bg-white rounded-lg border-2 border-earth/10 flex items-center justify-center p-1 overflow-hidden group hover:border-dullpurple transition aspect-square ${item?.isFree ? 'bg-earth/5' : 'cursor-pointer'}`}>
                                            {/* Only allow upload click in sequential standard mode and if not free space */}
                                            {setupVariant === 'standard' && settings.population === 'sequential' && !item?.isFree && (
                                                <input type="file" className="absolute inset-0 opacity-0 z-10 cursor-pointer" accept="image/*" onChange={(e) => handleImageUpload(e, i)} />
                                            )}

                                            {item && item.hasImage ? (
                                                <React.Fragment>
                                                    <img src={item.image} className={`w-full h-full object-contain ${item.isFree ? 'opacity-80' : ''}`} />
                                                    {setupVariant === 'standard' && settings.population === 'sequential' && !item.isFree && (
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                e.preventDefault();
                                                                // Calculate Data Index (handle offset if middle free)
                                                                const mid = Math.floor(gridSize * gridSize / 2);
                                                                let dataIndex = i;
                                                                if (settings.middleFree && i > mid) dataIndex = i - 1;

                                                                const newMap = { ...imageInput };
                                                                delete newMap[dataIndex];
                                                                setImageInput(newMap);
                                                                const lines = gridText.split('\n');
                                                                if (lines[dataIndex] && lines[dataIndex].trim().startsWith('/* Image:')) {
                                                                    lines[dataIndex] = '';
                                                                    setGridText(lines.join('\n'));
                                                                }
                                                            }}
                                                            className="absolute top-0 right-0 bg-red-500 text-white p-0.5 rounded-bl z-20 opacity-0 group-hover:opacity-100 pointer-events-auto transition"
                                                        >
                                                            <Icon name="x" size={12} />
                                                        </button>
                                                    )}
                                                </React.Fragment>
                                            ) : <span className="text-[10px] text-center leading-tight overflow-hidden break-words">{item?.text || (setupVariant === 'standard' && settings.population === 'sequential' ? (settings.middleFree && i > Math.floor(gridSize * gridSize / 2) ? i : i + 1) : '')}</span>}
                                        </div>
                                    ))}
                                </div>

                                {isRandomMode && (
                                    <div className="text-center text-xs text-earth/60 italic bg-white/50 p-2 rounded-lg border border-earth/5">
                                        Note: This is a preview. Items will be randomized in the actual game.
                                    </div>
                                )}

                                <div className="flex flex-col gap-2 max-w-[500px] mx-auto">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => triggerStart('solo')}
                                            disabled={stats.filledCount < stats.requiredItems}
                                            className={`flex-1 py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 ${stats.filledCount < stats.requiredItems ? 'bg-earth/10 text-earth/30 cursor-not-allowed' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'}`}
                                        >
                                            <Icon name="user" size={18} /> Play Solo
                                        </button>
                                        <button
                                            onClick={() => triggerStart('lobby')}
                                            disabled={stats.filledCount < stats.requiredItems}
                                            className={`flex-[2] py-4 rounded-xl font-bold transition flex items-center justify-center gap-2 ${stats.filledCount < stats.requiredItems ? 'bg-earth/20 text-earth/40 cursor-not-allowed' : 'bg-dullpurple text-white hover:bg-earth'}`}
                                        >
                                            <Icon name="users" size={18} /> Create Lobby
                                        </button>
                                    </div>
                                    <button
                                        onClick={generateShareLink}
                                        className={`w-full py-3 rounded-xl font-bold shadow-sm transition flex items-center justify-center gap-2 ${stats.filledCount < stats.requiredItems ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-white hover:bg-dullpurple hover:text-white border-2 border-earth/10'}`}
                                        disabled={stats.filledCount < stats.requiredItems}
                                    >
                                        <Icon name="link" size={16} /> Generate Shareable Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (view === 'waiting' || view === 'lobby') {
                return (
                    <div className="min-h-screen flex items-center justify-center fade-in p-4 relative">
                        {toast && <Toast {...toast} onClose={() => setToast(null)} />}
                        <button onClick={resetGame} className="absolute top-4 left-4 px-3 py-2 bg-white rounded-xl shadow hover:bg-earth/5 text-earth/60 hover:text-earth flex items-center gap-2 transition"><Icon name="plus-circle" size={18} /><span className="text-xs font-bold">NEW GAME</span></button>
                        <div className="bg-linen p-8 rounded-2xl shadow-sm w-full max-w-lg border-2 border-earth/10 text-center">
                            {view === 'waiting' ? (
                                <React.Fragment><div className="animate-spin text-dullpurple mb-4 mx-auto w-8 h-8"><Icon name="loader-2" size={32} /></div><h2 className="text-xl font-bold text-earth">Connecting...</h2></React.Fragment>
                            ) : (
                                <React.Fragment>
                                    <h2 className="text-2xl font-bold text-earth mb-4">Lobby</h2>
                                    <HostIDDisplay id={peerId} show={showId} onToggle={() => setShowId(!showId)} onCopy={() => copyToClipboard(peerId, () => showToast("Copied!"))} />
                                    <div className="my-8 space-y-2">
                                        <h3 className="text-xs font-bold uppercase opacity-50">Players ({players.length}/12)</h3>
                                        {players.map(p => (
                                            <div key={p.id} className="flex items-center gap-3 bg-white/80 p-3 rounded-lg">
                                                <div className="w-3 h-3 rounded-full border border-black/10" style={{ backgroundColor: PALETTE[p.colorIdx].hex }}></div>
                                                <span className="font-bold">{p.name}</span>
                                                {p.id === players[0].id && <Icon name="crown" size={14} className="text-yellow-600" />}
                                            </div>
                                        ))}
                                    </div>
                                    {isHost ? <button onClick={startGameForEveryone} className="w-full bg-success text-white py-4 rounded-xl font-bold hover:bg-earth">Start Game</button> : <p className="opacity-50 italic">Waiting for host...</p>}
                                </React.Fragment>
                            )}
                        </div>
                    </div>
                );
            }

            if (view === 'game') {
                return (
                    <div className="min-h-screen p-2 md:p-4 flex flex-col items-center fade-in pb-20 relative">
                        {toast && <Toast {...toast} onClose={() => setToast(null)} />}

                        {detailModal && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-fade-in">
                                <div className="bg-linen p-6 rounded-2xl w-full max-w-md shadow-xl animate-modal-in">
                                    <h3 className="font-bold mb-4">Add Detail</h3>
                                    <textarea className="w-full h-32 p-3 rounded-xl border border-earth/20 mb-4 focus:outline-none" placeholder="Enter details..." autoFocus defaultValue={detailModal.currentDetail} id="detailInput"></textarea>
                                    <div className="flex gap-2">
                                        <button onClick={() => setDetailModal(null)} className="flex-1 py-3 rounded-xl border border-earth/10 hover:bg-earth/5">Cancel</button>
                                        <button onClick={() => { handleCellClickLogic(detailModal.cellIndex, myPlayerId, document.getElementById('detailInput').value); setDetailModal(null); }} className="flex-1 py-3 rounded-xl bg-earth text-white font-bold">Save</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="w-full max-w-6xl flex justify-between items-center mb-6 gap-2 h-10">
                            <div className="flex items-center gap-2 h-full">
                                <button onClick={resetGame} className="h-10 px-3 flex items-center justify-center gap-1 bg-white rounded-xl hover:bg-dullpurple/10 text-earth/60 hover:text-dullpurple shadow-sm transition"><Icon name="plus-circle" size={18} /><span className="text-xs font-bold">NEW GAME</span></button>
                                <button onClick={saveGameState} className="h-10 w-10 flex items-center justify-center bg-white rounded-xl hover:bg-linen text-earth/40 hover:text-earth shadow-sm transition"><Icon name="save" size={18} /></button>
                                <button onClick={exportBoard} className="h-10 w-10 flex items-center justify-center bg-white rounded-xl hover:bg-linen text-earth/40 hover:text-earth shadow-sm transition"><Icon name="download" size={18} /></button>
                                {(isHost || isSolo) && (
                                    <React.Fragment>
                                        <button onClick={() => setTimerState(p => ({ ...p, isRunning: !p.isRunning, startTime: !p.isRunning ? Date.now() : null, accumulatedTime: p.isRunning ? p.accumulatedTime + (Date.now() - p.startTime) : p.accumulatedTime }))} className={`h-10 w-10 flex items-center justify-center rounded-xl text-white shadow-sm transition ${timerState.isRunning ? 'bg-dullpurple' : 'bg-earth'}`}><Icon name={timerState.isRunning ? "pause" : "play"} size={18} /></button>
                                        <button onClick={restartGame} className="h-10 w-10 flex items-center justify-center bg-mutedpink text-white rounded-xl shadow-sm transition"><Icon name="rotate-ccw" size={18} /></button>
                                    </React.Fragment>
                                )}
                                {showTimer && <div className="h-10 flex items-center justify-center font-mono text-xl font-bold text-earth bg-white/80 px-3 rounded-xl border border-earth/5 shadow-sm min-w-[80px]">{formatTime(elapsedTime)}</div>}
                            </div>
                            {!isSolo && <div className="hidden md:block w-48"><HostIDDisplay id={peerId} show={showId} onToggle={() => setShowId(!showId)} onCopy={() => copyToClipboard(peerId, () => showToast("Copied!"))} /></div>}
                        </div>

                        {/* Display Goal in Game View */}
                        {goal && (
                            <div className="w-full max-w-[80vh] mb-4 bg-white/60 p-3 rounded-xl border border-earth/5 text-center shadow-sm" style={{ width: '100%', maxWidth: '80vh' }}>
                                <span className="font-bold text-earth uppercase text-xs tracking-wider mr-2">Goal:</span>
                                <span className="font-serif text-dullpurple font-bold">{goal}</span>
                            </div>
                        )}

                        <div className="w-full max-w-6xl grid lg:grid-cols-[250px_1fr] gap-8">
                            <div className="space-y-4 order-2 lg:order-1">
                                <div className="bg-linen p-4 rounded-2xl border-2 border-earth/5">
                                    <h3 className="font-bold mb-4 opacity-50 uppercase text-xs">Players ({players.length}/12)</h3>
                                    <div className="space-y-2">
                                        {players.map(p => (
                                            <div key={p.id} className="flex justify-between items-center bg-white/60 p-2 px-3 rounded-lg">
                                                <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full" style={{ backgroundColor: PALETTE[p.colorIdx].hex }}></div><span className="text-sm font-bold truncate max-w-[100px]">{p.name}</span></div>
                                                <span className="font-mono font-bold opacity-50">{boardData.filter(c => c.markedBy.includes(p.id)).length}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="order-1 lg:order-2 flex flex-col items-center">
                                <div className="gap-1 md:gap-3 w-full aspect-square max-w-[80vh]" style={{ display: 'grid', gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))` }}>
                                    {boardData.map((cell, i) => {
                                        const visible = isCellVisible(i, boardData, settings, myPlayerId, gridSize);
                                        const myMark = cell.markedBy.includes(myPlayerId);
                                        const others = cell.markedBy.filter(id => id !== myPlayerId);
                                        const myDetail = cell.details && cell.details[myPlayerId];

                                        let border = 'border-earth/10', bg = 'bg-white', opacity = 'opacity-100', content = null;
                                        const isLocked = !isSolo && settings.mode === 'lockout' && cell.markedBy.length > 0;

                                        if (isLocked) {
                                            const owner = players.find(p => p.id === cell.markedBy[0]);
                                            if (owner) {
                                                const pal = PALETTE[owner.colorIdx];
                                                border = `${pal.class.split(' ')[0]} border-4`;
                                                bg = pal.class.split(' ')[1];
                                            }
                                        } else if (myMark) {
                                            const pal = PALETTE[players.find(p => p.id === myPlayerId).colorIdx];
                                            border = `${pal.class.split(' ')[0]} border-4`;
                                            bg = pal.class.split(' ')[1];
                                        } else if (!visible) {
                                            bg = 'bg-earth/5';
                                            border = 'border-transparent';
                                            opacity = 'opacity-50 cursor-not-allowed';
                                        }

                                        if (!visible) {
                                            content = <Icon name="lock" className="opacity-20" />;
                                        } else {
                                            if (cell.content.type === 'image') {
                                                content = <img src={cell.content.src} className={`w-full h-full object-contain ${isLocked ? 'opacity-50' : ''}`} />;
                                            } else if (cell.content.type === 'free') {
                                                content = <img src={cell.content.src} className="w-full h-full object-contain opacity-80" />;
                                                bg = 'bg-earth/5'; // Light background for free space
                                            } else {
                                                content = <span className="text-[10px] md:text-sm text-center font-bold leading-tight break-words">{cell.content.text}</span>;
                                            }
                                        }

                                        return (
                                            <div key={cell.id}
                                                onClick={() => {
                                                    if (!visible) return;
                                                    if (settings.interaction === 'detail') setDetailModal({ cellIndex: i, currentDetail: myDetail || '' });
                                                    else onCellClick(i);
                                                }}
                                                className={`relative rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer overflow-hidden shadow-sm cell-transition aspect-square ${bg} ${border} ${opacity}`}
                                            >
                                                <div className="flex-1 flex items-center justify-center w-full p-1 overflow-hidden relative z-10">
                                                    {content}
                                                </div>

                                                {visible && Object.keys(cell.details || {}).length > 0 && (
                                                    <div className="w-full text-[8px] text-center bg-white/50 py-0.5 truncate px-1 relative z-10">
                                                        {settings.mode === 'lockout' ? Object.values(cell.details)[0] : (myDetail || Object.values(cell.details)[0])}
                                                    </div>
                                                )}

                                                {settings.mode === 'standard' && others.length > 0 && (
                                                    <div className="absolute top-1 right-1 flex -space-x-1 z-20">
                                                        {others.map(oid => {
                                                            const p = players.find(pl => pl.id === oid);
                                                            return p ? <div key={oid} className="w-2 h-2 rounded-full border border-white" style={{ backgroundColor: PALETTE[p.colorIdx].hex }} title={p.name}></div> : null;
                                                        })}
                                                    </div>
                                                )}

                                                {isLocked && !visible && (
                                                    <div className="absolute top-1 right-1 z-20">
                                                        <div className="w-3 h-3 rounded-full border border-white bg-current" style={{ color: PALETTE[players.find(p => p.id === cell.markedBy[0])?.colorIdx]?.hex }}></div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>